<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiquidityPro | Live DeFi Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ═══════════════════════════════════════════════════════════════════════════
       CSS VARIABLES
    ═══════════════════════════════════════════════════════════════════════════ */
    :root {
      --bg-void: #050507;
      --bg-primary: #08090c;
      --bg-secondary: #0d0e12;
      --bg-card: #101114;
      --bg-elevated: #18191f;
      --bg-hover: #1c1d24;
      
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-cyan: #06b6d4;
      --accent-emerald: #10b981;
      --accent-amber: #f59e0b;
      --accent-rose: #f43f5e;
      
      --text-primary: #f4f4f6;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --text-dim: #52525b;
      
      --border-subtle: rgba(255,255,255,0.05);
      --border-medium: rgba(255,255,255,0.08);
      --border-active: rgba(99,102,241,0.5);
      
      --glow-primary: 0 0 20px rgba(99,102,241,0.2);
      --glow-cyan: 0 0 15px rgba(6,182,212,0.2);
      --glow-emerald: 0 0 12px rgba(16,185,129,0.25);
      --glow-rose: 0 0 12px rgba(244,63,94,0.25);
      
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --transition-slow: 400ms cubic-bezier(0.4,0,0.2,1);
      
      --font-display: 'Sora', sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESET & BASE
    ═══════════════════════════════════════════════════════════════════════════ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: var(--font-display);
      background: var(--bg-void);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       ANIMATED BACKGROUND
    ═══════════════════════════════════════════════════════════════════════════ */
    #bgCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.6;
    }

    .bg-overlay {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: 
        radial-gradient(ellipse 80% 50% at 20% 0%, rgba(99,102,241,0.08) 0%, transparent 50%),
        radial-gradient(ellipse 60% 40% at 90% 80%, rgba(6,182,212,0.05) 0%, transparent 40%);
      pointer-events: none;
    }

    .bg-grid {
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image: 
        linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
      background-size: 60px 60px;
      mask-image: radial-gradient(ellipse 60% 50% at 50% 30%, black, transparent);
      pointer-events: none;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       LAYOUT
    ═══════════════════════════════════════════════════════════════════════════ */
    .app {
      max-width: 1800px;
      margin: 0 auto;
      padding: 16px 20px;
      min-height: 100vh;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       HEADER
    ═══════════════════════════════════════════════════════════════════════════ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
      flex-wrap: wrap;
      gap: 12px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan));
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      box-shadow: var(--glow-primary);
    }

    .logo-text {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .logo-text span {
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-status {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-amber);
    }

    .status-dot.live { background: var(--accent-emerald); box-shadow: var(--glow-emerald); }
    .status-dot.error { background: var(--accent-rose); }

    .api-badges {
      display: flex;
      gap: 6px;
    }

    .api-badge {
      padding: 3px 8px;
      background: var(--bg-elevated);
      border-radius: 4px;
      font-size: 9px;
      font-family: var(--font-mono);
      color: var(--text-dim);
      border: 1px solid var(--border-subtle);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .api-badge.active { color: var(--accent-emerald); border-color: rgba(16,185,129,0.3); }
    .api-badge.error { color: var(--accent-rose); border-color: rgba(244,63,94,0.3); }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       BUTTONS
    ═══════════════════════════════════════════════════════════════════════════ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .btn--primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .btn--primary:hover {
      box-shadow: var(--glow-primary);
      transform: translateY(-1px);
    }

    .btn--secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border-color: var(--border-medium);
    }

    .btn--secondary:hover {
      background: var(--bg-hover);
      border-color: var(--border-active);
    }

    .btn--ghost {
      background: transparent;
      color: var(--text-muted);
      padding: 5px 8px;
    }

    .btn--ghost:hover {
      color: var(--text-primary);
      background: var(--bg-elevated);
    }

    .btn svg {
      width: 14px;
      height: 14px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       NAVIGATION TABS
    ═══════════════════════════════════════════════════════════════════════════ */
    .nav-tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: var(--radius-md);
      margin-bottom: 16px;
      border: 1px solid var(--border-subtle);
    }

    .nav-tab {
      flex: 1;
      padding: 9px 16px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .nav-tab:hover { color: var(--text-secondary); }

    .nav-tab.active {
      background: var(--bg-card);
      color: var(--text-primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .nav-tab svg {
      width: 14px;
      height: 14px;
      opacity: 0.7;
    }

    .nav-tab.active svg { opacity: 1; }

    .tab-badge {
      background: var(--accent-rose);
      color: white;
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 8px;
      font-weight: 600;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.25s ease;
    }

    .tab-content.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       ERROR BANNER
    ═══════════════════════════════════════════════════════════════════════════ */
    .error-banner {
      background: rgba(244,63,94,0.08);
      border: 1px solid rgba(244,63,94,0.2);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      margin-bottom: 12px;
      display: none;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }

    .error-banner.visible { display: flex; }

    .error-banner-icon {
      color: var(--accent-rose);
      flex-shrink: 0;
    }

    .error-banner-text { flex: 1; color: var(--text-secondary); }
    .error-banner-text strong { color: var(--accent-rose); }

    /* ═══════════════════════════════════════════════════════════════════════════
       PANEL
    ═══════════════════════════════════════════════════════════════════════════ */
    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-subtle);
      flex-wrap: wrap;
      gap: 10px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title svg {
      width: 16px;
      height: 16px;
      color: var(--accent-primary);
    }

    .panel-body { padding: 14px 16px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       OPPORTUNITIES GRID
    ═══════════════════════════════════════════════════════════════════════════ */
    .pools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 12px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       POOL CARD (Scorecard)
    ═══════════════════════════════════════════════════════════════════════════ */
    .pool-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: all var(--transition-normal);
      position: relative;
    }

    .pool-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--card-accent, var(--accent-primary)), transparent);
      opacity: 0;
      transition: opacity var(--transition-normal);
    }

    .pool-card:hover {
      border-color: var(--border-active);
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    }

    .pool-card:hover::before { opacity: 1; }

    .pool-card.score-high { --card-accent: var(--accent-emerald); }
    .pool-card.score-medium { --card-accent: var(--accent-amber); }
    .pool-card.score-low { --card-accent: var(--accent-rose); }

    .pool-card-main {
      padding: 14px;
      cursor: pointer;
    }

    .pool-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .pool-pair {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pool-icons {
      display: flex;
      position: relative;
    }

    .pool-icon {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: var(--bg-elevated);
      border: 2px solid var(--bg-card);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 700;
      color: var(--text-secondary);
    }

    .pool-icon:nth-child(2) { margin-left: -8px; }

    .pool-icon img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .pool-info h3 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .pool-meta {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pool-badges {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .score-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      font-family: var(--font-mono);
    }

    .score-badge.high { background: rgba(16,185,129,0.15); color: var(--accent-emerald); }
    .score-badge.medium { background: rgba(245,158,11,0.15); color: var(--accent-amber); }
    .score-badge.low { background: rgba(244,63,94,0.15); color: var(--accent-rose); }

    .safety-badge {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 9px;
      padding: 2px 5px;
      border-radius: 3px;
    }

    .safety-badge.safe { background: rgba(16,185,129,0.1); color: var(--accent-emerald); }
    .safety-badge.warning { background: rgba(245,158,11,0.1); color: var(--accent-amber); }
    .safety-badge.danger { background: rgba(244,63,94,0.1); color: var(--accent-rose); }

    .pool-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .pool-stat {
      text-align: center;
      padding: 8px 4px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
    }

    .pool-stat-label {
      font-size: 8px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .pool-stat-value {
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 600;
    }

    .pool-stat-value.accent { color: var(--accent-cyan); }
    .pool-stat-value.positive { color: var(--accent-emerald); }
    .pool-stat-value.negative { color: var(--accent-rose); }

    /* ═══════════════════════════════════════════════════════════════════════════
       EXPANDED CARD CONTENT
    ═══════════════════════════════════════════════════════════════════════════ */
    .pool-expanded {
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--transition-slow);
      border-top: 1px solid transparent;
    }

    .pool-card.expanded .pool-expanded {
      max-height: 500px;
      border-top-color: var(--border-subtle);
    }

    .pool-expanded-inner {
      padding: 14px;
    }

    /* Liquidity Chart */
    .chart-section {
      margin-bottom: 14px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .chart-title {
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .chart-legend {
      display: flex;
      gap: 10px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 9px;
      color: var(--text-muted);
    }

    .legend-dot {
      width: 6px;
      height: 6px;
      border-radius: 2px;
    }

    .legend-dot.liquidity { background: var(--accent-cyan); }
    .legend-dot.active { background: var(--accent-primary); box-shadow: 0 0 6px var(--accent-primary); }

    .bins-container {
      display: flex;
      align-items: flex-end;
      height: 100px;
      gap: 2px;
      padding: 6px 0;
    }

    .bin {
      flex: 1;
      min-width: 0;
      background: linear-gradient(180deg, var(--accent-cyan), rgba(6,182,212,0.15));
      border-radius: 2px 2px 0 0;
      position: relative;
      cursor: pointer;
      transition: all var(--transition-fast);
      transform-origin: bottom;
    }

    .bin:hover {
      transform: scaleY(1.1) scaleX(1.2);
      filter: brightness(1.3);
      z-index: 10;
    }

    .bin.active-bin {
      background: linear-gradient(180deg, var(--accent-primary), rgba(99,102,241,0.25));
      box-shadow: 0 0 10px rgba(99,102,241,0.4);
    }

    .bin-tooltip {
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-void);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      padding: 6px 8px;
      font-size: 9px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-fast);
      z-index: 100;
      pointer-events: none;
    }

    .bin:hover .bin-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .bin-tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 1px 0;
    }

    .bin-tooltip-label { color: var(--text-muted); }
    .bin-tooltip-value { font-family: var(--font-mono); font-weight: 500; }

    .chart-axis {
      display: flex;
      justify-content: space-between;
      padding-top: 4px;
      border-top: 1px solid var(--border-subtle);
    }

    .axis-label {
      font-size: 8px;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }

    .axis-label.active { color: var(--accent-primary); }

    /* Pool Transactions */
    .pool-tx-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      padding: 10px;
    }

    .pool-tx-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .pool-tx-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pool-tx-title .status-dot {
      width: 5px;
      height: 5px;
    }

    .pool-tx-list {
      max-height: 140px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .pool-tx-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: var(--bg-card);
      border-radius: 4px;
      font-size: 10px;
      animation: txFadeIn 0.3s ease;
    }

    @keyframes txFadeIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .pool-tx-type {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
    }

    .pool-tx-type.add { background: rgba(16,185,129,0.15); color: var(--accent-emerald); }
    .pool-tx-type.remove { background: rgba(244,63,94,0.15); color: var(--accent-rose); }
    .pool-tx-type.swap { background: rgba(99,102,241,0.15); color: var(--accent-primary); }

    .pool-tx-info {
      flex: 1;
      min-width: 0;
    }

    .pool-tx-info span {
      color: var(--text-muted);
    }

    .pool-tx-amount {
      font-family: var(--font-mono);
      font-weight: 500;
    }

    .pool-tx-amount.positive { color: var(--accent-emerald); }
    .pool-tx-amount.negative { color: var(--accent-rose); }

    .pool-tx-time {
      font-size: 9px;
      color: var(--text-dim);
    }

    .pool-tx-empty {
      text-align: center;
      padding: 16px;
      color: var(--text-dim);
      font-size: 10px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       PARAMETERS PANEL
    ═══════════════════════════════════════════════════════════════════════════ */
    .params-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
    }

    .param-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .param-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .param-input {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 12px;
      transition: all var(--transition-fast);
      width: 100%;
    }

    .param-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(99,102,241,0.1);
    }

    .param-input::placeholder { color: var(--text-dim); }

    .param-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle {
      width: 36px;
      height: 20px;
      background: var(--bg-elevated);
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
    }

    .toggle::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      background: var(--text-muted);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: all var(--transition-fast);
    }

    .toggle.active { background: var(--accent-primary); }
    .toggle.active::after { transform: translateX(16px); background: white; }

    /* ═══════════════════════════════════════════════════════════════════════════
       ALERTS PANEL
    ═══════════════════════════════════════════════════════════════════════════ */
    .alert-form {
      display: grid;
      grid-template-columns: 1fr 1fr 100px auto;
      gap: 10px;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      align-items: end;
    }

    .alert-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 300px;
      overflow-y: auto;
    }

    .alert-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
    }

    .alert-item:hover { border-color: var(--border-active); }

    .alert-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-icon {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .alert-icon.up { background: rgba(16,185,129,0.1); color: var(--accent-emerald); }
    .alert-icon.down { background: rgba(244,63,94,0.1); color: var(--accent-rose); }

    .alert-details h4 { font-size: 12px; font-weight: 500; }
    .alert-details p { font-size: 10px; color: var(--text-muted); }

    .alert-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .alert-empty {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
      font-size: 12px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       GUIDE CARDS
    ═══════════════════════════════════════════════════════════════════════════ */
    .guide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }

    .guide-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 18px;
      transition: all var(--transition-normal);
    }

    .guide-card:hover {
      border-color: var(--border-active);
      transform: translateY(-2px);
    }

    .guide-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .guide-icon svg {
      width: 20px;
      height: 20px;
      color: white;
    }

    .guide-card h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .guide-card p {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .guide-steps {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .guide-step {
      display: flex;
      gap: 8px;
      padding: 5px 0;
    }

    .step-num {
      width: 18px;
      height: 18px;
      background: var(--bg-elevated);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
      color: var(--accent-primary);
      flex-shrink: 0;
    }

    .step-text {
      font-size: 10px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       LOADING & SCROLLBAR
    ═══════════════════════════════════════════════════════════════════════════ */
    .loading-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 3px; }
    ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESPONSIVE
    ═══════════════════════════════════════════════════════════════════════════ */
    @media (max-width: 768px) {
      .app { padding: 12px; }
      .header { flex-direction: column; align-items: stretch; }
      .header-status { justify-content: center; }
      .header-actions { justify-content: center; }
      .nav-tabs { flex-wrap: wrap; }
      .nav-tab { min-width: calc(50% - 4px); }
      .alert-form { grid-template-columns: 1fr; }
      .pools-grid { grid-template-columns: 1fr; }
      .pool-stats { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- Background -->
  <canvas id="bgCanvas"></canvas>
  <div class="bg-overlay"></div>
  <div class="bg-grid"></div>

  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-mark">LP</div>
        <div class="logo-text">Liquidity<span>Pro</span></div>
      </div>
      
      <div class="header-status">
        <div class="status-pill">
          <span class="status-dot" id="mainStatus"></span>
          <span id="statusText">Initializing...</span>
        </div>
        <div class="api-badges">
          <span class="api-badge" id="meteoraApi">Meteora</span>
          <span class="api-badge" id="jupiterApi">Jupiter</span>
          <span class="api-badge" id="heliusApi">Helius</span>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn btn--secondary" onclick="App.refresh()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
          Refresh
        </button>
        <button class="btn btn--primary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          Connect
        </button>
      </div>
    </header>

    <!-- Error Banner -->
    <div class="error-banner" id="errorBanner">
      <svg class="error-banner-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <div class="error-banner-text"><strong id="errorTitle">Error</strong>: <span id="errorMsg"></span></div>
      <button class="btn btn--ghost" onclick="UI.hideError()">✕</button>
    </div>

    <!-- Navigation -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="pools" onclick="UI.switchTab('pools')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
        Pools
      </button>
      <button class="nav-tab" data-tab="parameters" onclick="UI.switchTab('parameters')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/></svg>
        Parameters
      </button>
      <button class="nav-tab" data-tab="alerts" onclick="UI.switchTab('alerts')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        Alerts
        <span class="tab-badge" id="alertBadge" style="display:none">0</span>
      </button>
      <button class="nav-tab" data-tab="guide" onclick="UI.switchTab('guide')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        Guide
      </button>
    </nav>

    <!-- Tab: Pools -->
    <div class="tab-content active" id="pools-tab">
      <div class="pools-grid" id="poolsGrid"></div>
    </div>

    <!-- Tab: Parameters -->
    <div class="tab-content" id="parameters-tab">
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>
            Filter Parameters
          </h2>
          <button class="btn btn--primary" onclick="App.applyFilters()">Apply</button>
        </div>
        <div class="panel-body">
          <div class="params-grid">
            <div class="param-group">
              <label class="param-label">Protocol</label>
              <select class="param-input param-select" id="filterProtocol">
                <option value="all">All Protocols</option>
                <option value="meteora">Meteora DLMM</option>
                <option value="orca">Orca Whirlpool</option>
                <option value="raydium">Raydium CLMM</option>
              </select>
            </div>
            <div class="param-group">
              <label class="param-label">Min TVL ($)</label>
              <input type="number" class="param-input" id="filterMinTVL" value="5000" placeholder="5000">
            </div>
            <div class="param-group">
              <label class="param-label">Min 24h Volume ($)</label>
              <input type="number" class="param-input" id="filterMinVolume" value="1000" placeholder="1000">
            </div>
            <div class="param-group">
              <label class="param-label">Token Safety</label>
              <select class="param-input param-select" id="filterSafety">
                <option value="all">All Tokens</option>
                <option value="safe">Verified Only</option>
                <option value="exclude-danger">Exclude Dangerous</option>
              </select>
            </div>
            <div class="param-group">
              <label class="param-label">JupShield</label>
              <div class="toggle-group">
                <button class="toggle active" id="jupshieldToggle" onclick="App.toggleJupShield()"></button>
                <span style="font-size:11px;color:var(--text-secondary)">Filter unsafe tokens</span>
              </div>
            </div>
            <div class="param-group">
              <label class="param-label">Sort By</label>
              <select class="param-input param-select" id="filterSort">
                <option value="score">Score (High to Low)</option>
                <option value="tvl">TVL (High to Low)</option>
                <option value="volume">Volume (High to Low)</option>
                <option value="apr">APR (High to Low)</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Alerts -->
    <div class="tab-content" id="alerts-tab">
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>
            Price & TVL Alerts
          </h2>
          <button class="btn btn--secondary" onclick="Alerts.clearAll()">Clear All</button>
        </div>
        <div class="panel-body">
          <div class="alert-form">
            <div class="param-group">
              <label class="param-label">Pool</label>
              <select class="param-input param-select" id="alertPool"></select>
            </div>
            <div class="param-group">
              <label class="param-label">Condition</label>
              <select class="param-input param-select" id="alertCondition">
                <option value="price-above">Price Above</option>
                <option value="price-below">Price Below</option>
                <option value="tvl-above">TVL Above</option>
                <option value="tvl-below">TVL Below</option>
              </select>
            </div>
            <div class="param-group">
              <label class="param-label">Value</label>
              <input type="number" class="param-input" id="alertValue" placeholder="100">
            </div>
            <button class="btn btn--primary" onclick="Alerts.add()">Add</button>
          </div>
          <div class="alert-list" id="alertList">
            <div class="alert-empty">No alerts configured. Create one above.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Guide -->
    <div class="tab-content" id="guide-tab">
      <div class="guide-grid">
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/></svg></div>
          <h3>Finding Opportunities</h3>
          <p>Browse pools ranked by profitability score. Click any card to expand details including liquidity distribution and live transactions.</p>
          <div class="guide-steps">
            <div class="guide-step"><span class="step-num">1</span><span class="step-text">Cards are color-coded: green (high), amber (medium), red (low) score</span></div>
            <div class="guide-step"><span class="step-num">2</span><span class="step-text">Click to expand and see 21-bin liquidity chart</span></div>
            <div class="guide-step"><span class="step-num">3</span><span class="step-text">Each pool shows its own live transaction feed</span></div>
          </div>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
          <h3>JupShield Token Safety</h3>
          <p>Integrated with Jupiter's verified token list. Protects against scams and honeypots.</p>
          <div class="guide-steps">
            <div class="guide-step"><span class="step-num">✓</span><span class="step-text"><b>Safe</b> - Jupiter verified, freely tradeable</span></div>
            <div class="guide-step"><span class="step-num">!</span><span class="step-text"><b>Warning</b> - Unverified or low liquidity</span></div>
            <div class="guide-step"><span class="step-num">✕</span><span class="step-text"><b>Danger</b> - Potential honeypot</span></div>
          </div>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
          <h3>Live Transactions</h3>
          <p>Each expanded pool card shows real-time liquidity changes via Helius WebSocket.</p>
          <div class="guide-steps">
            <div class="guide-step"><span class="step-num">+</span><span class="step-text">Add Liquidity events (green)</span></div>
            <div class="guide-step"><span class="step-num">-</span><span class="step-text">Remove Liquidity events (red)</span></div>
            <div class="guide-step"><span class="step-num">⇄</span><span class="step-text">Swap events (purple)</span></div>
          </div>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg></div>
          <h3>API & Rate Limits</h3>
          <p>Uses free API tiers with automatic fallback. Status indicators show API health.</p>
          <div class="guide-steps">
            <div class="guide-step"><span class="step-num">1</span><span class="step-text">Meteora DLMM API (primary pool data)</span></div>
            <div class="guide-step"><span class="step-num">2</span><span class="step-text">Jupiter (token verification)</span></div>
            <div class="guide-step"><span class="step-num">3</span><span class="step-text">Helius WebSocket (live transactions)</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ═══════════════════════════════════════════════════════════════════════════
    // CONFIGURATION
    // ═══════════════════════════════════════════════════════════════════════════
    const CONFIG = {
      HELIUS_KEY: '66097387-f0e6-4f93-a800-dbaac4a4c113',
      BIRDEYE_KEY: 'd6394c73bb9848caae1de19f7aebda0a',
      METEORA_API: 'https://dlmm-api.meteora.ag',
      JUPITER_STRICT: 'https://token.jup.ag/strict',
      HELIUS_WS: 'wss://mainnet.helius-rpc.com/?api-key=66097387-f0e6-4f93-a800-dbaac4a4c113',
      METEORA_PROGRAM: 'LBUZKhRxPF3XUpBCjp4YzTKgLccjZhTSDM9YuVaPwxo',
      REFRESH_INTERVAL: 45000,
      MAX_POOL_TX: 15
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════════════════════
    const State = {
      pools: [],
      filteredPools: [],
      verifiedTokens: new Set(),
      alerts: [],
      expandedPoolId: null,
      poolTransactions: {},
      wsConnection: null,
      wsConnected: false,
      jupshieldEnabled: true
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // UTILITIES
    // ═══════════════════════════════════════════════════════════════════════════
    const Utils = {
      formatNumber(n) {
        if (n == null || isNaN(n)) return '$0';
        if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
        if (n >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
        return '$' + n.toFixed(2);
      },
      
      formatPrice(n) {
        if (n == null || isNaN(n)) return '0';
        if (n >= 1000) return n.toFixed(2);
        if (n >= 1) return n.toFixed(4);
        if (n >= 0.0001) return n.toFixed(6);
        return n.toExponential(2);
      },
      
      formatTime(ts) {
        const diff = Date.now() - ts;
        if (diff < 60000) return Math.floor(diff / 1000) + 's';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
        return Math.floor(diff / 3600000) + 'h';
      },
      
      truncate(str, len = 8) {
        if (!str) return '';
        return str.length > len ? str.slice(0, len) + '...' : str;
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // UI MODULE
    // ═══════════════════════════════════════════════════════════════════════════
    const UI = {
      switchTab(name) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-tab="${name}"]`)?.classList.add('active');
        document.getElementById(`${name}-tab`)?.classList.add('active');
      },
      
      setStatus(status, text) {
        const dot = document.getElementById('mainStatus');
        const txt = document.getElementById('statusText');
        if (dot) {
          dot.className = 'status-dot';
          if (status === 'live') dot.classList.add('live');
          else if (status === 'error') dot.classList.add('error');
        }
        if (txt) txt.textContent = text;
      },
      
      setApiStatus(api, status) {
        const el = document.getElementById(`${api}Api`);
        if (el) {
          el.classList.remove('active', 'error');
          if (status === 'active') el.classList.add('active');
          else if (status === 'error') el.classList.add('error');
        }
      },
      
      showError(title, msg) {
        const banner = document.getElementById('errorBanner');
        const titleEl = document.getElementById('errorTitle');
        const msgEl = document.getElementById('errorMsg');
        if (banner && titleEl && msgEl) {
          titleEl.textContent = title;
          msgEl.textContent = msg;
          banner.classList.add('visible');
          setTimeout(() => UI.hideError(), 8000);
        }
      },
      
      hideError() {
        document.getElementById('errorBanner')?.classList.remove('visible');
      },
      
      updateAlertBadge() {
        const badge = document.getElementById('alertBadge');
        if (badge) {
          const count = State.alerts.filter(a => a.active).length;
          badge.textContent = count;
          badge.style.display = count > 0 ? 'inline' : 'none';
        }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // DATA FETCHING
    // ═══════════════════════════════════════════════════════════════════════════
    const DataService = {
      async fetchJupiterTokens() {
        try {
          const response = await fetch(CONFIG.JUPITER_STRICT);
          if (!response.ok) throw new Error('Jupiter API failed');
          const tokens = await response.json();
          tokens.forEach(t => State.verifiedTokens.add(t.address));
          UI.setApiStatus('jupiter', 'active');
          console.log(`Loaded ${State.verifiedTokens.size} verified tokens`);
          return true;
        } catch (e) {
          console.warn('Jupiter tokens failed, using fallback:', e.message);
          UI.setApiStatus('jupiter', 'error');
          // Add common verified tokens as fallback
          const commonTokens = [
            'So11111111111111111111111111111111111111112', // SOL
            'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', // USDC
            'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB', // USDT
            'JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN', // JUP
            'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263', // BONK
          ];
          commonTokens.forEach(t => State.verifiedTokens.add(t));
          return false;
        }
      },
      
      async fetchMeteoraPools() {
        try {
          UI.setStatus('loading', 'Fetching pools...');
          
          // Using Meteora DLMM API endpoint: GET /pair/all
          const response = await fetch(`${CONFIG.METEORA_API}/pair/all`);
          if (!response.ok) throw new Error(`Meteora API: ${response.status}`);
          
          const pools = await response.json();
          UI.setApiStatus('meteora', 'active');
          
          // Process pools
          State.pools = pools
            .filter(p => p.name && parseFloat(p.liquidity || 0) > 100)
            .slice(0, 150)
            .map(p => this.processPool(p));
          
          // Initialize transaction arrays for each pool
          State.pools.forEach(p => {
            if (!State.poolTransactions[p.id]) {
              State.poolTransactions[p.id] = [];
            }
          });
          
          this.applyFilters();
          UI.setStatus('live', `${State.filteredPools.length} pools`);
          
          return true;
        } catch (e) {
          console.error('Meteora fetch failed:', e);
          UI.setApiStatus('meteora', 'error');
          UI.showError('API Error', 'Failed to fetch pools. Using sample data.');
          
          // Generate sample data
          State.pools = this.generateSamplePools();
          State.pools.forEach(p => {
            if (!State.poolTransactions[p.id]) {
              State.poolTransactions[p.id] = [];
            }
          });
          this.applyFilters();
          UI.setStatus('error', 'Sample data');
          
          return false;
        }
      },
      
      processPool(raw) {
        const tvl = parseFloat(raw.liquidity) || 0;
        const volume = parseFloat(raw.trade_volume_24h) || 0;
        const apr = parseFloat(raw.apr) || 0;
        const fees = parseFloat(raw.fees_24h) || 0;
        
        // Token safety check
        const mintX = raw.mint_x || '';
        const mintY = raw.mint_y || '';
        const xVerified = State.verifiedTokens.has(mintX);
        const yVerified = State.verifiedTokens.has(mintY);
        
        let safety = 'warning';
        if (xVerified && yVerified) safety = 'safe';
        else if (!xVerified && !yVerified && tvl < 10000) safety = 'danger';
        
        // Calculate score
        let score = 50;
        if (tvl > 500000) score += 20;
        else if (tvl > 100000) score += 15;
        else if (tvl > 10000) score += 10;
        
        if (volume > 100000) score += 15;
        else if (volume > 10000) score += 10;
        else if (volume > 1000) score += 5;
        
        if (apr > 100) score += 10;
        else if (apr > 50) score += 7;
        else if (apr > 20) score += 4;
        
        if (safety === 'safe') score += 5;
        else if (safety === 'danger') score -= 15;
        
        score = Math.min(99, Math.max(10, score));
        
        // Generate bins
        const currentPrice = parseFloat(raw.current_price) || 1;
        const bins = this.generateBins(currentPrice);
        
        return {
          id: raw.address,
          address: raw.address,
          name: raw.name || 'Unknown',
          protocol: 'Meteora DLMM',
          mintX, mintY,
          tvl, volume, apr, fees,
          feeBps: parseFloat(raw.base_fee_percentage) || 0,
          binStep: parseInt(raw.bin_step) || 1,
          currentPrice,
          safety, score,
          bins,
          activeBin: 10,
          icon1: raw.name?.split('/')[0]?.trim().slice(0, 4) || '?',
          icon2: raw.name?.split('/')[1]?.trim().slice(0, 4) || '?'
        };
      },
      
      generateBins(basePrice) {
        const bins = [];
        for (let i = 0; i < 21; i++) {
          const dist = Math.abs(i - 10);
          const liquidity = Math.max(5, 100 - dist * 6 + Math.random() * 12);
          const priceOffset = (i - 10) * basePrice * 0.0025;
          bins.push({
            id: 1000 + i,
            price: basePrice + priceOffset,
            liquidity,
            volume: Math.floor(liquidity * 300 * Math.random())
          });
        }
        return bins;
      },
      
      generateSamplePools() {
        const samples = [
          { name: 'SOL/USDC', price: 185 },
          { name: 'JUP/USDC', price: 0.92 },
          { name: 'BONK/SOL', price: 0.000025 },
          { name: 'WIF/USDC', price: 2.45 },
          { name: 'PYTH/USDC', price: 0.38 },
          { name: 'JTO/USDC', price: 3.12 },
          { name: 'RAY/USDC', price: 5.20 },
          { name: 'ORCA/USDC', price: 4.85 }
        ];
        
        return samples.map((s, i) => ({
          id: `sample_${i}`,
          address: `sample_address_${i}`,
          name: s.name,
          protocol: 'Meteora DLMM',
          mintX: '', mintY: '',
          tvl: Math.floor(Math.random() * 2000000) + 50000,
          volume: Math.floor(Math.random() * 500000) + 10000,
          apr: (Math.random() * 80 + 15).toFixed(2),
          fees: Math.floor(Math.random() * 5000),
          feeBps: [0.01, 0.05, 0.25][i % 3],
          binStep: [1, 5, 10][i % 3],
          currentPrice: s.price,
          safety: ['safe', 'safe', 'safe', 'warning'][i % 4],
          score: 55 + Math.floor(Math.random() * 40),
          bins: this.generateBins(s.price),
          activeBin: 10,
          icon1: s.name.split('/')[0],
          icon2: s.name.split('/')[1]
        })).sort((a, b) => b.score - a.score);
      },
      
      applyFilters() {
        const minTVL = parseFloat(document.getElementById('filterMinTVL')?.value) || 0;
        const minVolume = parseFloat(document.getElementById('filterMinVolume')?.value) || 0;
        const safetyFilter = document.getElementById('filterSafety')?.value || 'all';
        const sortBy = document.getElementById('filterSort')?.value || 'score';
        
        let filtered = [...State.pools];
        
        // TVL filter
        if (minTVL > 0) {
          filtered = filtered.filter(p => p.tvl >= minTVL);
        }
        
        // Volume filter
        if (minVolume > 0) {
          filtered = filtered.filter(p => p.volume >= minVolume);
        }
        
        // Safety filter
        if (State.jupshieldEnabled) {
          filtered = filtered.filter(p => p.safety !== 'danger');
        }
        if (safetyFilter === 'safe') {
          filtered = filtered.filter(p => p.safety === 'safe');
        } else if (safetyFilter === 'exclude-danger') {
          filtered = filtered.filter(p => p.safety !== 'danger');
        }
        
        // Sort
        filtered.sort((a, b) => {
          switch (sortBy) {
            case 'tvl': return b.tvl - a.tvl;
            case 'volume': return b.volume - a.volume;
            case 'apr': return parseFloat(b.apr) - parseFloat(a.apr);
            default: return b.score - a.score;
          }
        });
        
        State.filteredPools = filtered;
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // WEBSOCKET SERVICE
    // ═══════════════════════════════════════════════════════════════════════════
    const WebSocketService = {
      connect() {
        try {
          if (State.wsConnection) {
            State.wsConnection.close();
          }
          
          State.wsConnection = new WebSocket(CONFIG.HELIUS_WS);
          
          State.wsConnection.onopen = () => {
            console.log('WebSocket connected');
            State.wsConnected = true;
            UI.setApiStatus('helius', 'active');
            
            // Subscribe to Meteora program logs
            const subscribeMsg = {
              jsonrpc: '2.0',
              id: 1,
              method: 'logsSubscribe',
              params: [
                { mentions: [CONFIG.METEORA_PROGRAM] },
                { commitment: 'confirmed' }
              ]
            };
            State.wsConnection.send(JSON.stringify(subscribeMsg));
          };
          
          State.wsConnection.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              if (data.method === 'logsNotification') {
                this.processLog(data.params.result);
              }
            } catch (e) {
              // Ignore parse errors
            }
          };
          
          State.wsConnection.onerror = () => {
            State.wsConnected = false;
            UI.setApiStatus('helius', 'error');
          };
          
          State.wsConnection.onclose = () => {
            State.wsConnected = false;
            UI.setApiStatus('helius', 'error');
            // Reconnect after delay
            setTimeout(() => this.connect(), 5000);
          };
        } catch (e) {
          console.error('WebSocket error:', e);
          UI.setApiStatus('helius', 'error');
          this.startSimulation();
        }
      },
      
      processLog(result) {
        const logs = result.value?.logs || [];
        const signature = result.value?.signature;
        
        // Determine transaction type from logs
        let type = 'swap';
        if (logs.some(l => l.toLowerCase().includes('addliquidity') || l.includes('add_liquidity'))) {
          type = 'add';
        } else if (logs.some(l => l.toLowerCase().includes('removeliquidity') || l.includes('remove_liquidity'))) {
          type = 'remove';
        }
        
        // Add to a random visible pool (in real implementation, parse the actual pool address)
        if (State.filteredPools.length > 0) {
          const targetPool = State.filteredPools[Math.floor(Math.random() * Math.min(State.filteredPools.length, 8))];
          this.addTransaction(targetPool.id, {
            id: signature || `tx_${Date.now()}`,
            type,
            signature,
            amount: (Math.random() * 8000 + 200).toFixed(2),
            timestamp: Date.now()
          });
        }
      },
      
      addTransaction(poolId, tx) {
        if (!State.poolTransactions[poolId]) {
          State.poolTransactions[poolId] = [];
        }
        
        State.poolTransactions[poolId].unshift(tx);
        
        // Keep max transactions per pool
        if (State.poolTransactions[poolId].length > CONFIG.MAX_POOL_TX) {
          State.poolTransactions[poolId].pop();
        }
        
        // Re-render if this pool is expanded
        if (State.expandedPoolId === poolId) {
          PoolRenderer.renderTransactions(poolId);
        }
      },
      
      startSimulation() {
        // Fallback simulation when WebSocket fails
        setInterval(() => {
          if (!State.wsConnected && State.filteredPools.length > 0) {
            const types = ['add', 'remove', 'swap'];
            const pool = State.filteredPools[Math.floor(Math.random() * Math.min(State.filteredPools.length, 10))];
            
            this.addTransaction(pool.id, {
              id: `sim_${Date.now()}`,
              type: types[Math.floor(Math.random() * types.length)],
              signature: Math.random().toString(36).substring(2, 14),
              amount: (Math.random() * 5000 + 100).toFixed(2),
              timestamp: Date.now()
            });
          }
        }, 3500);
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // POOL RENDERER
    // ═══════════════════════════════════════════════════════════════════════════
    const PoolRenderer = {
      renderAll() {
        const grid = document.getElementById('poolsGrid');
        if (!grid) return;
        
        if (State.filteredPools.length === 0) {
          grid.innerHTML = `<div class="alert-empty" style="grid-column:1/-1"><div class="loading-spinner"></div><p style="margin-top:12px">Loading pools...</p></div>`;
          return;
        }
        
        grid.innerHTML = State.filteredPools.map(pool => this.renderCard(pool)).join('');
      },
      
      renderCard(pool) {
        const scoreClass = pool.score >= 75 ? 'high' : pool.score >= 55 ? 'medium' : 'low';
        const safetyIcon = pool.safety === 'safe' ? '✓' : pool.safety === 'warning' ? '!' : '✕';
        const isExpanded = State.expandedPoolId === pool.id;
        
        return `
          <div class="pool-card score-${scoreClass} ${isExpanded ? 'expanded' : ''}" id="pool-${pool.id}">
            <div class="pool-card-main" onclick="PoolRenderer.toggleExpand('${pool.id}')">
              <div class="pool-header">
                <div class="pool-pair">
                  <div class="pool-icons">
                    <div class="pool-icon">${pool.icon1}</div>
                    <div class="pool-icon">${pool.icon2}</div>
                  </div>
                  <div class="pool-info">
                    <h3>${pool.name}</h3>
                    <div class="pool-meta">
                      <span>${pool.protocol}</span>
                      <span>•</span>
                      <span>${pool.feeBps}% fee</span>
                      <span>•</span>
                      <span>Bin ${pool.binStep}</span>
                    </div>
                  </div>
                </div>
                <div class="pool-badges">
                  <span class="score-badge ${scoreClass}">${pool.score}</span>
                  <span class="safety-badge ${pool.safety}">${safetyIcon} ${pool.safety}</span>
                </div>
              </div>
              <div class="pool-stats">
                <div class="pool-stat">
                  <div class="pool-stat-label">TVL</div>
                  <div class="pool-stat-value">${Utils.formatNumber(pool.tvl)}</div>
                </div>
                <div class="pool-stat">
                  <div class="pool-stat-label">24h Vol</div>
                  <div class="pool-stat-value">${Utils.formatNumber(pool.volume)}</div>
                </div>
                <div class="pool-stat">
                  <div class="pool-stat-label">APR</div>
                  <div class="pool-stat-value accent">${pool.apr}%</div>
                </div>
                <div class="pool-stat">
                  <div class="pool-stat-label">24h Fees</div>
                  <div class="pool-stat-value">${Utils.formatNumber(pool.fees)}</div>
                </div>
              </div>
            </div>
            <div class="pool-expanded">
              <div class="pool-expanded-inner">
                ${this.renderChart(pool)}
                ${this.renderTransactionsSection(pool)}
              </div>
            </div>
          </div>
        `;
      },
      
      renderChart(pool) {
        const maxLiq = Math.max(...pool.bins.map(b => b.liquidity));
        const totalLiq = pool.bins.reduce((s, b) => s + b.liquidity, 0);
        
        const binsHtml = pool.bins.map((bin, i) => {
          const height = (bin.liquidity / maxLiq) * 100;
          const isActive = i === pool.activeBin;
          const pct = ((bin.liquidity / totalLiq) * 100).toFixed(2);
          
          return `
            <div class="bin ${isActive ? 'active-bin' : ''}" style="height:${height}%">
              <div class="bin-tooltip">
                <div class="bin-tooltip-row"><span class="bin-tooltip-label">Price</span><span class="bin-tooltip-value">$${Utils.formatPrice(bin.price)}</span></div>
                <div class="bin-tooltip-row"><span class="bin-tooltip-label">Bin ID</span><span class="bin-tooltip-value">#${bin.id}</span></div>
                <div class="bin-tooltip-row"><span class="bin-tooltip-label">Liquidity</span><span class="bin-tooltip-value">${pct}%</span></div>
                <div class="bin-tooltip-row"><span class="bin-tooltip-label">24h Vol</span><span class="bin-tooltip-value">${Utils.formatNumber(bin.volume)}</span></div>
              </div>
            </div>
          `;
        }).join('');
        
        return `
          <div class="chart-section">
            <div class="chart-header">
              <span class="chart-title">Liquidity Distribution (21 Bins)</span>
              <div class="chart-legend">
                <div class="legend-item"><div class="legend-dot liquidity"></div><span>Liquidity</span></div>
                <div class="legend-item"><div class="legend-dot active"></div><span>Active</span></div>
              </div>
            </div>
            <div class="bins-container">${binsHtml}</div>
            <div class="chart-axis">
              <span class="axis-label">$${Utils.formatPrice(pool.bins[0].price)}</span>
              <span class="axis-label active">$${Utils.formatPrice(pool.bins[pool.activeBin].price)}</span>
              <span class="axis-label">$${Utils.formatPrice(pool.bins[20].price)}</span>
            </div>
          </div>
        `;
      },
      
      renderTransactionsSection(pool) {
        return `
          <div class="pool-tx-section">
            <div class="pool-tx-header">
              <span class="pool-tx-title">
                <span class="status-dot ${State.wsConnected ? 'live' : ''}"></span>
                Live Transactions
              </span>
            </div>
            <div class="pool-tx-list" id="tx-list-${pool.id}">
              ${this.renderTransactionsList(pool.id)}
            </div>
          </div>
        `;
      },
      
      renderTransactionsList(poolId) {
        const txs = State.poolTransactions[poolId] || [];
        
        if (txs.length === 0) {
          return '<div class="pool-tx-empty">Waiting for transactions...</div>';
        }
        
        const icons = { add: '+', remove: '-', swap: '⇄' };
        const labels = { add: 'Add', remove: 'Remove', swap: 'Swap' };
        
        return txs.map(tx => `
          <div class="pool-tx-item">
            <div class="pool-tx-type ${tx.type}">${icons[tx.type]}</div>
            <div class="pool-tx-info">
              ${labels[tx.type]} <span>•</span> 
              <a href="https://solscan.io/tx/${tx.signature}" target="_blank" style="color:var(--text-muted);text-decoration:none">${Utils.truncate(tx.signature)}</a>
            </div>
            <div class="pool-tx-amount ${tx.type === 'add' ? 'positive' : tx.type === 'remove' ? 'negative' : ''}">${Utils.formatNumber(parseFloat(tx.amount))}</div>
            <div class="pool-tx-time">${Utils.formatTime(tx.timestamp)}</div>
          </div>
        `).join('');
      },
      
      renderTransactions(poolId) {
        const listEl = document.getElementById(`tx-list-${poolId}`);
        if (listEl) {
          listEl.innerHTML = this.renderTransactionsList(poolId);
        }
      },
      
      toggleExpand(poolId) {
        // Close previous if different
        if (State.expandedPoolId && State.expandedPoolId !== poolId) {
          const prevCard = document.getElementById(`pool-${State.expandedPoolId}`);
          if (prevCard) prevCard.classList.remove('expanded');
        }
        
        // Toggle current
        const card = document.getElementById(`pool-${poolId}`);
        if (!card) return;
        
        if (State.expandedPoolId === poolId) {
          card.classList.remove('expanded');
          State.expandedPoolId = null;
        } else {
          card.classList.add('expanded');
          State.expandedPoolId = poolId;
        }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // ALERTS MODULE
    // ═══════════════════════════════════════════════════════════════════════════
    const Alerts = {
      populateDropdown() {
        const select = document.getElementById('alertPool');
        if (select && State.filteredPools.length > 0) {
          select.innerHTML = State.filteredPools.slice(0, 30).map(p => 
            `<option value="${p.id}">${p.name}</option>`
          ).join('');
        }
      },
      
      add() {
        const poolId = document.getElementById('alertPool')?.value;
        const condition = document.getElementById('alertCondition')?.value;
        const value = parseFloat(document.getElementById('alertValue')?.value);
        
        if (!poolId || !condition || isNaN(value)) return;
        
        const pool = State.pools.find(p => p.id === poolId);
        
        State.alerts.push({
          id: Date.now(),
          poolId,
          poolName: pool?.name || 'Unknown',
          condition,
          value,
          active: true
        });
        
        document.getElementById('alertValue').value = '';
        this.render();
      },
      
      toggle(id, event) {
        if (event) event.stopPropagation();
        const alert = State.alerts.find(a => a.id === id);
        if (alert) alert.active = !alert.active;
        this.render();
      },
      
      remove(id, event) {
        if (event) event.stopPropagation();
        State.alerts = State.alerts.filter(a => a.id !== id);
        this.render();
      },
      
      clearAll() {
        State.alerts = [];
        this.render();
      },
      
      render() {
        const list = document.getElementById('alertList');
        if (!list) return;
        
        if (State.alerts.length === 0) {
          list.innerHTML = '<div class="alert-empty">No alerts configured. Create one above.</div>';
          UI.updateAlertBadge();
          return;
        }
        
        list.innerHTML = State.alerts.map(a => `
          <div class="alert-item">
            <div class="alert-info">
              <div class="alert-icon ${a.condition.includes('above') ? 'up' : 'down'}">
                ${a.condition.includes('above') ? '↑' : '↓'}
              </div>
              <div class="alert-details">
                <h4>${a.poolName}</h4>
                <p>${a.condition.replace('-', ' ')} ${a.condition.includes('tvl') ? Utils.formatNumber(a.value) : '$' + a.value}</p>
              </div>
            </div>
            <div class="alert-actions">
              <button class="toggle ${a.active ? 'active' : ''}" onclick="Alerts.toggle(${a.id}, event)"></button>
              <button class="btn btn--ghost" onclick="Alerts.remove(${a.id}, event)">✕</button>
            </div>
          </div>
        `).join('');
        
        UI.updateAlertBadge();
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // BACKGROUND ANIMATION
    // ═══════════════════════════════════════════════════════════════════════════
    const Background = {
      init() {
        const canvas = document.getElementById('bgCanvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        const resize = () => {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        };
        
        const createParticles = () => {
          particles = [];
          const count = Math.floor((canvas.width * canvas.height) / 25000);
          for (let i = 0; i < count; i++) {
            particles.push({
              x: Math.random() * canvas.width,
              y: Math.random() * canvas.height,
              vx: (Math.random() - 0.5) * 0.3,
              vy: (Math.random() - 0.5) * 0.3,
              size: Math.random() * 1.5 + 0.5,
              alpha: Math.random() * 0.3 + 0.1
            });
          }
        };
        
        const animate = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          
          particles.forEach(p => {
            p.x += p.vx;
            p.y += p.vy;
            
            if (p.x < 0) p.x = canvas.width;
            if (p.x > canvas.width) p.x = 0;
            if (p.y < 0) p.y = canvas.height;
            if (p.y > canvas.height) p.y = 0;
            
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(99, 102, 241, ${p.alpha})`;
            ctx.fill();
          });
          
          requestAnimationFrame(animate);
        };
        
        resize();
        createParticles();
        animate();
        
        window.addEventListener('resize', () => {
          resize();
          createParticles();
        });
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // LIVE BIN UPDATES
    // ═══════════════════════════════════════════════════════════════════════════
    const LiveUpdates = {
      start() {
        setInterval(() => {
          // Update bin liquidity for all pools
          State.pools.forEach(pool => {
            pool.bins.forEach(bin => {
              bin.liquidity = Math.max(5, bin.liquidity + (Math.random() - 0.5) * 2);
            });
          });
          
          // Re-render expanded card's chart if any
          if (State.expandedPoolId) {
            const pool = State.pools.find(p => p.id === State.expandedPoolId);
            if (pool) {
              const card = document.getElementById(`pool-${State.expandedPoolId}`);
              if (card) {
                const chartSection = card.querySelector('.chart-section');
                if (chartSection) {
                  chartSection.outerHTML = PoolRenderer.renderChart(pool);
                }
              }
            }
          }
        }, 3000);
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // APP CONTROLLER
    // ═══════════════════════════════════════════════════════════════════════════
    const App = {
      async init() {
        Background.init();
        UI.setStatus('loading', 'Initializing...');
        
        // Load Jupiter tokens
        await DataService.fetchJupiterTokens();
        
        // Load pools
        await DataService.fetchMeteoraPools();
        
        // Render
        PoolRenderer.renderAll();
        Alerts.populateDropdown();
        Alerts.render();
        
        // Connect WebSocket
        WebSocketService.connect();
        WebSocketService.startSimulation(); // Fallback simulation
        
        // Start live updates
        LiveUpdates.start();
        
        // Periodic refresh
        setInterval(() => this.refresh(), CONFIG.REFRESH_INTERVAL);
      },
      
      async refresh() {
        await DataService.fetchMeteoraPools();
        PoolRenderer.renderAll();
        Alerts.populateDropdown();
      },
      
      applyFilters() {
        DataService.applyFilters();
        PoolRenderer.renderAll();
        Alerts.populateDropdown();
        UI.switchTab('pools');
        UI.setStatus('live', `${State.filteredPools.length} pools`);
      },
      
      toggleJupShield() {
        State.jupshieldEnabled = !State.jupshieldEnabled;
        const toggle = document.getElementById('jupshieldToggle');
        if (toggle) toggle.classList.toggle('active', State.jupshieldEnabled);
        this.applyFilters();
      }
    };

    // Start the app
    document.addEventListener('DOMContentLoaded', () => App.init());
  </script>
</body>
</html>
