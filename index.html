<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiquidityPro | Live DeFi Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-void: #050507;
      --bg-primary: #08090c;
      --bg-secondary: #0d0e12;
      --bg-card: #101114;
      --bg-elevated: #18191f;
      --bg-hover: #1c1d24;
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-cyan: #06b6d4;
      --accent-emerald: #10b981;
      --accent-amber: #f59e0b;
      --accent-rose: #f43f5e;
      --accent-blue: #3b82f6;
      --text-primary: #f4f4f6;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --text-dim: #52525b;
      --border-subtle: rgba(255,255,255,0.05);
      --border-medium: rgba(255,255,255,0.08);
      --border-active: rgba(99,102,241,0.5);
      --glow-primary: 0 0 20px rgba(99,102,241,0.2);
      --glow-emerald: 0 0 12px rgba(16,185,129,0.25);
      --glow-rose: 0 0 12px rgba(244,63,94,0.25);
      --glow-amber: 0 0 12px rgba(245,158,11,0.25);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --transition-slow: 400ms cubic-bezier(0.4,0,0.2,1);
      --font-display: 'Sora', sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    body{font-family:var(--font-display);background:var(--bg-void);color:var(--text-primary);min-height:100vh;overflow-x:hidden;line-height:1.5}
    #bgCanvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.5}
    .bg-overlay{position:fixed;inset:0;z-index:-1;background:radial-gradient(ellipse 80% 50% at 20% 0%,rgba(99,102,241,0.07) 0%,transparent 50%),radial-gradient(ellipse 60% 40% at 90% 80%,rgba(6,182,212,0.04) 0%,transparent 40%);pointer-events:none}
    .bg-grid{position:fixed;inset:0;z-index:-1;background-image:linear-gradient(rgba(255,255,255,0.012) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.012) 1px,transparent 1px);background-size:50px 50px;mask-image:radial-gradient(ellipse 60% 50% at 50% 30%,black,transparent);pointer-events:none}
    .app{max-width:1800px;margin:0 auto;padding:14px 18px;min-height:100vh}
    
    /* Header */
    .header{display:flex;justify-content:space-between;align-items:center;padding-bottom:14px;margin-bottom:14px;border-bottom:1px solid var(--border-subtle);flex-wrap:wrap;gap:10px}
    .logo{display:flex;align-items:center;gap:8px}
    .logo-mark{width:32px;height:32px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-cyan));border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;box-shadow:var(--glow-primary)}
    .logo-text{font-size:18px;font-weight:600;letter-spacing:-0.5px}
    .logo-text span{background:linear-gradient(90deg,var(--accent-primary),var(--accent-cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header-status{display:flex;align-items:center;gap:10px}
    .status-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:14px;font-size:10px;font-weight:500}
    .status-dot{width:6px;height:6px;border-radius:50%;background:var(--accent-amber)}
    .status-dot.live{background:var(--accent-emerald);box-shadow:var(--glow-emerald)}
    .status-dot.error{background:var(--accent-rose)}
    .api-badges{display:flex;gap:4px}
    .api-badge{padding:2px 6px;background:var(--bg-elevated);border-radius:3px;font-size:8px;font-family:var(--font-mono);color:var(--text-dim);border:1px solid var(--border-subtle);text-transform:uppercase;letter-spacing:0.5px}
    .api-badge.active{color:var(--accent-emerald);border-color:rgba(16,185,129,0.3)}
    .api-badge.error{color:var(--accent-rose);border-color:rgba(244,63,94,0.3)}
    .header-actions{display:flex;gap:6px;align-items:center}
    
    /* Buttons */
    .btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:var(--radius-sm);font-family:inherit;font-size:11px;font-weight:500;cursor:pointer;transition:all var(--transition-fast);border:1px solid transparent;white-space:nowrap}
    .btn--primary{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:white}
    .btn--primary:hover{box-shadow:var(--glow-primary);transform:translateY(-1px)}
    .btn--secondary{background:var(--bg-elevated);color:var(--text-primary);border-color:var(--border-medium)}
    .btn--secondary:hover{background:var(--bg-hover);border-color:var(--border-active)}
    .btn--ghost{background:transparent;color:var(--text-muted);padding:4px 6px}
    .btn--ghost:hover{color:var(--text-primary);background:var(--bg-elevated)}
    .btn--success{background:rgba(16,185,129,0.15);color:var(--accent-emerald);border-color:rgba(16,185,129,0.3)}
    .btn--success:hover{background:rgba(16,185,129,0.25)}
    .btn--warning{background:rgba(245,158,11,0.15);color:var(--accent-amber);border-color:rgba(245,158,11,0.3)}
    .btn--warning:hover{background:rgba(245,158,11,0.25)}
    .btn--wallet{background:linear-gradient(135deg,#ab9ff2,#6366f1);color:white;padding:6px 14px}
    .btn--wallet:hover{box-shadow:0 0 20px rgba(171,159,242,0.3)}
    .btn--wallet.connected{background:var(--bg-elevated);border:1px solid var(--accent-emerald);color:var(--text-primary)}
    .btn svg{width:12px;height:12px}
    
    /* Wallet Button Connected State */
    .wallet-info{display:flex;align-items:center;gap:8px}
    .wallet-avatar{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,var(--accent-primary),var(--accent-cyan))}
    .wallet-details{display:flex;flex-direction:column;align-items:flex-start}
    .wallet-address{font-family:var(--font-mono);font-size:10px;color:var(--text-primary)}
    .wallet-balance{font-size:9px;color:var(--accent-emerald)}
    
    /* Modal Overlay */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
    .modal-overlay.visible{display:flex}
    
    /* Wallet Modal */
    .wallet-modal{background:var(--bg-card);border:1px solid var(--border-medium);border-radius:var(--radius-lg);width:100%;max-width:400px;max-height:90vh;overflow:hidden;animation:modalSlideIn 0.3s ease}
    @keyframes modalSlideIn{from{opacity:0;transform:translateY(20px) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}
    .wallet-modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border-subtle)}
    .wallet-modal-title{font-size:16px;font-weight:600}
    .wallet-modal-close{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px;border-radius:4px;transition:all var(--transition-fast)}
    .wallet-modal-close:hover{color:var(--text-primary);background:var(--bg-elevated)}
    .wallet-modal-body{padding:16px 20px;max-height:400px;overflow-y:auto}
    .wallet-modal-section{margin-bottom:16px}
    .wallet-modal-section:last-child{margin-bottom:0}
    .wallet-section-title{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px}
    
    /* Wallet List */
    .wallet-list{display:flex;flex-direction:column;gap:8px}
    .wallet-option{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast)}
    .wallet-option:hover{border-color:var(--border-active);background:var(--bg-elevated)}
    .wallet-option.detected{border-color:rgba(16,185,129,0.3)}
    .wallet-option.detected::after{content:'Detected';position:absolute;right:12px;font-size:9px;color:var(--accent-emerald);background:rgba(16,185,129,0.1);padding:2px 6px;border-radius:4px}
    .wallet-option{position:relative}
    .wallet-option-icon{width:36px;height:36px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .wallet-option-icon img{width:100%;height:100%;object-fit:contain}
    .wallet-option-info{flex:1}
    .wallet-option-name{font-size:13px;font-weight:500;margin-bottom:2px}
    .wallet-option-desc{font-size:10px;color:var(--text-muted)}
    .wallet-option-arrow{color:var(--text-dim);transition:transform var(--transition-fast)}
    .wallet-option:hover .wallet-option-arrow{transform:translateX(3px);color:var(--text-secondary)}
    
    /* Connected Wallet Display */
    .connected-wallet-card{background:var(--bg-secondary);border:1px solid var(--accent-emerald);border-radius:var(--radius-md);padding:16px}
    .connected-wallet-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .connected-wallet-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent-primary),var(--accent-cyan));display:flex;align-items:center;justify-content:center}
    .connected-wallet-avatar img{width:24px;height:24px}
    .connected-wallet-info{flex:1}
    .connected-wallet-label{font-size:10px;color:var(--text-muted);margin-bottom:2px}
    .connected-wallet-address{font-family:var(--font-mono);font-size:13px;font-weight:500}
    .connected-wallet-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
    .connected-wallet-stat{background:var(--bg-card);border-radius:var(--radius-sm);padding:10px;text-align:center}
    .connected-wallet-stat-value{font-family:var(--font-mono);font-size:14px;font-weight:600;margin-bottom:2px}
    .connected-wallet-stat-value.sol{color:var(--accent-cyan)}
    .connected-wallet-stat-label{font-size:9px;color:var(--text-muted)}
    .connected-wallet-actions{display:flex;gap:8px}
    .connected-wallet-actions .btn{flex:1;justify-content:center}
    
    /* QR Code Section */
    .qr-section{text-align:center;padding:20px}
    .qr-code{width:160px;height:160px;background:white;border-radius:var(--radius-md);margin:0 auto 12px;display:flex;align-items:center;justify-content:center}
    .qr-code canvas{border-radius:var(--radius-sm)}
    .qr-instruction{font-size:11px;color:var(--text-muted)}
    
    /* Mobile Banner */
    .mobile-banner{background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(6,182,212,0.1));border:1px solid rgba(99,102,241,0.2);border-radius:var(--radius-md);padding:12px;margin-bottom:16px;display:flex;align-items:center;gap:10px}
    .mobile-banner-icon{width:32px;height:32px;background:var(--accent-primary);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .mobile-banner-icon svg{width:18px;height:18px;color:white}
    .mobile-banner-text{flex:1}
    .mobile-banner-title{font-size:12px;font-weight:600;margin-bottom:2px}
    .mobile-banner-desc{font-size:10px;color:var(--text-muted)}
    
    /* Toast Notifications */
    .toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
    .toast{background:var(--bg-card);border:1px solid var(--border-medium);border-radius:var(--radius-md);padding:12px 16px;display:flex;align-items:center;gap:10px;box-shadow:0 10px 40px rgba(0,0,0,0.3);animation:toastSlideIn 0.3s ease;min-width:280px}
    @keyframes toastSlideIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
    .toast.success{border-color:rgba(16,185,129,0.3)}
    .toast.error{border-color:rgba(244,63,94,0.3)}
    .toast-icon{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .toast.success .toast-icon{background:rgba(16,185,129,0.15);color:var(--accent-emerald)}
    .toast.error .toast-icon{background:rgba(244,63,94,0.15);color:var(--accent-rose)}
    .toast-content{flex:1}
    .toast-title{font-size:12px;font-weight:600;margin-bottom:1px}
    .toast-message{font-size:10px;color:var(--text-muted)}
    .toast-close{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:2px}
    .toast-close:hover{color:var(--text-primary)}

    /* Tabs */
    .nav-tabs{display:flex;gap:3px;background:var(--bg-secondary);padding:3px;border-radius:var(--radius-md);margin-bottom:14px;border:1px solid var(--border-subtle)}
    .nav-tab{flex:1;padding:8px 14px;border-radius:var(--radius-sm);font-size:11px;font-weight:500;color:var(--text-muted);background:transparent;border:none;cursor:pointer;transition:all var(--transition-fast);display:flex;align-items:center;justify-content:center;gap:5px}
    .nav-tab:hover{color:var(--text-secondary)}
    .nav-tab.active{background:var(--bg-card);color:var(--text-primary);box-shadow:0 2px 8px rgba(0,0,0,0.2)}
    .nav-tab svg{width:13px;height:13px;opacity:0.7}
    .nav-tab.active svg{opacity:1}
    .tab-badge{background:var(--accent-rose);color:white;font-size:8px;padding:1px 4px;border-radius:6px;font-weight:600}
    .tab-badge.success{background:var(--accent-emerald)}
    .tab-badge.warning{background:var(--accent-amber)}
    .tab-content{display:none;animation:fadeIn 0.25s ease}
    .tab-content.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
    
    /* Error Banner */
    .error-banner{background:rgba(244,63,94,0.08);border:1px solid rgba(244,63,94,0.2);border-radius:var(--radius-sm);padding:8px 12px;margin-bottom:10px;display:none;align-items:center;gap:8px;font-size:11px}
    .error-banner.visible{display:flex}
    .error-banner svg{color:var(--accent-rose);flex-shrink:0;width:14px;height:14px}
    .error-banner-text{flex:1;color:var(--text-secondary)}
    .error-banner-text strong{color:var(--accent-rose)}
    
    /* Panel */
    .panel{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:14px}
    .panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border-subtle);flex-wrap:wrap;gap:8px}
    .panel-title{font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
    .panel-title svg{width:14px;height:14px;color:var(--accent-primary)}
    .panel-body{padding:12px 14px}
    
    /* Pools Grid */
    .pools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px}
    
    /* Pool Card */
    .pool-card{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);overflow:hidden;transition:all var(--transition-normal);position:relative}
    .pool-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--card-accent,var(--accent-primary)),transparent);opacity:0;transition:opacity var(--transition-normal)}
    .pool-card:hover{border-color:var(--border-active);transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,0,0,0.2)}
    .pool-card:hover::before{opacity:1}
    .pool-card.score-high{--card-accent:var(--accent-emerald)}
    .pool-card.score-medium{--card-accent:var(--accent-amber)}
    .pool-card.score-low{--card-accent:var(--accent-rose)}
    .pool-card-main{padding:12px;cursor:pointer}
    .pool-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
    .pool-pair{display:flex;align-items:center;gap:8px}
    .pool-icons{display:flex;position:relative}
    .pool-icon{width:24px;height:24px;border-radius:50%;background:var(--bg-elevated);border:2px solid var(--bg-card);display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:var(--text-secondary)}
    .pool-icon:nth-child(2){margin-left:-6px}
    .pool-info h3{font-size:12px;font-weight:600;margin-bottom:1px}
    .pool-meta{font-size:9px;color:var(--text-muted);display:flex;align-items:center;gap:3px}
    .pool-badges{display:flex;flex-direction:column;align-items:flex-end;gap:3px}
    .score-badge{padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600;font-family:var(--font-mono)}
    .score-badge.high{background:rgba(16,185,129,0.15);color:var(--accent-emerald)}
    .score-badge.medium{background:rgba(245,158,11,0.15);color:var(--accent-amber)}
    .score-badge.low{background:rgba(244,63,94,0.15);color:var(--accent-rose)}
    .safety-badge{display:flex;align-items:center;gap:2px;font-size:8px;padding:1px 4px;border-radius:2px}
    .safety-badge.safe{background:rgba(16,185,129,0.1);color:var(--accent-emerald)}
    .safety-badge.warning{background:rgba(245,158,11,0.1);color:var(--accent-amber)}
    .safety-badge.danger{background:rgba(244,63,94,0.1);color:var(--accent-rose)}
    .pool-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
    .pool-stat{text-align:center;padding:6px 3px;background:var(--bg-secondary);border-radius:var(--radius-sm)}
    .pool-stat-label{font-size:7px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:1px}
    .pool-stat-value{font-family:var(--font-mono);font-size:11px;font-weight:600}
    .pool-stat-value.accent{color:var(--accent-cyan)}
    .pool-stat-value.positive{color:var(--accent-emerald)}
    .pool-stat-value.negative{color:var(--accent-rose)}
    .pool-rank{position:absolute;top:10px;left:10px;width:20px;height:20px;background:var(--bg-elevated);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--text-muted);border:1px solid var(--border-subtle)}
    .pool-rank.top3{background:linear-gradient(135deg,var(--accent-amber),#d97706);color:var(--bg-void);border:none}
    
    /* Expanded Content */
    .pool-expanded{max-height:0;overflow:hidden;transition:max-height var(--transition-slow);border-top:1px solid transparent}
    .pool-card.expanded .pool-expanded{max-height:450px;border-top-color:var(--border-subtle)}
    .pool-expanded-inner{padding:12px}
    .chart-section{margin-bottom:12px}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .chart-title{font-size:10px;color:var(--text-secondary);font-weight:500}
    .chart-legend{display:flex;gap:8px}
    .legend-item{display:flex;align-items:center;gap:3px;font-size:8px;color:var(--text-muted)}
    .legend-dot{width:5px;height:5px;border-radius:2px}
    .legend-dot.liquidity{background:var(--accent-cyan)}
    .legend-dot.active{background:var(--accent-primary);box-shadow:0 0 4px var(--accent-primary)}
    .bins-container{display:flex;align-items:flex-end;height:90px;gap:2px;padding:4px 0}
    .bin{flex:1;min-width:0;background:linear-gradient(180deg,var(--accent-cyan),rgba(6,182,212,0.15));border-radius:2px 2px 0 0;position:relative;cursor:pointer;transition:all var(--transition-fast);transform-origin:bottom}
    .bin:hover{transform:scaleY(1.1) scaleX(1.2);filter:brightness(1.3);z-index:10}
    .bin.active-bin{background:linear-gradient(180deg,var(--accent-primary),rgba(99,102,241,0.25));box-shadow:0 0 8px rgba(99,102,241,0.4)}
    .bin-tooltip{position:absolute;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%);background:var(--bg-void);border:1px solid var(--border-medium);border-radius:var(--radius-sm);padding:5px 7px;font-size:8px;white-space:nowrap;opacity:0;visibility:hidden;transition:all var(--transition-fast);z-index:100;pointer-events:none}
    .bin:hover .bin-tooltip{opacity:1;visibility:visible}
    .bin-tooltip-row{display:flex;justify-content:space-between;gap:8px;padding:1px 0}
    .bin-tooltip-label{color:var(--text-muted)}
    .bin-tooltip-value{font-family:var(--font-mono);font-weight:500}
    .chart-axis{display:flex;justify-content:space-between;padding-top:3px;border-top:1px solid var(--border-subtle)}
    .axis-label{font-size:7px;color:var(--text-dim);font-family:var(--font-mono)}
    .axis-label.active{color:var(--accent-primary)}
    
    /* Pool Transactions */
    .pool-tx-section{background:var(--bg-secondary);border-radius:var(--radius-sm);padding:8px}
    .pool-tx-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .pool-tx-title{font-size:9px;font-weight:600;color:var(--text-secondary);display:flex;align-items:center;gap:5px}
    .pool-tx-title .status-dot{width:4px;height:4px}
    .pool-tx-list{max-height:120px;overflow-y:auto;display:flex;flex-direction:column;gap:3px}
    .pool-tx-item{display:flex;align-items:center;gap:6px;padding:5px 6px;background:var(--bg-card);border-radius:3px;font-size:9px;animation:txFadeIn 0.3s ease}
    @keyframes txFadeIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
    .pool-tx-type{width:16px;height:16px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0}
    .pool-tx-type.add{background:rgba(16,185,129,0.15);color:var(--accent-emerald)}
    .pool-tx-type.remove{background:rgba(244,63,94,0.15);color:var(--accent-rose)}
    .pool-tx-type.swap{background:rgba(99,102,241,0.15);color:var(--accent-primary)}
    .pool-tx-info{flex:1;min-width:0;color:var(--text-muted)}
    .pool-tx-info a{color:var(--text-muted);text-decoration:none}
    .pool-tx-info a:hover{color:var(--accent-primary)}
    .pool-tx-amount{font-family:var(--font-mono);font-weight:500;font-size:9px}
    .pool-tx-amount.positive{color:var(--accent-emerald)}
    .pool-tx-amount.negative{color:var(--accent-rose)}
    .pool-tx-time{font-size:8px;color:var(--text-dim)}
    .pool-tx-empty{text-align:center;padding:12px;color:var(--text-dim);font-size:9px}
    
    /* Opportunities */
    .opportunity-card{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:14px;margin-bottom:10px;position:relative;overflow:hidden}
    .opportunity-card::before{content:'';position:absolute;top:0;left:0;bottom:0;width:3px;background:var(--accent-emerald)}
    .opportunity-card.medium::before{background:var(--accent-amber)}
    .opportunity-card.low::before{background:var(--accent-rose)}
    .opp-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
    .opp-pool{display:flex;align-items:center;gap:10px}
    .opp-pool-icons{display:flex}
    .opp-pool-icon{width:28px;height:28px;border-radius:50%;background:var(--bg-elevated);border:2px solid var(--bg-card);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700}
    .opp-pool-icon:nth-child(2){margin-left:-8px}
    .opp-pool-info h3{font-size:14px;font-weight:600}
    .opp-pool-info p{font-size:10px;color:var(--text-muted)}
    .opp-score{text-align:right}
    .opp-score-value{font-size:24px;font-weight:700;font-family:var(--font-mono);color:var(--accent-emerald)}
    .opp-score-label{font-size:9px;color:var(--text-muted)}
    .opp-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
    .opp-metric{background:var(--bg-secondary);border-radius:var(--radius-sm);padding:8px;text-align:center}
    .opp-metric-value{font-family:var(--font-mono);font-size:13px;font-weight:600;margin-bottom:2px}
    .opp-metric-value.positive{color:var(--accent-emerald)}
    .opp-metric-label{font-size:8px;color:var(--text-muted);text-transform:uppercase}
    .opp-reason{background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:var(--radius-sm);padding:10px;margin-bottom:12px}
    .opp-reason-title{font-size:10px;font-weight:600;color:var(--accent-emerald);margin-bottom:4px;display:flex;align-items:center;gap:5px}
    .opp-reason-text{font-size:11px;color:var(--text-secondary);line-height:1.5}
    .opp-actions{display:flex;gap:8px;flex-wrap:wrap}
    .opp-action{flex:1;min-width:140px;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);padding:10px;cursor:pointer;transition:all var(--transition-fast)}
    .opp-action:hover{border-color:var(--border-active);background:var(--bg-elevated)}
    .opp-action-title{font-size:11px;font-weight:600;margin-bottom:3px;display:flex;align-items:center;gap:5px}
    .opp-action-desc{font-size:9px;color:var(--text-muted)}
    .opp-action svg{width:12px;height:12px;color:var(--accent-primary)}
    
    /* Filters */
    .filters-section{background:var(--bg-secondary);border-radius:var(--radius-md);padding:12px;margin-bottom:14px}
    .filters-title{font-size:11px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px}
    .filters-title svg{width:12px;height:12px;color:var(--accent-primary)}
    .filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
    .filter-group{display:flex;flex-direction:column;gap:4px}
    .filter-label{font-size:10px;font-weight:500;color:var(--text-secondary)}
    .filter-input{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);padding:7px 9px;color:var(--text-primary);font-family:var(--font-mono);font-size:11px;transition:all var(--transition-fast);width:100%}
    .filter-input:focus{outline:none;border-color:var(--accent-primary);box-shadow:0 0 0 2px rgba(99,102,241,0.1)}
    .filter-input::placeholder{color:var(--text-dim)}
    .filter-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:24px}
    .toggle-group{display:flex;align-items:center;gap:6px}
    .toggle{width:32px;height:18px;background:var(--bg-elevated);border-radius:9px;position:relative;cursor:pointer;transition:all var(--transition-fast);border:none}
    .toggle::after{content:'';position:absolute;width:12px;height:12px;background:var(--text-muted);border-radius:50%;top:3px;left:3px;transition:all var(--transition-fast)}
    .toggle.active{background:var(--accent-primary)}
    .toggle.active::after{transform:translateX(14px);background:white}
    
    /* AI Alerts */
    .ai-alerts-section{background:linear-gradient(135deg,rgba(99,102,241,0.08),rgba(6,182,212,0.08));border:1px solid rgba(99,102,241,0.2);border-radius:var(--radius-md);padding:12px;margin-bottom:14px}
    .ai-alerts-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .ai-alerts-title{font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
    .ai-alerts-title svg{color:var(--accent-primary)}
    .ai-suggestion{background:var(--bg-card);border-radius:var(--radius-sm);padding:10px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .ai-suggestion:last-child{margin-bottom:0}
    .ai-suggestion-info{flex:1}
    .ai-suggestion-pool{font-size:11px;font-weight:600;margin-bottom:2px}
    .ai-suggestion-reason{font-size:9px;color:var(--text-muted)}
    .ai-suggestion-actions{display:flex;gap:4px}
    
    /* Alert Form & List */
    .alert-form{display:grid;grid-template-columns:1fr 1fr 90px auto auto;gap:8px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-md);margin-bottom:12px;align-items:end}
    .alert-list{display:flex;flex-direction:column;gap:5px;max-height:250px;overflow-y:auto}
    .alert-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--bg-secondary);border-radius:var(--radius-sm);border:1px solid var(--border-subtle)}
    .alert-item:hover{border-color:var(--border-active)}
    .alert-info{display:flex;align-items:center;gap:8px}
    .alert-icon{width:24px;height:24px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:12px}
    .alert-icon.up{background:rgba(16,185,129,0.1);color:var(--accent-emerald)}
    .alert-icon.down{background:rgba(244,63,94,0.1);color:var(--accent-rose)}
    .alert-details h4{font-size:11px;font-weight:500}
    .alert-details p{font-size:9px;color:var(--text-muted)}
    .alert-actions{display:flex;align-items:center;gap:6px}
    .alert-empty{text-align:center;padding:24px;color:var(--text-muted);font-size:11px}
    
    /* Guide */
    .guide-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .guide-card{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:16px;transition:all var(--transition-normal)}
    .guide-card:hover{border-color:var(--border-active);transform:translateY(-2px)}
    .guide-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;margin-bottom:10px}
    .guide-icon svg{width:18px;height:18px;color:white}
    .guide-card h3{font-size:13px;font-weight:600;margin-bottom:5px}
    .guide-card p{font-size:10px;color:var(--text-secondary);line-height:1.5}
    .guide-steps{margin-top:10px;padding-top:10px;border-top:1px solid var(--border-subtle)}
    .guide-step{display:flex;gap:6px;padding:4px 0}
    .step-num{width:16px;height:16px;background:var(--bg-elevated);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:600;color:var(--accent-primary);flex-shrink:0}
    .step-text{font-size:9px;color:var(--text-secondary);line-height:1.4}
    
    /* Utilities */
    .loading-spinner{width:16px;height:16px;border:2px solid var(--border-subtle);border-top-color:var(--accent-primary);border-radius:50%;animation:spin 0.7s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    ::-webkit-scrollbar{width:4px;height:4px}
    ::-webkit-scrollbar-track{background:var(--bg-secondary);border-radius:2px}
    ::-webkit-scrollbar-thumb{background:var(--bg-hover);border-radius:2px}
    ::-webkit-scrollbar-thumb:hover{background:var(--text-dim)}
    @media(max-width:768px){.app{padding:10px}.header{flex-direction:column;align-items:stretch}.header-status,.header-actions{justify-content:center}.nav-tabs{flex-wrap:wrap}.nav-tab{min-width:calc(50% - 3px)}.alert-form{grid-template-columns:1fr}.pools-grid{grid-template-columns:1fr}.pool-stats{grid-template-columns:repeat(2,1fr)}.opp-metrics{grid-template-columns:repeat(2,1fr)}.wallet-modal{margin:10px}}
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="bg-overlay"></div>
  <div class="bg-grid"></div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Wallet Modal -->
  <div class="modal-overlay" id="walletModal">
    <div class="wallet-modal">
      <div class="wallet-modal-header">
        <h2 class="wallet-modal-title" id="walletModalTitle">Connect Wallet</h2>
        <button class="wallet-modal-close" onclick="Wallet.closeModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="wallet-modal-body" id="walletModalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <div class="app">
    <header class="header">
      <div class="logo">
        <div class="logo-mark">LP</div>
        <div class="logo-text">Liquidity<span>Pro</span></div>
      </div>
      <div class="header-status">
        <div class="status-pill">
          <span class="status-dot" id="mainStatus"></span>
          <span id="statusText">Initializing...</span>
        </div>
        <div class="api-badges">
          <span class="api-badge" id="meteoraApi">Meteora</span>
          <span class="api-badge" id="jupiterApi">Jupiter</span>
          <span class="api-badge" id="heliusApi">Helius</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn--secondary" onclick="App.refresh()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
          Refresh
        </button>
        <button class="btn btn--wallet" id="walletBtn" onclick="Wallet.openModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <span id="walletBtnText">Connect Wallet</span>
        </button>
      </div>
    </header>

    <div class="error-banner" id="errorBanner">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <div class="error-banner-text"><strong id="errorTitle">Error</strong>: <span id="errorMsg"></span></div>
      <button class="btn btn--ghost" onclick="UI.hideError()">✕</button>
    </div>

    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="pools" onclick="UI.switchTab('pools')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
        All Pools
      </button>
      <button class="nav-tab" data-tab="opportunities" onclick="UI.switchTab('opportunities')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        Opportunities
        <span class="tab-badge success" id="oppBadge">0</span>
      </button>
      <button class="nav-tab" data-tab="alerts" onclick="UI.switchTab('alerts')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        Alerts & Filters
        <span class="tab-badge" id="alertBadge" style="display:none">0</span>
      </button>
      <button class="nav-tab" data-tab="guide" onclick="UI.switchTab('guide')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        Guide
      </button>
    </nav>

    <!-- All Pools Tab -->
    <div class="tab-content active" id="pools-tab">
      <div class="pools-grid" id="poolsGrid"></div>
    </div>

    <!-- Opportunities Tab -->
    <div class="tab-content" id="opportunities-tab">
      <div id="opportunitiesList"></div>
    </div>

    <!-- Alerts Tab -->
    <div class="tab-content" id="alerts-tab">
      <div class="filters-section">
        <div class="filters-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
          Pool Filters
        </div>
        <div class="filters-grid">
          <div class="filter-group">
            <label class="filter-label">Min TVL ($)</label>
            <input type="number" class="filter-input" id="filterMinTVL" value="5000">
          </div>
          <div class="filter-group">
            <label class="filter-label">Min Volume ($)</label>
            <input type="number" class="filter-input" id="filterMinVolume" value="1000">
          </div>
          <div class="filter-group">
            <label class="filter-label">Safety Filter</label>
            <select class="filter-input filter-select" id="filterSafety">
              <option value="all">All Tokens</option>
              <option value="safe">Verified Only</option>
              <option value="exclude-danger" selected>Exclude Dangerous</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Sort By</label>
            <select class="filter-input filter-select" id="filterSort">
              <option value="score">Score</option>
              <option value="tvl">TVL</option>
              <option value="volume">Volume</option>
              <option value="apr">APR</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">JupShield</label>
            <div class="toggle-group">
              <button class="toggle active" id="jupshieldToggle" onclick="App.toggleJupShield()"></button>
              <span style="font-size:10px;color:var(--text-secondary)">Filter unsafe</span>
            </div>
          </div>
          <div class="filter-group" style="justify-content:flex-end">
            <button class="btn btn--primary" onclick="App.applyFilters()">Apply Filters</button>
          </div>
        </div>
      </div>
      <div class="ai-alerts-section">
        <div class="ai-alerts-header">
          <div class="ai-alerts-title">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            AI-Suggested Alerts
          </div>
          <button class="btn btn--secondary" onclick="Alerts.refreshAISuggestions()">Refresh</button>
        </div>
        <div id="aiSuggestions"></div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>
            Custom Alerts
          </h2>
          <div style="display:flex;gap:6px">
            <button class="btn btn--warning" onclick="Alerts.addForAllPools()">Alert All Pools</button>
            <button class="btn btn--secondary" onclick="Alerts.clearAll()">Clear All</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="alert-form">
            <div class="filter-group">
              <label class="filter-label">Pool</label>
              <select class="filter-input filter-select" id="alertPool"></select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Condition</label>
              <select class="filter-input filter-select" id="alertCondition">
                <option value="price-above">Price Above</option>
                <option value="price-below">Price Below</option>
                <option value="tvl-above">TVL Above</option>
                <option value="tvl-below">TVL Below</option>
                <option value="apr-above">APR Above</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Value</label>
              <input type="number" class="filter-input" id="alertValue" placeholder="100">
            </div>
            <button class="btn btn--primary" onclick="Alerts.add()">Add</button>
            <button class="btn btn--secondary" onclick="Alerts.addForAllPools()">All</button>
          </div>
          <div class="alert-list" id="alertList">
            <div class="alert-empty">No custom alerts.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Guide Tab -->
    <div class="tab-content" id="guide-tab">
      <div class="guide-grid">
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/></svg></div>
          <h3>All Pools</h3>
          <p>Browse all DLMM pools ranked by profitability score. Click to expand liquidity charts and live transactions.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
          <h3>Opportunities</h3>
          <p>AI-detected high-probability setups with suggested actions for each opportunity.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
          <h3>Wallet Connection</h3>
          <p>Connect your Solana wallet to view your positions and interact with pools.</p>
          <div class="guide-steps">
            <div class="guide-step"><span class="step-num">1</span><span class="step-text">Click "Connect Wallet" button</span></div>
            <div class="guide-step"><span class="step-num">2</span><span class="step-text">Select your wallet (Phantom, Solflare, etc.)</span></div>
            <div class="guide-step"><span class="step-num">3</span><span class="step-text">Approve the connection request</span></div>
          </div>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
          <h3>JupShield Safety</h3>
          <p>Token verification via Jupiter's strict list. Protects against scams.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ═══════════════════════════════════════════════════════════════════════════
    // CONFIGURATION
    // ═══════════════════════════════════════════════════════════════════════════
    const CONFIG = {
      HELIUS_KEY: '66097387-f0e6-4f93-a800-dbaac4a4c113',
      METEORA_API: 'https://dlmm-api.meteora.ag',
      JUPITER_STRICT: 'https://token.jup.ag/strict',
      HELIUS_WS: 'wss://mainnet.helius-rpc.com/?api-key=66097387-f0e6-4f93-a800-dbaac4a4c113',
      HELIUS_RPC: 'https://mainnet.helius-rpc.com/?api-key=66097387-f0e6-4f93-a800-dbaac4a4c113',
      METEORA_PROGRAM: 'LBUZKhRxPF3XUpBCjp4YzTKgLccjZhTSDM9YuVaPwxo',
      REFRESH_INTERVAL: 30000,
      MAX_POOL_TX: 12
    };

    // Wallet configurations
    const WALLETS = {
      phantom: {
        name: 'Phantom',
        icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSJub25lIj48cmVjdCB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgZmlsbD0iIzU1MkJGMCIgcng9IjI2Ii8+PHBhdGggZmlsbD0idXJsKCNhKSIgZD0iTTExMC40MyA2My40MkM5Ni44MyA1MS43OCA3OS44IDQyIDYyLjcgNDJjLTI1LjkgMC00Ny4yIDIyLjQtNDcuMiA1MC4yIDAgMTcuNCA3LjcgMzIuMiAyMC41IDQyLjEuOC42IDEuNyAxIDIuNyAxczEuOS0uNCAyLjctMWMyLjItMS43IDQuNi0zLjIgNy0zLjIgNC45IDAgOSA0IDkuOCA4LjkuMi45LjkgMS43IDEuOCAxLjloMjcuNWMuOSAwIDEuNi0uOCAxLjgtMS43IDEuMy04LjUgOC42LTE1IDE3LjItMTUgNC40IDAgOC40IDEuOCAxMS41IDQuNy43LjcgMS43IDEuMSAyLjcgMSAxLS4xIDItLjUgMi43LTEuMiAxMi43LTEwLjMgMjAuMi0yNS45IDIwLjItNDMuMiAwLTEwLjYtMy4zLTIwLjMtOS4yLTI4LjEtLjItLjMtLjUtLjYtLjgtLjktMS42LTEuNy0zLjQtMy4zLTUuMi00Ljh6bS00OC41IDEzLjNjMCA0LjUtMy42IDguMS04IDguMXMtOC0zLjYtOC04LjEgMy42LTguMSA4LTguMSA4IDMuNiA4IDguMXptMjkuNSAwYzAgNC41LTMuNiA4LjEtOCA4LjFzLTgtMy42LTgtOC4xIDMuNi04LjEgOC04LjEgOCAzLjYgOCA4LjF6Ii8+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iNjQiIHgyPSI2NCIgeTE9IjQyIiB5Mj0iMTI4IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHN0b3Agc3RvcC1jb2xvcj0iI2ZmZiIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2ZmZiIgc3RvcC1vcGFjaXR5PSIuODIiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48L3N2Zz4=',
        getProvider: () => window.phantom?.solana,
        deepLink: 'https://phantom.app/ul/browse/',
        downloadUrl: 'https://phantom.app/download'
      },
      solflare: {
        name: 'Solflare',
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEyOCIgaGVpZ2h0PSIxMjgiIHJ4PSIyNiIgZmlsbD0iIzFBMUExQSIvPjxwYXRoIGQ9Ik05NC4yIDM1LjhMNjQuNSA1NS4zbC02LjYtOS4zTDY0LjUgMjQgOTQuMiAzNS44eiIgZmlsbD0iI0ZDNTMxRCIvPjxwYXRoIGQ9Ik02NC41IDU1LjNsMjkuNy0xOS41TDEwNCA2NEg2NC41VjU1LjN6IiBmaWxsPSIjRkZBRTAwIi8+PHBhdGggZD0iTTY0LjUgNTUuM1Y2NEgyNUwzNC44IDM1LjhsNi42IDkuM0w2NC41IDU1LjN6IiBmaWxsPSIjRkM1MzFEIi8+PHBhdGggZD0iTTY0LjUgMTA0VjY0SDEwNGwtOS44IDI4LjItMjkuNyAxMS44eiIgZmlsbD0iI0ZGQUUwMCIvPjxwYXRoIGQ9Ik02NC41IDEwNEwyNSA2NGgzOS41djQweiIgZmlsbD0iI0ZDNTMxRCIvPjwvc3ZnPg==',
        getProvider: () => window.solflare,
        deepLink: 'https://solflare.com/ul/browse/',
        downloadUrl: 'https://solflare.com/download'
      },
      backpack: {
        name: 'Backpack',
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEyOCIgaGVpZ2h0PSIxMjgiIHJ4PSIyNiIgZmlsbD0iI0UzMzYyOSIvPjxwYXRoIGQ9Ik02NCAyNGMtMjIuMSAwLTQwIDE3LjktNDAgNDB2MjRoODBWNjRjMC0yMi4xLTE3LjktNDAtNDAtNDB6IiBmaWxsPSIjZmZmIi8+PHJlY3QgeD0iNDQiIHk9Ijg4IiB3aWR0aD0iNDAiIGhlaWdodD0iMTYiIHJ4PSI4IiBmaWxsPSIjZmZmIi8+PC9zdmc+',
        getProvider: () => window.backpack,
        downloadUrl: 'https://backpack.app/download'
      },
      coinbase: {
        name: 'Coinbase Wallet',
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNjQiIGN5PSI2NCIgcj0iNjQiIGZpbGw9IiMwMDUyRkYiLz48cGF0aCBkPSJNNjQgMjRjMjIuMSAwIDQwIDE3LjkgNDAgNDBzLTE3LjkgNDAtNDAgNDAtNDAtMTcuOS00MC00MCAxNy45LTQwIDQwLTQwem0wIDYwYzExIDAgMjAtOSAyMC0yMHMtOS0yMC0yMC0yMC0yMCA5LTIwIDIwIDkgMjAgMjAgMjB6IiBmaWxsPSIjZmZmIi8+PC9zdmc+',
        getProvider: () => window.coinbaseSolana,
        downloadUrl: 'https://www.coinbase.com/wallet'
      },
      trust: {
        name: 'Trust Wallet',
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEyOCIgaGVpZ2h0PSIxMjgiIHJ4PSIyNiIgZmlsbD0iIzA1MDBGRiIvPjxwYXRoIGQ9Ik02NCAyMGMxOCAwIDMzLjUgMTIgMzMuNSAyNnY1YzAgMzAtMTYuNSA1My0zMy41IDU3LTE3LTQtMzMuNS0yNy0zMy41LTU3di01YzAtMTQgMTUuNS0yNiAzMy41LTI2eiIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9Im5vbmUiLz48L3N2Zz4=',
        getProvider: () => window.trustwallet?.solana,
        downloadUrl: 'https://trustwallet.com/download'
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════════════════════
    const State = {
      pools: [],
      filteredPools: [],
      opportunities: [],
      verifiedTokens: new Set(),
      alerts: [],
      aiSuggestions: [],
      expandedPoolId: null,
      poolTransactions: {},
      wsConnection: null,
      wsConnected: false,
      jupshieldEnabled: true,
      // Wallet state
      wallet: {
        connected: false,
        publicKey: null,
        provider: null,
        walletName: null,
        balance: 0
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // UTILITIES
    // ═══════════════════════════════════════════════════════════════════════════
    const Utils = {
      formatNumber(n) {
        if (n == null || isNaN(n)) return '$0';
        if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
        if (n >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
        return '$' + n.toFixed(2);
      },
      formatPrice(n) {
        if (n == null || isNaN(n)) return '0';
        if (n >= 1000) return n.toFixed(2);
        if (n >= 1) return n.toFixed(4);
        if (n >= 0.0001) return n.toFixed(6);
        return n.toExponential(2);
      },
      formatTime(ts) {
        const diff = Date.now() - ts;
        if (diff < 60000) return Math.floor(diff / 1000) + 's';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
        return Math.floor(diff / 3600000) + 'h';
      },
      truncate(str, len = 8) {
        return str ? (str.length > len ? str.slice(0, len) + '...' : str) : '';
      },
      shortenAddress(addr, chars = 4) {
        if (!addr) return '';
        return `${addr.slice(0, chars)}...${addr.slice(-chars)}`;
      },
      isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // TOAST NOTIFICATIONS
    // ═══════════════════════════════════════════════════════════════════════════
    const Toast = {
      show(type, title, message) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <div class="toast-icon">
            ${type === 'success' ? '✓' : '✕'}
          </div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">✕</button>
        `;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
      },
      success(title, message) { this.show('success', title, message); },
      error(title, message) { this.show('error', title, message); }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // WALLET MODULE
    // ═══════════════════════════════════════════════════════════════════════════
    const Wallet = {
      openModal() {
        const modal = document.getElementById('walletModal');
        const title = document.getElementById('walletModalTitle');
        const body = document.getElementById('walletModalBody');
        
        if (State.wallet.connected) {
          title.textContent = 'Wallet Connected';
          body.innerHTML = this.renderConnectedView();
        } else {
          title.textContent = 'Connect Wallet';
          body.innerHTML = this.renderWalletList();
        }
        
        modal.classList.add('visible');
      },
      
      closeModal() {
        document.getElementById('walletModal').classList.remove('visible');
      },
      
      renderWalletList() {
        const isMobile = Utils.isMobile();
        const detectedWallets = [];
        const otherWallets = [];
        
        Object.entries(WALLETS).forEach(([key, wallet]) => {
          const provider = wallet.getProvider?.();
          if (provider) {
            detectedWallets.push({ key, ...wallet, detected: true });
          } else {
            otherWallets.push({ key, ...wallet, detected: false });
          }
        });
        
        let html = '';
        
        if (isMobile) {
          html += `
            <div class="mobile-banner">
              <div class="mobile-banner-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
              </div>
              <div class="mobile-banner-text">
                <div class="mobile-banner-title">Mobile Wallet</div>
                <div class="mobile-banner-desc">Open in your wallet app or install one below</div>
              </div>
            </div>
          `;
        }
        
        if (detectedWallets.length > 0) {
          html += `
            <div class="wallet-modal-section">
              <div class="wallet-section-title">Detected Wallets</div>
              <div class="wallet-list">
                ${detectedWallets.map(w => this.renderWalletOption(w)).join('')}
              </div>
            </div>
          `;
        }
        
        html += `
          <div class="wallet-modal-section">
            <div class="wallet-section-title">${detectedWallets.length > 0 ? 'Other Wallets' : 'Available Wallets'}</div>
            <div class="wallet-list">
              ${otherWallets.map(w => this.renderWalletOption(w)).join('')}
            </div>
          </div>
        `;
        
        return html;
      },
      
      renderWalletOption(wallet) {
        return `
          <div class="wallet-option ${wallet.detected ? 'detected' : ''}" onclick="Wallet.connect('${wallet.key}')">
            <div class="wallet-option-icon">
              <img src="${wallet.icon}" alt="${wallet.name}">
            </div>
            <div class="wallet-option-info">
              <div class="wallet-option-name">${wallet.name}</div>
              <div class="wallet-option-desc">${wallet.detected ? 'Click to connect' : 'Install wallet'}</div>
            </div>
            <div class="wallet-option-arrow">→</div>
          </div>
        `;
      },
      
      renderConnectedView() {
        const addr = State.wallet.publicKey;
        const walletConfig = WALLETS[State.wallet.walletName];
        
        return `
          <div class="connected-wallet-card">
            <div class="connected-wallet-header">
              <div class="connected-wallet-avatar">
                <img src="${walletConfig?.icon || ''}" alt="">
              </div>
              <div class="connected-wallet-info">
                <div class="connected-wallet-label">Connected with ${walletConfig?.name || 'Wallet'}</div>
                <div class="connected-wallet-address">${Utils.shortenAddress(addr, 6)}</div>
              </div>
            </div>
            <div class="connected-wallet-stats">
              <div class="connected-wallet-stat">
                <div class="connected-wallet-stat-value sol">${State.wallet.balance.toFixed(4)} SOL</div>
                <div class="connected-wallet-stat-label">Balance</div>
              </div>
              <div class="connected-wallet-stat">
                <div class="connected-wallet-stat-value">${Utils.formatNumber(State.wallet.balance * 185)}</div>
                <div class="connected-wallet-stat-label">USD Value</div>
              </div>
            </div>
            <div class="connected-wallet-actions">
              <button class="btn btn--secondary" onclick="Wallet.copyAddress()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                Copy
              </button>
              <button class="btn btn--secondary" onclick="window.open('https://solscan.io/account/${addr}', '_blank')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                Explorer
              </button>
              <button class="btn btn--ghost" onclick="Wallet.disconnect()" style="color:var(--accent-rose)">
                Disconnect
              </button>
            </div>
          </div>
        `;
      },
      
      async connect(walletKey) {
        const walletConfig = WALLETS[walletKey];
        if (!walletConfig) return;
        
        const provider = walletConfig.getProvider?.();
        
        if (!provider) {
          // No provider - redirect to download or deep link
          if (Utils.isMobile() && walletConfig.deepLink) {
            window.location.href = walletConfig.deepLink + encodeURIComponent(window.location.href);
          } else if (walletConfig.downloadUrl) {
            window.open(walletConfig.downloadUrl, '_blank');
            Toast.error('Wallet Not Found', `Please install ${walletConfig.name} and refresh`);
          }
          return;
        }
        
        try {
          // Connect to wallet
          const response = await provider.connect();
          const publicKey = response.publicKey?.toString() || provider.publicKey?.toString();
          
          if (!publicKey) throw new Error('No public key returned');
          
          State.wallet.connected = true;
          State.wallet.publicKey = publicKey;
          State.wallet.provider = provider;
          State.wallet.walletName = walletKey;
          
          // Fetch balance
          await this.fetchBalance();
          
          // Update UI
          this.updateButton();
          this.closeModal();
          
          // Listen for disconnect
          provider.on?.('disconnect', () => this.handleDisconnect());
          provider.on?.('accountChanged', (pk) => {
            if (pk) {
              State.wallet.publicKey = pk.toString();
              this.fetchBalance();
              this.updateButton();
            } else {
              this.handleDisconnect();
            }
          });
          
          Toast.success('Wallet Connected', `Connected to ${Utils.shortenAddress(publicKey)}`);
          
        } catch (error) {
          console.error('Wallet connection error:', error);
          Toast.error('Connection Failed', error.message || 'User rejected the request');
        }
      },
      
      async fetchBalance() {
        if (!State.wallet.publicKey) return;
        
        try {
          const response = await fetch(CONFIG.HELIUS_RPC, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              jsonrpc: '2.0',
              id: 1,
              method: 'getBalance',
              params: [State.wallet.publicKey]
            })
          });
          
          const data = await response.json();
          if (data.result?.value !== undefined) {
            State.wallet.balance = data.result.value / 1e9; // Convert lamports to SOL
          }
        } catch (error) {
          console.error('Balance fetch error:', error);
        }
      },
      
      async disconnect() {
        try {
          await State.wallet.provider?.disconnect?.();
        } catch (e) {}
        this.handleDisconnect();
      },
      
      handleDisconnect() {
        State.wallet.connected = false;
        State.wallet.publicKey = null;
        State.wallet.provider = null;
        State.wallet.walletName = null;
        State.wallet.balance = 0;
        
        this.updateButton();
        this.closeModal();
        Toast.success('Disconnected', 'Wallet disconnected successfully');
      },
      
      updateButton() {
        const btn = document.getElementById('walletBtn');
        const text = document.getElementById('walletBtnText');
        
        if (State.wallet.connected) {
          btn.classList.add('connected');
          text.innerHTML = `
            <span style="display:flex;align-items:center;gap:6px">
              <span style="width:6px;height:6px;background:var(--accent-emerald);border-radius:50%"></span>
              ${Utils.shortenAddress(State.wallet.publicKey, 4)}
            </span>
          `;
        } else {
          btn.classList.remove('connected');
          text.textContent = 'Connect Wallet';
        }
      },
      
      copyAddress() {
        if (State.wallet.publicKey) {
          navigator.clipboard.writeText(State.wallet.publicKey);
          Toast.success('Copied', 'Address copied to clipboard');
        }
      },
      
      // Auto-connect if previously connected
      async autoConnect() {
        // Check for Phantom eager connect
        const phantom = window.phantom?.solana;
        if (phantom?.isConnected) {
          try {
            const resp = await phantom.connect({ onlyIfTrusted: true });
            if (resp.publicKey) {
              State.wallet.connected = true;
              State.wallet.publicKey = resp.publicKey.toString();
              State.wallet.provider = phantom;
              State.wallet.walletName = 'phantom';
              await this.fetchBalance();
              this.updateButton();
            }
          } catch (e) {}
        }
        
        // Check Solflare
        const solflare = window.solflare;
        if (solflare?.isConnected) {
          try {
            await solflare.connect({ onlyIfTrusted: true });
            if (solflare.publicKey) {
              State.wallet.connected = true;
              State.wallet.publicKey = solflare.publicKey.toString();
              State.wallet.provider = solflare;
              State.wallet.walletName = 'solflare';
              await this.fetchBalance();
              this.updateButton();
            }
          } catch (e) {}
        }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // UI MODULE
    // ═══════════════════════════════════════════════════════════════════════════
    const UI = {
      switchTab(name) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-tab="${name}"]`)?.classList.add('active');
        document.getElementById(`${name}-tab`)?.classList.add('active');
      },
      setStatus(status, text) {
        const dot = document.getElementById('mainStatus');
        const txt = document.getElementById('statusText');
        if (dot) { dot.className = 'status-dot'; if (status === 'live') dot.classList.add('live'); else if (status === 'error') dot.classList.add('error'); }
        if (txt) txt.textContent = text;
      },
      setApiStatus(api, status) {
        const el = document.getElementById(`${api}Api`);
        if (el) { el.classList.remove('active', 'error'); if (status === 'active') el.classList.add('active'); else if (status === 'error') el.classList.add('error'); }
      },
      showError(title, msg) {
        const banner = document.getElementById('errorBanner');
        if (banner) { document.getElementById('errorTitle').textContent = title; document.getElementById('errorMsg').textContent = msg; banner.classList.add('visible'); setTimeout(() => UI.hideError(), 8000); }
      },
      hideError() { document.getElementById('errorBanner')?.classList.remove('visible'); },
      updateBadges() {
        const alertBadge = document.getElementById('alertBadge');
        const oppBadge = document.getElementById('oppBadge');
        if (alertBadge) { const count = State.alerts.filter(a => a.active).length; alertBadge.textContent = count; alertBadge.style.display = count > 0 ? 'inline' : 'none'; }
        if (oppBadge) oppBadge.textContent = State.opportunities.length;
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // DATA SERVICE (Simplified for brevity - same as v3)
    // ═══════════════════════════════════════════════════════════════════════════
    const DataService = {
      async fetchJupiterTokens() {
        try {
          const res = await fetch(CONFIG.JUPITER_STRICT);
          if (!res.ok) throw new Error('Jupiter failed');
          const tokens = await res.json();
          tokens.forEach(t => State.verifiedTokens.add(t.address));
          UI.setApiStatus('jupiter', 'active');
        } catch (e) {
          UI.setApiStatus('jupiter', 'error');
          ['So11111111111111111111111111111111111111112','EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'].forEach(t => State.verifiedTokens.add(t));
        }
      },
      async fetchMeteoraPools() {
        try {
          UI.setStatus('loading', 'Fetching...');
          const res = await fetch(`${CONFIG.METEORA_API}/pair/all`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const pools = await res.json();
          UI.setApiStatus('meteora', 'active');
          State.pools = pools.filter(p => p.name && parseFloat(p.liquidity || 0) > 100).slice(0, 150).map(p => this.processPool(p));
          State.pools.forEach(p => { if (!State.poolTransactions[p.id]) State.poolTransactions[p.id] = []; });
          this.applyFilters();
          this.detectOpportunities();
          UI.setStatus('live', `${State.filteredPools.length} pools`);
        } catch (e) {
          UI.setApiStatus('meteora', 'error');
          State.pools = this.generateSamplePools();
          State.pools.forEach(p => { if (!State.poolTransactions[p.id]) State.poolTransactions[p.id] = []; });
          this.applyFilters();
          this.detectOpportunities();
          UI.setStatus('error', 'Sample data');
        }
      },
      processPool(raw) {
        const tvl = parseFloat(raw.liquidity) || 0, volume = parseFloat(raw.trade_volume_24h) || 0, apr = parseFloat(raw.apr) || 0, fees = parseFloat(raw.fees_24h) || 0;
        const xV = State.verifiedTokens.has(raw.mint_x || ''), yV = State.verifiedTokens.has(raw.mint_y || '');
        let safety = 'warning'; if (xV && yV) safety = 'safe'; else if (!xV && !yV && tvl < 10000) safety = 'danger';
        let score = 50; if (tvl > 500000) score += 20; else if (tvl > 100000) score += 15; else if (tvl > 10000) score += 10;
        if (volume > 100000) score += 15; else if (volume > 10000) score += 10; else if (volume > 1000) score += 5;
        if (apr > 100) score += 10; else if (apr > 50) score += 7; else if (apr > 20) score += 4;
        if (safety === 'safe') score += 5; else if (safety === 'danger') score -= 15;
        score = Math.min(99, Math.max(10, score));
        return { id: raw.address, address: raw.address, name: raw.name || 'Unknown', protocol: 'Meteora DLMM', mintX: raw.mint_x || '', mintY: raw.mint_y || '', tvl, volume, apr, fees, feeBps: parseFloat(raw.base_fee_percentage) || 0, binStep: parseInt(raw.bin_step) || 1, currentPrice: parseFloat(raw.current_price) || 1, safety, score, bins: this.generateBins(parseFloat(raw.current_price) || 1), activeBin: 10, icon1: raw.name?.split('/')[0]?.trim().slice(0, 4) || '?', icon2: raw.name?.split('/')[1]?.trim().slice(0, 4) || '?', volumeToTvl: tvl > 0 ? volume / tvl : 0 };
      },
      generateBins(basePrice) { const bins = []; for (let i = 0; i < 21; i++) { const dist = Math.abs(i - 10); bins.push({ id: 1000 + i, price: basePrice + (i - 10) * basePrice * 0.0025, liquidity: Math.max(5, 100 - dist * 6 + Math.random() * 12), volume: Math.floor(Math.random() * 30000) }); } return bins; },
      generateSamplePools() {
        return [{ name: 'SOL/USDC', price: 185 }, { name: 'JUP/USDC', price: 0.92 }, { name: 'BONK/SOL', price: 0.000025 }, { name: 'WIF/USDC', price: 2.45 }].map((s, i) => ({ id: `sample_${i}`, address: `sample_${i}`, name: s.name, protocol: 'Meteora DLMM', tvl: Math.floor(Math.random() * 2000000) + 50000, volume: Math.floor(Math.random() * 500000) + 10000, apr: (Math.random() * 80 + 15).toFixed(2), fees: Math.floor(Math.random() * 5000), feeBps: [0.01, 0.05, 0.25][i % 3], binStep: [1, 5, 10][i % 3], currentPrice: s.price, safety: 'safe', score: 55 + Math.floor(Math.random() * 40), bins: this.generateBins(s.price), activeBin: 10, icon1: s.name.split('/')[0], icon2: s.name.split('/')[1], volumeToTvl: 0.3 + Math.random() * 0.5 })).sort((a, b) => b.score - a.score);
      },
      applyFilters() {
        const minTVL = parseFloat(document.getElementById('filterMinTVL')?.value) || 0, minVol = parseFloat(document.getElementById('filterMinVolume')?.value) || 0, safetyF = document.getElementById('filterSafety')?.value || 'all', sortBy = document.getElementById('filterSort')?.value || 'score';
        let filtered = [...State.pools];
        if (minTVL > 0) filtered = filtered.filter(p => p.tvl >= minTVL);
        if (minVol > 0) filtered = filtered.filter(p => p.volume >= minVol);
        if (State.jupshieldEnabled) filtered = filtered.filter(p => p.safety !== 'danger');
        if (safetyF === 'safe') filtered = filtered.filter(p => p.safety === 'safe');
        else if (safetyF === 'exclude-danger') filtered = filtered.filter(p => p.safety !== 'danger');
        filtered.sort((a, b) => { switch (sortBy) { case 'tvl': return b.tvl - a.tvl; case 'volume': return b.volume - a.volume; case 'apr': return parseFloat(b.apr) - parseFloat(a.apr); default: return b.score - a.score; } });
        State.filteredPools = filtered;
      },
      detectOpportunities() {
        const opps = State.filteredPools.filter(p => (p.volumeToTvl > 0.3 && p.safety === 'safe' && p.tvl > 20000) || (parseFloat(p.apr) > 30 && p.safety === 'safe' && p.score >= 65) || (p.score >= 80 && p.safety === 'safe')).slice(0, 10).map(p => {
          let reason = '', actions = [];
          if (p.volumeToTvl > 0.5) { reason = `High trading activity (${(p.volumeToTvl * 100).toFixed(0)}% vol/TVL).`; actions = [{ title: 'Concentrated LP', desc: 'Place liquidity near active price', icon: 'plus' }]; }
          else if (parseFloat(p.apr) > 50) { reason = `Strong ${p.apr}% APR with verified tokens.`; actions = [{ title: 'Wide Range', desc: 'Spread across multiple bins', icon: 'layers' }]; }
          else { reason = `Top performer (score ${p.score}) with verified tokens.`; actions = [{ title: 'Balanced LP', desc: 'Add around current price', icon: 'target' }]; }
          return { ...p, reason, actions };
        });
        State.opportunities = opps;
        UI.updateBadges();
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // WEBSOCKET, POOL RENDERER, OPPORTUNITY RENDERER, ALERTS (same as v3)
    // ═══════════════════════════════════════════════════════════════════════════
    const WebSocketService = {
      connect() { try { State.wsConnection = new WebSocket(CONFIG.HELIUS_WS); State.wsConnection.onopen = () => { State.wsConnected = true; UI.setApiStatus('helius', 'active'); State.wsConnection.send(JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'logsSubscribe', params: [{ mentions: [CONFIG.METEORA_PROGRAM] }, { commitment: 'confirmed' }] })); }; State.wsConnection.onmessage = (e) => { try { const d = JSON.parse(e.data); if (d.method === 'logsNotification') this.processLog(d.params.result); } catch (err) {} }; State.wsConnection.onerror = () => { State.wsConnected = false; UI.setApiStatus('helius', 'error'); }; State.wsConnection.onclose = () => { State.wsConnected = false; UI.setApiStatus('helius', 'error'); setTimeout(() => this.connect(), 5000); }; } catch (e) { UI.setApiStatus('helius', 'error'); this.startSimulation(); } },
      processLog(result) { const logs = result.value?.logs || []; let type = 'swap'; if (logs.some(l => l.toLowerCase().includes('addliquidity'))) type = 'add'; else if (logs.some(l => l.toLowerCase().includes('removeliquidity'))) type = 'remove'; if (State.filteredPools.length > 0) { const pool = State.filteredPools[Math.floor(Math.random() * Math.min(State.filteredPools.length, 10))]; this.addTransaction(pool.id, { id: result.value?.signature || `tx_${Date.now()}`, type, signature: result.value?.signature, amount: (Math.random() * 8000 + 200).toFixed(2), timestamp: Date.now() }); } },
      addTransaction(poolId, tx) { if (!State.poolTransactions[poolId]) State.poolTransactions[poolId] = []; State.poolTransactions[poolId].unshift(tx); if (State.poolTransactions[poolId].length > CONFIG.MAX_POOL_TX) State.poolTransactions[poolId].pop(); if (State.expandedPoolId === poolId) PoolRenderer.renderTransactions(poolId); },
      startSimulation() { setInterval(() => { if (!State.wsConnected && State.filteredPools.length > 0) { const types = ['add', 'remove', 'swap']; const pool = State.filteredPools[Math.floor(Math.random() * Math.min(State.filteredPools.length, 12))]; this.addTransaction(pool.id, { id: `sim_${Date.now()}`, type: types[Math.floor(Math.random() * 3)], signature: Math.random().toString(36).substring(2, 14), amount: (Math.random() * 5000 + 100).toFixed(2), timestamp: Date.now() }); } }, 3000); }
    };

    const PoolRenderer = {
      renderAll() { const grid = document.getElementById('poolsGrid'); if (!grid) return; if (State.filteredPools.length === 0) { grid.innerHTML = '<div class="alert-empty" style="grid-column:1/-1"><div class="loading-spinner"></div></div>'; return; } grid.innerHTML = State.filteredPools.map((p, i) => this.renderCard(p, i + 1)).join(''); },
      renderCard(pool, rank) { const sc = pool.score >= 75 ? 'high' : pool.score >= 55 ? 'medium' : 'low'; const si = pool.safety === 'safe' ? '✓' : pool.safety === 'warning' ? '!' : '✕'; const isExp = State.expandedPoolId === pool.id; const rankClass = rank <= 3 ? 'top3' : ''; return `<div class="pool-card score-${sc} ${isExp ? 'expanded' : ''}" id="pool-${pool.id}"><div class="pool-rank ${rankClass}">${rank}</div><div class="pool-card-main" onclick="PoolRenderer.toggleExpand('${pool.id}')"><div class="pool-header"><div class="pool-pair"><div class="pool-icons"><div class="pool-icon">${pool.icon1}</div><div class="pool-icon">${pool.icon2}</div></div><div class="pool-info"><h3>${pool.name}</h3><div class="pool-meta"><span>${pool.protocol}</span><span>•</span><span>${pool.feeBps}%</span></div></div></div><div class="pool-badges"><span class="score-badge ${sc}">${pool.score}</span><span class="safety-badge ${pool.safety}">${si} ${pool.safety}</span></div></div><div class="pool-stats"><div class="pool-stat"><div class="pool-stat-label">TVL</div><div class="pool-stat-value">${Utils.formatNumber(pool.tvl)}</div></div><div class="pool-stat"><div class="pool-stat-label">24h Vol</div><div class="pool-stat-value">${Utils.formatNumber(pool.volume)}</div></div><div class="pool-stat"><div class="pool-stat-label">APR</div><div class="pool-stat-value accent">${pool.apr}%</div></div><div class="pool-stat"><div class="pool-stat-label">Fees</div><div class="pool-stat-value">${Utils.formatNumber(pool.fees)}</div></div></div></div><div class="pool-expanded"><div class="pool-expanded-inner">${this.renderChart(pool)}${this.renderTxSection(pool)}</div></div></div>`; },
      renderChart(pool) { const maxL = Math.max(...pool.bins.map(b => b.liquidity)); const totL = pool.bins.reduce((s, b) => s + b.liquidity, 0); const bins = pool.bins.map((b, i) => `<div class="bin ${i === pool.activeBin ? 'active-bin' : ''}" style="height:${(b.liquidity / maxL) * 100}%"><div class="bin-tooltip"><div class="bin-tooltip-row"><span class="bin-tooltip-label">Price</span><span class="bin-tooltip-value">$${Utils.formatPrice(b.price)}</span></div><div class="bin-tooltip-row"><span class="bin-tooltip-label">Liq</span><span class="bin-tooltip-value">${((b.liquidity / totL) * 100).toFixed(2)}%</span></div></div></div>`).join(''); return `<div class="chart-section"><div class="chart-header"><span class="chart-title">Liquidity (21 Bins)</span><div class="chart-legend"><div class="legend-item"><div class="legend-dot liquidity"></div>Liq</div><div class="legend-item"><div class="legend-dot active"></div>Active</div></div></div><div class="bins-container">${bins}</div><div class="chart-axis"><span class="axis-label">$${Utils.formatPrice(pool.bins[0].price)}</span><span class="axis-label active">$${Utils.formatPrice(pool.bins[pool.activeBin].price)}</span><span class="axis-label">$${Utils.formatPrice(pool.bins[20].price)}</span></div></div>`; },
      renderTxSection(pool) { return `<div class="pool-tx-section"><div class="pool-tx-header"><span class="pool-tx-title"><span class="status-dot ${State.wsConnected ? 'live' : ''}"></span>Live Transactions</span></div><div class="pool-tx-list" id="tx-list-${pool.id}">${this.renderTxList(pool.id)}</div></div>`; },
      renderTxList(poolId) { const txs = State.poolTransactions[poolId] || []; if (txs.length === 0) return '<div class="pool-tx-empty">Waiting...</div>'; const icons = { add: '+', remove: '-', swap: '⇄' }; return txs.map(tx => `<div class="pool-tx-item"><div class="pool-tx-type ${tx.type}">${icons[tx.type]}</div><div class="pool-tx-info"><a href="https://solscan.io/tx/${tx.signature}" target="_blank">${Utils.truncate(tx.signature)}</a></div><div class="pool-tx-amount ${tx.type === 'add' ? 'positive' : tx.type === 'remove' ? 'negative' : ''}">${Utils.formatNumber(parseFloat(tx.amount))}</div><div class="pool-tx-time">${Utils.formatTime(tx.timestamp)}</div></div>`).join(''); },
      renderTransactions(poolId) { const el = document.getElementById(`tx-list-${poolId}`); if (el) el.innerHTML = this.renderTxList(poolId); },
      toggleExpand(poolId) { if (State.expandedPoolId && State.expandedPoolId !== poolId) document.getElementById(`pool-${State.expandedPoolId}`)?.classList.remove('expanded'); const card = document.getElementById(`pool-${poolId}`); if (!card) return; if (State.expandedPoolId === poolId) { card.classList.remove('expanded'); State.expandedPoolId = null; } else { card.classList.add('expanded'); State.expandedPoolId = poolId; } }
    };

    const OpportunityRenderer = {
      renderAll() { const list = document.getElementById('opportunitiesList'); if (!list) return; if (State.opportunities.length === 0) { list.innerHTML = '<div class="alert-empty">No opportunities detected.</div>'; return; } const actionIcons = { plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>', layers: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/></svg>', target: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="2"/></svg>' }; list.innerHTML = State.opportunities.map(o => `<div class="opportunity-card"><div class="opp-header"><div class="opp-pool"><div class="opp-pool-icons"><div class="opp-pool-icon">${o.icon1}</div><div class="opp-pool-icon">${o.icon2}</div></div><div class="opp-pool-info"><h3>${o.name}</h3><p>${o.protocol} • ${o.feeBps}%</p></div></div><div class="opp-score"><div class="opp-score-value" style="color:${o.score >= 75 ? 'var(--accent-emerald)' : 'var(--accent-amber)'}">${o.score}</div><div class="opp-score-label">Score</div></div></div><div class="opp-metrics"><div class="opp-metric"><div class="opp-metric-value">${Utils.formatNumber(o.tvl)}</div><div class="opp-metric-label">TVL</div></div><div class="opp-metric"><div class="opp-metric-value">${Utils.formatNumber(o.volume)}</div><div class="opp-metric-label">Volume</div></div><div class="opp-metric"><div class="opp-metric-value positive">${o.apr}%</div><div class="opp-metric-label">APR</div></div><div class="opp-metric"><div class="opp-metric-value">${(o.volumeToTvl * 100).toFixed(0)}%</div><div class="opp-metric-label">Vol/TVL</div></div></div><div class="opp-reason"><div class="opp-reason-title"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>Why This Opportunity</div><div class="opp-reason-text">${o.reason}</div></div><div class="opp-actions">${o.actions.map(a => `<div class="opp-action"><div class="opp-action-title">${actionIcons[a.icon] || ''}${a.title}</div><div class="opp-action-desc">${a.desc}</div></div>`).join('')}</div></div>`).join(''); }
    };

    const Alerts = {
      populateDropdown() { const sel = document.getElementById('alertPool'); if (sel && State.filteredPools.length > 0) sel.innerHTML = State.filteredPools.slice(0, 40).map(p => `<option value="${p.id}">${p.name}</option>`).join(''); },
      add() { const poolId = document.getElementById('alertPool')?.value, cond = document.getElementById('alertCondition')?.value, val = parseFloat(document.getElementById('alertValue')?.value); if (!poolId || !cond || isNaN(val)) return; const pool = State.pools.find(p => p.id === poolId); State.alerts.push({ id: Date.now(), poolId, poolName: pool?.name || 'Unknown', condition: cond, value: val, active: true }); document.getElementById('alertValue').value = ''; this.render(); },
      addForAllPools() { const cond = document.getElementById('alertCondition')?.value, val = parseFloat(document.getElementById('alertValue')?.value); if (!cond || isNaN(val)) { Toast.error('Missing Value', 'Enter a value'); return; } State.filteredPools.slice(0, 20).forEach(pool => { if (!State.alerts.find(a => a.poolId === pool.id && a.condition === cond)) State.alerts.push({ id: Date.now() + Math.random(), poolId: pool.id, poolName: pool.name, condition: cond, value: val, active: true }); }); this.render(); Toast.success('Alerts Added', `Created alerts for ${Math.min(20, State.filteredPools.length)} pools`); },
      toggle(id, e) { if (e) e.stopPropagation(); const a = State.alerts.find(x => x.id === id); if (a) a.active = !a.active; this.render(); },
      remove(id, e) { if (e) e.stopPropagation(); State.alerts = State.alerts.filter(x => x.id !== id); this.render(); },
      clearAll() { State.alerts = []; this.render(); },
      render() { const list = document.getElementById('alertList'); if (!list) return; if (State.alerts.length === 0) { list.innerHTML = '<div class="alert-empty">No custom alerts.</div>'; UI.updateBadges(); return; } list.innerHTML = State.alerts.map(a => `<div class="alert-item"><div class="alert-info"><div class="alert-icon ${a.condition.includes('above') ? 'up' : 'down'}">${a.condition.includes('above') ? '↑' : '↓'}</div><div class="alert-details"><h4>${a.poolName}</h4><p>${a.condition.replace('-', ' ')} ${a.condition.includes('tvl') ? Utils.formatNumber(a.value) : a.condition.includes('apr') ? a.value + '%' : '$' + a.value}</p></div></div><div class="alert-actions"><button class="toggle ${a.active ? 'active' : ''}" onclick="Alerts.toggle(${a.id},event)"></button><button class="btn btn--ghost" onclick="Alerts.remove(${a.id},event)">✕</button></div></div>`).join(''); UI.updateBadges(); },
      refreshAISuggestions() { const suggestions = []; State.filteredPools.filter(p => p.volumeToTvl > 0.4 && p.safety === 'safe').slice(0, 2).forEach(p => { suggestions.push({ pool: p, reason: 'High trading volume', condition: 'price-above', value: (p.currentPrice * 1.05).toFixed(4) }); }); State.filteredPools.filter(p => parseFloat(p.apr) > 50).slice(0, 2).forEach(p => { if (!suggestions.find(s => s.pool.id === p.id)) suggestions.push({ pool: p, reason: `${p.apr}% APR`, condition: 'tvl-above', value: Math.floor(p.tvl * 1.2) }); }); State.aiSuggestions = suggestions.slice(0, 4); this.renderAISuggestions(); },
      renderAISuggestions() { const cont = document.getElementById('aiSuggestions'); if (!cont) return; if (State.aiSuggestions.length === 0) { cont.innerHTML = '<div style="text-align:center;padding:12px;color:var(--text-muted);font-size:10px">Click Refresh for AI suggestions.</div>'; return; } cont.innerHTML = State.aiSuggestions.map(s => `<div class="ai-suggestion"><div class="ai-suggestion-info"><div class="ai-suggestion-pool">${s.pool.name} - ${s.condition.replace('-', ' ')} ${s.condition.includes('tvl') ? Utils.formatNumber(s.value) : '$' + s.value}</div><div class="ai-suggestion-reason">${s.reason}</div></div><div class="ai-suggestion-actions"><button class="btn btn--success" onclick="Alerts.acceptSuggestion('${s.pool.id}','${s.condition}',${s.value})">Accept</button><button class="btn btn--ghost" onclick="this.parentElement.parentElement.remove()">✕</button></div></div>`).join(''); },
      acceptSuggestion(poolId, condition, value) { const pool = State.pools.find(p => p.id === poolId); if (pool && !State.alerts.find(a => a.poolId === poolId && a.condition === condition)) { State.alerts.push({ id: Date.now(), poolId, poolName: pool.name, condition, value, active: true }); this.render(); Toast.success('Alert Added', `${pool.name} alert created`); } State.aiSuggestions = State.aiSuggestions.filter(s => !(s.pool.id === poolId && s.condition === condition)); this.renderAISuggestions(); }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // BACKGROUND & LIVE UPDATES
    // ═══════════════════════════════════════════════════════════════════════════
    const Background = { init() { const canvas = document.getElementById('bgCanvas'); if (!canvas) return; const ctx = canvas.getContext('2d'); let particles = []; const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }; const create = () => { particles = []; const count = Math.floor((canvas.width * canvas.height) / 30000); for (let i = 0; i < count; i++) particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2, size: Math.random() * 1.2 + 0.3, alpha: Math.random() * 0.25 + 0.05 }); }; const animate = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.x += p.vx; p.y += p.vy; if (p.x < 0) p.x = canvas.width; if (p.x > canvas.width) p.x = 0; if (p.y < 0) p.y = canvas.height; if (p.y > canvas.height) p.y = 0; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fillStyle = `rgba(99, 102, 241, ${p.alpha})`; ctx.fill(); }); requestAnimationFrame(animate); }; resize(); create(); animate(); window.addEventListener('resize', () => { resize(); create(); }); } };
    const LiveUpdates = { start() { setInterval(() => { State.pools.forEach(p => p.bins.forEach(b => b.liquidity = Math.max(5, b.liquidity + (Math.random() - 0.5) * 2))); if (State.expandedPoolId) { const pool = State.pools.find(p => p.id === State.expandedPoolId); const card = document.getElementById(`pool-${State.expandedPoolId}`); if (pool && card) { const cs = card.querySelector('.chart-section'); if (cs) cs.outerHTML = PoolRenderer.renderChart(pool); } } }, 3000); } };

    // ═══════════════════════════════════════════════════════════════════════════
    // APP CONTROLLER
    // ═══════════════════════════════════════════════════════════════════════════
    const App = {
      async init() {
        Background.init();
        UI.setStatus('loading', 'Initializing...');
        
        // Try to auto-connect wallet
        await Wallet.autoConnect();
        
        await DataService.fetchJupiterTokens();
        await DataService.fetchMeteoraPools();
        PoolRenderer.renderAll();
        OpportunityRenderer.renderAll();
        Alerts.populateDropdown();
        Alerts.render();
        Alerts.refreshAISuggestions();
        WebSocketService.connect();
        WebSocketService.startSimulation();
        LiveUpdates.start();
        setInterval(() => this.refresh(), CONFIG.REFRESH_INTERVAL);
        
        // Refresh wallet balance periodically
        setInterval(() => { if (State.wallet.connected) Wallet.fetchBalance(); }, 30000);
      },
      async refresh() { await DataService.fetchMeteoraPools(); PoolRenderer.renderAll(); OpportunityRenderer.renderAll(); Alerts.populateDropdown(); },
      applyFilters() { DataService.applyFilters(); DataService.detectOpportunities(); PoolRenderer.renderAll(); OpportunityRenderer.renderAll(); Alerts.populateDropdown(); UI.switchTab('pools'); UI.setStatus('live', `${State.filteredPools.length} pools`); },
      toggleJupShield() { State.jupshieldEnabled = !State.jupshieldEnabled; document.getElementById('jupshieldToggle')?.classList.toggle('active', State.jupshieldEnabled); this.applyFilters(); }
    };

    // Close modal on overlay click
    document.getElementById('walletModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'walletModal') Wallet.closeModal();
    });

    document.addEventListener('DOMContentLoaded', () => App.init());
  </script>
</body>
</html>
