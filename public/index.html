<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiquidityPro | Live DeFi Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ═══════════════════════════════════════════════════════════════════════════
       CSS VARIABLES
    ═══════════════════════════════════════════════════════════════════════════ */
    :root {
      --bg-void: #050507;
      --bg-primary: #08090c;
      --bg-secondary: #0d0e12;
      --bg-card: #101114;
      --bg-elevated: #18191f;
      --bg-hover: #1c1d24;
      --accent-primary: #818cf8;
      --accent-secondary: #a78bfa;
      --accent-cyan: #22d3ee;
      --accent-emerald: #34d399;
      --accent-amber: #fbbf24;
      --accent-rose: #fb7185;
      /* Brighter text colors */
      --text-primary: #fafafa;
      --text-secondary: #d4d4d8;
      --text-muted: #a1a1aa;
      --text-dim: #71717a;
      --border-subtle: rgba(255,255,255,0.06);
      --border-medium: rgba(255,255,255,0.10);
      --border-active: rgba(129,140,248,0.6);
      --glow-primary: 0 0 20px rgba(129,140,248,0.25);
      --glow-emerald: 0 0 12px rgba(52,211,153,0.3);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --font-display: 'Sora', sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
      /* Base font size increase */
      --font-base: 14px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESET
    ═══════════════════════════════════════════════════════════════════════════ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: var(--font-display); background: var(--bg-void); color: var(--text-primary); min-height: 100vh; line-height: 1.5; font-size: var(--font-base); }

    /* ═══════════════════════════════════════════════════════════════════════════
       BACKGROUND
    ═══════════════════════════════════════════════════════════════════════════ */
    #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; }
    .bg-overlay { position: fixed; inset: 0; z-index: -1; background: radial-gradient(ellipse 80% 50% at 20% 0%, rgba(99,102,241,0.07) 0%, transparent 50%); pointer-events: none; }

    /* ═══════════════════════════════════════════════════════════════════════════
       LAYOUT
    ═══════════════════════════════════════════════════════════════════════════ */
    .app { max-width: 1800px; margin: 0 auto; padding: 14px 18px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       HEADER
    ═══════════════════════════════════════════════════════════════════════════ */
    .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap; gap: 12px; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-mark { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
    .logo-text { font-size: 20px; font-weight: 600; }
    .logo-text span { background: linear-gradient(90deg, var(--accent-primary), var(--accent-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-status { display: flex; align-items: center; gap: 12px; }
    .status-pill { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; font-size: 12px; color: var(--text-secondary); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-amber); }
    .status-dot.live { background: var(--accent-emerald); box-shadow: var(--glow-emerald); }
    .status-dot.error { background: var(--accent-rose); }
    .api-badges { display: flex; gap: 5px; }
    .api-badge { padding: 3px 8px; background: var(--bg-elevated); border-radius: 4px; font-size: 10px; font-family: var(--font-mono); color: var(--text-muted); border: 1px solid var(--border-subtle); }
    .api-badge.active { color: var(--accent-emerald); border-color: rgba(52,211,153,0.3); }
    .api-badge.error { color: var(--accent-rose); border-color: rgba(251,113,133,0.3); }
    .header-actions { display: flex; gap: 8px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       BUTTONS
    ═══════════════════════════════════════════════════════════════════════════ */
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: var(--radius-sm); font-family: inherit; font-size: 13px; font-weight: 500; cursor: pointer; transition: all var(--transition-fast); border: 1px solid transparent; white-space: nowrap; }
    .btn--primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; }
    .btn--primary:hover { box-shadow: var(--glow-primary); transform: translateY(-1px); }
    .btn--secondary { background: var(--bg-elevated); color: var(--text-primary); border-color: var(--border-medium); }
    .btn--secondary:hover { background: var(--bg-hover); border-color: var(--border-active); }
    .btn--ghost { background: transparent; color: var(--text-secondary); padding: 5px 8px; }
    .btn--ghost:hover { color: var(--text-primary); background: var(--bg-elevated); }
    .btn--success { background: rgba(52,211,153,0.15); color: var(--accent-emerald); border-color: rgba(52,211,153,0.3); }
    .btn--warning { background: rgba(251,191,36,0.15); color: var(--accent-amber); border-color: rgba(251,191,36,0.3); }
    .btn--wallet { background: linear-gradient(135deg, #ab9ff2, #818cf8); color: white; }
    .btn--wallet.connected { background: var(--bg-elevated); border: 1px solid var(--accent-emerald); }
    .btn svg { width: 14px; height: 14px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       TABS
    ═══════════════════════════════════════════════════════════════════════════ */
    .nav-tabs { display: flex; gap: 4px; background: var(--bg-secondary); padding: 4px; border-radius: var(--radius-md); margin-bottom: 16px; border: 1px solid var(--border-subtle); }
    .nav-tab { flex: 1; padding: 10px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; color: var(--text-secondary); background: transparent; border: none; cursor: pointer; transition: all var(--transition-fast); display: flex; align-items: center; justify-content: center; gap: 6px; }
    .nav-tab:hover { color: var(--text-primary); }
    .nav-tab.active { background: var(--bg-card); color: var(--text-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .nav-tab svg { width: 15px; height: 15px; opacity: 0.7; }
    .nav-tab.active svg { opacity: 1; }
    .tab-badge { background: var(--accent-emerald); color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; font-weight: 600; }
    .tab-content { display: none; animation: fadeIn 0.25s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ═══════════════════════════════════════════════════════════════════════════
       TOAST
    ═══════════════════════════════════════════════════════════════════════════ */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: var(--bg-card); border: 1px solid var(--border-medium); border-radius: var(--radius-md); padding: 14px 18px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: toastIn 0.3s ease; min-width: 300px; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    .toast.success { border-color: rgba(52,211,153,0.3); }
    .toast.error { border-color: rgba(251,113,133,0.3); }
    .toast-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; }
    .toast.success .toast-icon { background: rgba(52,211,153,0.15); color: var(--accent-emerald); }
    .toast.error .toast-icon { background: rgba(251,113,133,0.15); color: var(--accent-rose); }
    .toast-content { flex: 1; }
    .toast-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .toast-message { font-size: 12px; color: var(--text-secondary); }
    .toast-close { background: none; border: none; color: var(--text-muted); cursor: pointer; }

    /* ═══════════════════════════════════════════════════════════════════════════
       MODAL
    ═══════════════════════════════════════════════════════════════════════════ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.visible { display: flex; }
    .modal { background: var(--bg-card); border: 1px solid var(--border-medium); border-radius: var(--radius-lg); width: 100%; max-width: 400px; animation: modalIn 0.3s ease; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-subtle); }
    .modal-title { font-size: 16px; font-weight: 600; }
    .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; }
    .modal-body { padding: 16px 20px; max-height: 400px; overflow-y: auto; }
    .wallet-list { display: flex; flex-direction: column; gap: 8px; }
    .wallet-option { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); position: relative; }
    .wallet-option:hover { border-color: var(--border-active); background: var(--bg-elevated); }
    .wallet-option.detected { border-color: rgba(16,185,129,0.3); }
    .wallet-option-icon { width: 36px; height: 36px; border-radius: var(--radius-sm); overflow: hidden; background: var(--bg-elevated); }
    .wallet-option-icon img { width: 100%; height: 100%; }
    .wallet-option-info { flex: 1; }
    .wallet-option-name { font-size: 13px; font-weight: 500; }
    .wallet-option-desc { font-size: 10px; color: var(--text-muted); }
    .wallet-detected-badge { position: absolute; right: 12px; font-size: 9px; color: var(--accent-emerald); background: rgba(16,185,129,0.1); padding: 2px 6px; border-radius: 4px; }
    .connected-wallet { background: var(--bg-secondary); border: 1px solid var(--accent-emerald); border-radius: var(--radius-md); padding: 16px; }
    .connected-wallet-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .connected-wallet-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan)); }
    .connected-wallet-info { flex: 1; }
    .connected-wallet-label { font-size: 10px; color: var(--text-muted); }
    .connected-wallet-address { font-family: var(--font-mono); font-size: 13px; font-weight: 500; }
    .connected-wallet-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
    .connected-wallet-stat { background: var(--bg-card); border-radius: var(--radius-sm); padding: 10px; text-align: center; }
    .connected-wallet-stat-value { font-family: var(--font-mono); font-size: 14px; font-weight: 600; color: var(--accent-cyan); }
    .connected-wallet-stat-label { font-size: 9px; color: var(--text-muted); }
    .connected-wallet-actions { display: flex; gap: 8px; }
    .connected-wallet-actions .btn { flex: 1; justify-content: center; }

    /* ═══════════════════════════════════════════════════════════════════════════
       POOLS CONTAINER - CSS COLUMNS (Independent column flow)
    ═══════════════════════════════════════════════════════════════════════════ */
    .pools-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  gap: 16px;
}

    @media (max-width: 1200px) { .pools-container { column-count: 2; } }
    @media (max-width: 768px) { .pools-container { column-count: 1; } }

    /* ═══════════════════════════════════════════════════════════════════════════
       POOL CARD - BEAUTIFUL DESIGN WITH GRADIENT ACCENTS
    ═══════════════════════════════════════════════════════════════════════════ */
    .pool-card {
      background: linear-gradient(145deg, var(--bg-card) 0%, rgba(24,24,27,0.95) 100%);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: all var(--transition-normal);
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      break-inside: avoid; /* Prevent card from breaking across columns */
      margin-bottom: 16px; /* Spacing between cards in column */
    }
    .pool-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--card-accent, var(--accent-primary)), transparent 80%);
      opacity: 0.7;
    }
    .pool-card:hover { 
      border-color: var(--border-active); 
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 20px rgba(129,140,248,0.1);
      transform: translateY(-2px);
    }
    .pool-card:hover::before { opacity: 1; }
    .pool-card.score-high { --card-accent: var(--accent-emerald); border-color: rgba(52,211,153,0.3); }
    .pool-card.score-high::before { background: linear-gradient(90deg, var(--accent-emerald), rgba(52,211,153,0.2), transparent); }
    .pool-card.score-medium { --card-accent: var(--accent-amber); border-color: rgba(251,191,36,0.3); }
    .pool-card.score-medium::before { background: linear-gradient(90deg, var(--accent-amber), rgba(251,191,36,0.2), transparent); }
    .pool-card.score-low { --card-accent: var(--accent-rose); border-color: rgba(251,113,133,0.3); }
    .pool-card.score-low::before { background: linear-gradient(90deg, var(--accent-rose), rgba(251,113,133,0.2), transparent); }
    .pool-rank { position: absolute; top: 10px; left: 10px; width: 22px; height: 22px; background: var(--bg-elevated); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: var(--text-secondary); border: 1px solid var(--border-subtle); z-index: 2; }
    .pool-rank.top3 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: var(--bg-void); border: none; box-shadow: 0 2px 8px rgba(251,191,36,0.4); }
    .pool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-left: 26px; }
    .pool-pair { display: flex; align-items: center; gap: 10px; }
    .pool-icons { display: flex; }
    .pool-icon { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-secondary)); border: 2px solid var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 700; color: var(--text-primary); box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
    .pool-icon:nth-child(2) { margin-left: -10px; }
    .pool-info h3 { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .pool-type-badge { font-size: 9px; color: var(--text-muted); background: var(--bg-secondary); padding: 2px 6px; border-radius: 3px; margin-left: 6px; }
    .pool-badges { display: flex; align-items: center; gap: 6px; }
    .score-badge { padding: 5px 10px; border-radius: 8px; font-size: 14px; font-weight: 700; font-family: var(--font-mono); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .score-badge.high { background: linear-gradient(135deg, rgba(52,211,153,0.25), rgba(52,211,153,0.1)); color: var(--accent-emerald); border: 1px solid rgba(52,211,153,0.3); }
    .score-badge.medium { background: linear-gradient(135deg, rgba(251,191,36,0.25), rgba(251,191,36,0.1)); color: var(--accent-amber); border: 1px solid rgba(251,191,36,0.3); }
    .score-badge.low { background: linear-gradient(135deg, rgba(251,113,133,0.25), rgba(251,113,133,0.1)); color: var(--accent-rose); border: 1px solid rgba(251,113,133,0.3); }
    .safety-dot { width: 8px; height: 8px; border-radius: 50%; }
    .safety-dot.safe { background: var(--accent-emerald); box-shadow: 0 0 8px var(--accent-emerald); }
    .safety-dot.warning { background: var(--accent-amber); box-shadow: 0 0 6px var(--accent-amber); }
    .safety-dot.danger { background: var(--accent-rose); box-shadow: 0 0 6px var(--accent-rose); }

    .pool-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .pool-stat { text-align: center; padding: 10px 6px; background: linear-gradient(180deg, var(--bg-secondary), rgba(39,39,42,0.5)); border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); }
    .pool-stat-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; letter-spacing: 0.5px; }
    .pool-stat-value { font-family: var(--font-mono); font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .pool-stat-value.accent { color: var(--accent-cyan); text-shadow: 0 0 10px rgba(34,211,238,0.3); }
    
    .pool-expand-hint { text-align: center; margin-top: 10px; font-size: 9px; color: var(--text-dim); opacity: 0.7; }
    
    /* Pool Action Buttons */
    .pool-actions { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .pool-action-btn { display: inline-flex; align-items: center; gap: 5px; padding: 8px 12px; font-size: 11px; font-weight: 500; border-radius: var(--radius-sm); border: 1px solid var(--border-medium); background: var(--bg-elevated); color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); text-decoration: none; }
    .pool-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-active); }
    .pool-action-btn.primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border: none; color: white; box-shadow: 0 2px 8px rgba(129,140,248,0.3); }
    .pool-action-btn.primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .pool-action-btn svg { width: 12px; height: 12px; }
    
    /* Compact badges */
    .pool-badges-row { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
    .mini-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; font-weight: 500; }
    .mini-badge.farm { background: rgba(52,211,153,0.15); color: var(--accent-emerald); border: 1px solid rgba(52,211,153,0.2); }
    .mini-badge.bin { background: rgba(129,140,248,0.15); color: var(--accent-primary); border: 1px solid rgba(129,140,248,0.2); }
    .mini-badge.fee { background: rgba(34,211,238,0.15); color: var(--accent-cyan); border: 1px solid rgba(34,211,238,0.2); }
    .mini-badge.hot { background: rgba(251,113,133,0.2); color: #f87171; border: 1px solid rgba(251,113,133,0.3); animation: hotPulse 1.5s infinite; }
    @keyframes hotPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    
    /* Hot pool indicator */
    .pool-card.is-hot { border-color: rgba(251,113,133,0.4); }
    .pool-card.is-hot::before { opacity: 1; background: linear-gradient(90deg, #f87171, transparent); }
    .hot-indicator { position: absolute; top: 6px; right: 6px; font-size: 14px; z-index: 3; animation: hotBounce 1s infinite; }
    @keyframes hotBounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    
    /* 1h stats highlight */
    .pool-stat.has-1h .pool-stat-label { color: var(--accent-amber); }
    .pool-stat.has-1h .pool-stat-value { color: var(--accent-amber); }
    
    /* Advanced Info in Expanded */
    .pool-advanced-info { padding: 10px; background: var(--bg-secondary); border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); }
    .pool-advanced-info h4 { font-size: 10px; color: var(--text-primary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .advanced-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
    .adv-item { font-size: 10px; color: var(--text-secondary); }
    .adv-item span { color: var(--text-muted); margin-right: 4px; }
    .adv-item.highlight { color: var(--accent-amber); }

    /* Expanded Content - Inline flow, cards below slide down */
    .pool-expanded { 
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows 0.3s ease;
      border-top: 1px solid transparent;
    }
    .pool-expanded-inner { 
      overflow: hidden;
      padding: 0 16px;
      transition: padding 0.3s ease;
    }
    .pool-card.expanded .pool-expanded { 
      grid-template-rows: 1fr;
      border-top-color: var(--border-subtle);
      background: linear-gradient(180deg, var(--bg-secondary), var(--bg-card));
    }
    .pool-card.expanded .pool-expanded-inner {
      padding: 16px;
    }
    @media (max-width: 900px) {
      .pool-card.expanded .pool-expanded-inner {
        padding: 14px;
      }
    }
    
    /* Card main section */
    .pool-card-main {
      padding: 14px;
      cursor: pointer;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       LIQUIDITY CHART - Compact
    ═══════════════════════════════════════════════════════════════════════════ */
    .chart-section { margin-bottom: 10px; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .chart-title { font-size: 11px; color: var(--text-primary); font-weight: 600; }
    .chart-legend { display: flex; gap: 8px; }
    .legend-item { display: flex; align-items: center; gap: 3px; font-size: 9px; color: var(--text-secondary); }
    .legend-dot { width: 5px; height: 5px; border-radius: 2px; }
    .legend-dot.liquidity { background: var(--accent-cyan); box-shadow: 0 0 4px var(--accent-cyan); }
    .legend-dot.active { background: var(--accent-primary); box-shadow: 0 0 6px var(--accent-primary); }
    .bins-container { display: flex; align-items: flex-end; height: 90px; gap: 2px; padding: 8px 0; }
    .bin { flex: 1; min-width: 0; background: linear-gradient(180deg, var(--accent-cyan), rgba(34,211,238,0.15)); border-radius: 2px 2px 0 0; position: relative; cursor: pointer; transition: all var(--transition-fast); transform-origin: bottom; }
    .bin:hover { transform: scaleY(1.1) scaleX(1.2); filter: brightness(1.3); z-index: 10; }
    .bin.active-bin { background: linear-gradient(180deg, var(--accent-primary), rgba(129,140,248,0.25)); box-shadow: 0 0 10px rgba(129,140,248,0.5); }
    .bin-tooltip { position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%); background: var(--bg-void); border: 1px solid var(--border-medium); border-radius: var(--radius-sm); padding: 5px 8px; font-size: 9px; white-space: nowrap; opacity: 0; visibility: hidden; transition: all var(--transition-fast); z-index: 100; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .bin:hover .bin-tooltip { opacity: 1; visibility: visible; }
    .bin-tooltip-row { display: flex; justify-content: space-between; gap: 8px; padding: 1px 0; }
    .bin-tooltip-label { color: var(--text-muted); }
    .bin-tooltip-value { font-family: var(--font-mono); font-weight: 500; color: var(--text-primary); }
    .chart-axis { display: flex; justify-content: space-between; padding-top: 4px; border-top: 1px solid var(--border-subtle); }
    .axis-label { font-size: 9px; color: var(--text-muted); font-family: var(--font-mono); }
    .axis-label.active { color: var(--accent-primary); font-weight: 600; }

    /* ═══════════════════════════════════════════════════════════════════════════
       POOL TRANSACTIONS
    ═══════════════════════════════════════════════════════════════════════════ */
    .pool-tx-section { background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 10px; border: 1px solid var(--border-subtle); }
    .pool-tx-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .pool-tx-title { font-size: 11px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 5px; }
    .pool-tx-title .status-dot { width: 5px; height: 5px; }
    .pool-tx-list { max-height: 180px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
    .pool-tx-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: var(--bg-card); border-radius: 6px; font-size: 11px; }
    .pool-tx-item.new-tx { animation: txIn 0.3s ease; }
    @keyframes txIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
    .pool-tx-type { width: 18px; height: 18px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
    .pool-tx-type.add { background: rgba(52,211,153,0.15); color: var(--accent-emerald); }
    .pool-tx-type.remove { background: rgba(251,113,133,0.15); color: var(--accent-rose); }
    .pool-tx-type.swap { background: rgba(99,102,241,0.15); color: var(--accent-primary); }
    .pool-tx-info { flex: 1; color: var(--text-muted); font-size: 10px; }
    .pool-tx-info a { color: var(--text-muted); text-decoration: none; }
    .pool-tx-info a:hover { color: var(--accent-primary); }
    .pool-tx-amount { font-family: var(--font-mono); font-weight: 500; font-size: 8px; }
    .pool-tx-amount.positive { color: var(--accent-emerald); }
    .pool-tx-amount.negative { color: var(--accent-rose); }
    .pool-tx-time { font-size: 7px; color: var(--text-dim); }
    .pool-tx-empty { text-align: center; padding: 8px; color: var(--text-dim); font-size: 8px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       OPPORTUNITY CARD - BEAUTIFUL DISTINCT DESIGNS
    ═══════════════════════════════════════════════════════════════════════════ */
    /* Opportunities Container - CSS Columns (Independent column flow) */
    #opportunitiesList {
      column-count: 3;
      column-gap: 16px;
    }
    @media (max-width: 1200px) { #opportunitiesList { column-count: 2; } }
    @media (max-width: 768px) { #opportunitiesList { column-count: 1; } }
    
    .opp-card {
      background: linear-gradient(145deg, var(--bg-card) 0%, rgba(24,24,27,0.95) 100%);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      overflow: hidden;
      position: relative;
      transition: all var(--transition-normal);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      break-inside: avoid; /* Prevent card from breaking across columns */
      margin-bottom: 16px; /* Spacing between cards in column */
    }
    .opp-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, var(--accent-emerald), rgba(52,211,153,0.3));
    }
    .opp-card:hover { 
      border-color: var(--border-active); 
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 20px rgba(52,211,153,0.15);
      transform: translateY(-2px);
    }
    
    /* HOT opportunity - Red/Orange theme */
    .opp-card.opp-hot {
      border-color: rgba(251,113,133,0.4);
      background: linear-gradient(145deg, rgba(251,113,133,0.08), var(--bg-card) 30%);
    }
    .opp-card.opp-hot::before { background: linear-gradient(180deg, #f87171, #ef4444, rgba(239,68,68,0.3)); }
    .opp-card.opp-hot:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 25px rgba(251,113,133,0.2); }
    .opp-card.opp-hot .opp-score-value { color: #f87171; }
    .opp-card.opp-hot .opp-reason { background: rgba(251,113,133,0.15); border-color: rgba(251,113,133,0.3); }
    .opp-card.opp-hot .opp-reason-title { color: #f87171; }
    
    /* ACTIVE opportunity - Cyan/Blue theme */
    .opp-card.opp-active {
      border-color: rgba(34,211,238,0.4);
      background: linear-gradient(145deg, rgba(34,211,238,0.08), var(--bg-card) 30%);
    }
    .opp-card.opp-active::before { background: linear-gradient(180deg, var(--accent-cyan), #06b6d4, rgba(6,182,212,0.3)); }
    .opp-card.opp-active:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 25px rgba(34,211,238,0.2); }
    .opp-card.opp-active .opp-score-value { color: var(--accent-cyan); }
    .opp-card.opp-active .opp-reason { background: rgba(34,211,238,0.15); border-color: rgba(34,211,238,0.3); }
    .opp-card.opp-active .opp-reason-title { color: var(--accent-cyan); }
    
    /* STANDARD opportunity - Green theme (default) */
    .opp-card.opp-standard {
      border-color: rgba(52,211,153,0.3);
    }
    
    .opp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .opp-pool { display: flex; align-items: center; gap: 10px; }
    .opp-pool-icons { display: flex; }
    .opp-pool-icon { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-secondary)); border: 2px solid var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 700; color: var(--text-primary); box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
    .opp-pool-icon:nth-child(2) { margin-left: -10px; }
    .opp-pool-info h3 { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .opp-score { text-align: right; }
    .opp-score-value { font-size: 22px; font-weight: 700; font-family: var(--font-mono); color: var(--accent-emerald); text-shadow: 0 0 15px rgba(52,211,153,0.3); }
    .opp-score-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }

    .opp-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
    .opp-metric { background: linear-gradient(180deg, var(--bg-secondary), rgba(39,39,42,0.5)); border-radius: var(--radius-sm); padding: 8px; text-align: center; border: 1px solid var(--border-subtle); }
    .opp-metric-value { font-family: var(--font-mono); font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .opp-metric-value.positive { color: var(--accent-emerald); }
    .opp-metric-label { font-size: 8px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .opp-reason { background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.25); border-radius: var(--radius-sm); padding: 10px; }
    .opp-reason-title { font-size: 10px; font-weight: 600; color: var(--accent-emerald); margin-bottom: 4px; }
    .opp-reason-text { font-size: 11px; color: var(--text-secondary); line-height: 1.4; }

    .opp-expand-hint { text-align: center; padding: 10px; font-size: 9px; color: var(--text-dim); margin-top: 10px; opacity: 0.7; }

    /* Opportunity Expanded - Inline flow, cards below slide down */
    .opp-expanded { 
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows 0.3s ease;
      border-top: 1px solid transparent;
    }
    .opp-expanded-inner { 
      overflow: hidden;
      padding: 0 16px;
      transition: padding 0.3s ease;
    }
    .opp-card.expanded .opp-expanded { 
      grid-template-rows: 1fr;
      border-top-color: var(--border-subtle);
      background: linear-gradient(180deg, var(--bg-secondary), var(--bg-card));
    }
    .opp-card.expanded .opp-expanded-inner {
      padding: 16px;
    }
    
    /* Opp card main section */
    .opp-card-main {
      padding: 14px 14px 14px 20px;
      cursor: pointer;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       FILTERS & ALERTS
    ═══════════════════════════════════════════════════════════════════════════ */
    .filters-section { background: var(--bg-secondary); border-radius: var(--radius-md); padding: 14px; margin-bottom: 16px; }
    .filters-title { font-size: 13px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; color: var(--text-primary); }
    .filters-title svg { width: 14px; height: 14px; color: var(--accent-primary); }
    .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-label { font-size: 12px; font-weight: 500; color: var(--text-primary); }
    .filter-input { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 8px 10px; color: var(--text-primary); font-family: var(--font-mono); font-size: 13px; width: 100%; }
    .filter-input:focus { outline: none; border-color: var(--accent-primary); }
    .filter-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; }
    .toggle-group { display: flex; align-items: center; gap: 8px; }
    .toggle { width: 36px; height: 20px; background: var(--bg-elevated); border-radius: 10px; position: relative; cursor: pointer; border: none; }
    .toggle::after { content: ''; position: absolute; width: 14px; height: 14px; background: var(--text-muted); border-radius: 50%; top: 3px; left: 3px; transition: all var(--transition-fast); }
    .toggle.active { background: var(--accent-primary); }
    .toggle.active::after { transform: translateX(16px); background: white; }
    .ai-alerts-section { background: linear-gradient(135deg, rgba(129,140,248,0.1), rgba(34,211,238,0.1)); border: 1px solid rgba(129,140,248,0.25); border-radius: var(--radius-md); padding: 14px; margin-bottom: 14px; }
    .ai-alerts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .ai-alerts-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; color: var(--text-primary); }
    .ai-suggestion { background: var(--bg-card); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .ai-suggestion-info { flex: 1; }
    .ai-suggestion-pool { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .ai-suggestion-reason { font-size: 11px; color: var(--text-secondary); }
    .ai-suggestion-actions { display: flex; gap: 6px; }
    .panel { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 14px; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap; gap: 10px; }
    .panel-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
    .panel-title svg { width: 16px; height: 16px; color: var(--accent-primary); }
    .panel-body { padding: 14px 16px; }
    .alert-form { display: grid; grid-template-columns: 1fr 1fr 100px auto auto; gap: 10px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 14px; align-items: end; }
    .alert-list { display: flex; flex-direction: column; gap: 6px; max-height: 280px; overflow-y: auto; }
    .alert-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg-secondary); border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); }
    .alert-info { display: flex; align-items: center; gap: 10px; }
    .alert-icon { width: 28px; height: 28px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .alert-icon.up { background: rgba(52,211,153,0.12); color: var(--accent-emerald); }
    .alert-icon.down { background: rgba(251,113,133,0.12); color: var(--accent-rose); }
    .alert-details h4 { font-size: 13px; font-weight: 500; color: var(--text-primary); }
    .alert-details p { font-size: 11px; color: var(--text-secondary); }
    .alert-actions { display: flex; align-items: center; gap: 8px; }
    .alert-empty { text-align: center; padding: 28px; color: var(--text-secondary); font-size: 13px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       GUIDE
    ═══════════════════════════════════════════════════════════════════════════ */
    .guide-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; }
    .guide-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 18px; }
    .guide-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
    .guide-icon svg { width: 20px; height: 20px; color: white; }
    .guide-card h3 { font-size: 15px; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); }
    .guide-card p { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }

    /* Utilities */
    .loading-spinner { width: 18px; height: 18px; border: 2px solid var(--border-subtle); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.7s linear infinite; margin: 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 3px; }

    @media (max-width: 768px) {
      .header { flex-direction: column; }
      .nav-tabs { flex-wrap: wrap; }
      .nav-tab { min-width: calc(50% - 3px); }
      .alert-form { grid-template-columns: 1fr; }
      .pool-stats, .opp-metrics { grid-template-columns: repeat(2, 1fr); }
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       TIP JAR & EMAIL CAPTURE
    ═══════════════════════════════════════════════════════════════════════════ */
    .tip-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      box-shadow: 0 2px 8px rgba(245,158,11,0.3);
    }
    .tip-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,158,11,0.4); }
    .tip-btn svg { width: 14px; height: 14px; }
    
    .email-capture {
      background: linear-gradient(135deg, rgba(129,140,248,0.1), rgba(52,211,153,0.1));
      border: 1px solid rgba(129,140,248,0.25);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 16px;
      text-align: center;
    }
    .email-capture h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
    .email-capture p { font-size: 13px; color: var(--text-secondary); margin-bottom: 14px; }
    .email-form { display: flex; gap: 10px; max-width: 400px; margin: 0 auto; }
    .email-input {
      flex: 1;
      padding: 10px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
    }
    .email-input:focus { outline: none; border-color: var(--accent-primary); }
    .email-submit {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .email-submit:hover { filter: brightness(1.1); }
    .email-success { color: var(--accent-emerald); font-size: 13px; margin-top: 10px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       EXECUTION LAYER - DEPOSIT MODAL
    ═══════════════════════════════════════════════════════════════════════════ */
    .exec-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .exec-modal.active { display: flex; }
    .exec-content {
      background: var(--bg-card);
      border: 1px solid var(--border-active);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .exec-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .exec-header h2 { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .exec-close {
      width: 32px; height: 32px;
      border-radius: 50%;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .exec-close:hover { background: var(--accent-rose); color: white; }
    .exec-body { padding: 20px; }
    .exec-pool-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: 20px;
    }
    .exec-pool-icons { display: flex; }
    .exec-pool-icon { width: 36px; height: 36px; border-radius: 50%; background: var(--bg-elevated); border: 2px solid var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }
    .exec-pool-icon:nth-child(2) { margin-left: -12px; }
    .exec-pool-details h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .exec-pool-details p { font-size: 12px; color: var(--text-secondary); }
    
    .exec-input-group { margin-bottom: 16px; }
    .exec-input-group label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
    .exec-input-row { display: flex; gap: 10px; }
    .exec-input {
      flex: 1;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 16px;
    }
    .exec-input:focus { outline: none; border-color: var(--accent-primary); }
    .exec-token-select {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 12px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
    }
    .exec-max-btn {
      padding: 4px 10px;
      background: rgba(129,140,248,0.15);
      border: none;
      border-radius: 4px;
      color: var(--accent-primary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }
    .exec-balance { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    
    .exec-summary {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 20px;
    }
    .exec-summary-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 13px;
    }
    .exec-summary-row span:first-child { color: var(--text-secondary); }
    .exec-summary-row span:last-child { color: var(--text-primary); font-family: var(--font-mono); }
    .exec-summary-row.total { border-top: 1px solid var(--border-subtle); padding-top: 10px; margin-top: 6px; }
    .exec-summary-row.total span:last-child { color: var(--accent-emerald); font-weight: 600; }
    
    .exec-fee-note {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(251,191,36,0.1);
      border: 1px solid rgba(251,191,36,0.25);
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      font-size: 12px;
      color: var(--accent-amber);
    }
    
    .exec-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      border-radius: var(--radius-md);
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .exec-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .exec-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .exec-btn.loading { pointer-events: none; }
    .exec-btn.loading::after { content: '...'; animation: dots 1s infinite; }
    @keyframes dots { 0%, 33% { content: '.'; } 34%, 66% { content: '..'; } 67%, 100% { content: '...'; } }

    /* ═══════════════════════════════════════════════════════════════════════════
       METRICS DASHBOARD (Admin/Internal)
    ═══════════════════════════════════════════════════════════════════════════ */
    .metrics-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
      font-size: 11px;
      color: var(--text-muted);
      overflow-x: auto;
    }
    .metric-item { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
    .metric-item strong { color: var(--text-primary); font-family: var(--font-mono); }
    
    /* Pro badge teaser */
    .pro-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 6px;
      background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.1));
      border: 1px solid rgba(251,191,36,0.3);
      border-radius: 3px;
      font-size: 9px;
      font-weight: 700;
      color: var(--accent-amber);
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="bg-overlay"></div>
  <div class="toast-container" id="toastContainer"></div>

  <!-- Wallet Modal -->
  <div class="modal-overlay" id="walletModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Connect Wallet</h2>
        <button class="modal-close" onclick="WalletUI.close()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Execution Modal - Deposit into Pool -->
  <div class="exec-modal" id="execModal">
    <div class="exec-content">
      <div class="exec-header">
        <h2>⚡ Quick Deposit</h2>
        <button class="exec-close" onclick="ExecutionLayer.close()">✕</button>
      </div>
      <div class="exec-body">
        <div class="exec-pool-info" id="execPoolInfo">
          <div class="exec-pool-icons">
            <div class="exec-pool-icon" id="execIcon1">-</div>
            <div class="exec-pool-icon" id="execIcon2">-</div>
          </div>
          <div class="exec-pool-details">
            <h3 id="execPoolName">Loading...</h3>
            <p id="execPoolStats">APR: -% | TVL: $-</p>
          </div>
        </div>
        
        <div class="exec-input-group">
          <label>Deposit Amount</label>
          <div class="exec-input-row">
            <input type="number" class="exec-input" id="execAmount" placeholder="0.00" oninput="ExecutionLayer.updateQuote()">
            <div class="exec-token-select" id="execToken">
              <span>SOL</span>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
            <span class="exec-balance">Balance: <strong id="execBalance">0.00</strong> SOL</span>
            <button class="exec-max-btn" onclick="ExecutionLayer.setMax()">MAX</button>
          </div>
        </div>
        
        <div class="exec-summary">
          <div class="exec-summary-row">
            <span>You Deposit</span>
            <span id="execDepositAmount">0.00 SOL</span>
          </div>
          <div class="exec-summary-row">
            <span>Route</span>
            <span id="execRouteInfo">Enter amount to see route</span>
          </div>
          <div class="exec-summary-row">
            <span>Network Fee</span>
            <span id="execNetworkFee">~0.00005 SOL</span>
          </div>
          <div class="exec-summary-row">
            <span>Platform Fee (0.1%)</span>
            <span id="execPlatformFee">0.00 SOL</span>
          </div>
          <div class="exec-summary-row total">
            <span>Est. LP Position</span>
            <span id="execLPValue">$0.00</span>
          </div>
        </div>
        
        <div class="exec-fee-note">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
          <span>0.1% fee supports continued development of free analytics</span>
        </div>
        
        <button class="exec-btn" id="execBtn" onclick="ExecutionLayer.execute()" disabled>
          Connect Wallet to Deposit
        </button>
      </div>
    </div>
  </div>

  <!-- Tip Jar Modal -->
  <div class="exec-modal" id="tipModal">
    <div class="exec-content" style="max-width:400px">
      <div class="exec-header">
        <h2>☕ Support LiquidityPro</h2>
        <button class="exec-close" onclick="TipJar.close()">✕</button>
      </div>
      <div class="exec-body" style="text-align:center">
        <p style="color:var(--text-secondary);margin-bottom:20px">
          Help us keep building free tools for the Solana LP community. Every tip goes directly to development.
        </p>
        
        <div style="background:var(--bg-secondary);border-radius:var(--radius-md);padding:16px;margin-bottom:20px">
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">SOLANA WALLET</div>
          <div style="font-family:var(--font-mono);font-size:12px;color:var(--text-primary);word-break:break-all" id="tipAddress">
            inFuseD3ZaP1m8raFeDDYyAGfA3QCmy71QGsoRcfvuo
          </div>
          <button class="exec-max-btn" style="margin-top:10px" onclick="TipJar.copyAddress()">📋 Copy Address</button>
        </div>
        
        <div class="exec-input-group">
          <label>Quick Tip Amount (SOL)</label>
          <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
            <button class="exec-max-btn" onclick="TipJar.setAmount(0.1)" style="padding:8px 16px">0.1 SOL</button>
            <button class="exec-max-btn" onclick="TipJar.setAmount(0.5)" style="padding:8px 16px">0.5 SOL</button>
            <button class="exec-max-btn" onclick="TipJar.setAmount(1)" style="padding:8px 16px">1 SOL</button>
          </div>
        </div>
        
        <div class="exec-input-group" style="margin-top:16px">
          <div class="exec-input-row">
            <input type="number" class="exec-input" id="tipAmount" placeholder="Custom amount" step="0.01" min="0.01">
            <span style="padding:12px;color:var(--text-secondary)">SOL</span>
          </div>
        </div>
        
        <button class="exec-btn" id="tipBtn" onclick="TipJar.send()" style="margin-top:16px">
          Send Tip 💜
        </button>
        
        <p style="font-size:11px;color:var(--text-dim);margin-top:16px">
          Thank you for supporting open-source DeFi tools!
        </p>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-mark">LP</div>
        <div class="logo-text">Liquidity<span>Pro</span></div>
      </div>
      <div class="header-status">
        <div class="status-pill">
          <span class="status-dot" id="mainStatus"></span>
          <span id="statusText">Initializing...</span>
        </div>
        <div class="api-badges">
          <span class="api-badge" id="meteoraApi">Meteora</span>
          <span class="api-badge" id="jupiterApi">Jupiter</span>
          <span class="api-badge" id="heliusApi">Helius WS</span>
          <span class="api-badge" id="birdeyeApi">Birdeye</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="tip-btn" onclick="TipJar.show()" title="Support Development">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
          Tip SOL
        </button>
        <button class="btn btn--secondary" onclick="App.refresh()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/></svg>
          Refresh
        </button>
        <button class="btn btn--wallet" id="walletBtn" onclick="WalletUI.open()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <span id="walletBtnText">Connect Wallet</span>
        </button>
      </div>
    </header>
    
    <!-- Metrics Bar -->
    <div class="metrics-bar" id="metricsBar">
      <div class="metric-item">👥 Users: <strong id="metricUsers">1</strong></div>
      <div class="metric-item">👁️ Views: <strong id="metricViews">0</strong></div>
      <div class="metric-item">🔍 Pool Clicks: <strong id="metricClicks">0</strong></div>
      <div class="metric-item">⚡ Opportunities: <strong id="metricOpps">0</strong></div>
      <div class="metric-item">⏱️ Session: <strong id="metricSession">0m</strong></div>
    </div>

    <!-- Navigation -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="pools" onclick="TabsUI.switch('pools')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/></svg>
        All Pools
      </button>
      <button class="nav-tab" data-tab="opportunities" onclick="TabsUI.switch('opportunities')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        Opportunities
        <span class="tab-badge" id="oppBadge">0</span>
      </button>
      <button class="nav-tab" data-tab="alerts" onclick="TabsUI.switch('alerts')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>
        Alerts & Filters
      </button>
      <button class="nav-tab" data-tab="guide" onclick="TabsUI.switch('guide')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/></svg>
        Guide
      </button>
    </nav>

    <!-- All Pools Tab -->
    <div class="tab-content active" id="pools-tab">
      <div class="pools-container" id="poolsContainer"></div>
    </div>

    <!-- Opportunities Tab -->
    <div class="tab-content" id="opportunities-tab">
      <!-- Email Capture -->
      <div class="email-capture" id="emailCapture">
        <h3>🔔 Get Opportunity Alerts</h3>
        <p>Be the first to know when high-yield LP opportunities appear. No spam, just alpha.</p>
        <form class="email-form" onsubmit="EmailCapture.submit(event)">
          <input type="email" class="email-input" id="emailInput" placeholder="your@email.com" required>
          <button type="submit" class="email-submit">Subscribe</button>
        </form>
        <div class="email-success" id="emailSuccess" style="display:none">✓ You're subscribed! Check your inbox.</div>
      </div>
      <div id="opportunitiesList"></div>
    </div>

    <!-- Alerts Tab -->
    <div class="tab-content" id="alerts-tab">
      <div class="filters-section">
        <div class="filters-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
          Pool Filters
        </div>
        <div class="filters-grid">
          <div class="filter-group">
            <label class="filter-label">Min TVL ($)</label>
            <input type="number" class="filter-input" id="filterMinTVL" value="5000">
          </div>
          <div class="filter-group">
            <label class="filter-label">Min Volume ($)</label>
            <input type="number" class="filter-input" id="filterMinVolume" value="1000">
          </div>
          <div class="filter-group">
            <label class="filter-label">Safety</label>
            <select class="filter-input filter-select" id="filterSafety">
              <option value="all">All</option>
              <option value="safe">Verified Only</option>
              <option value="exclude-danger" selected>Exclude Dangerous</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Farm Status</label>
            <select class="filter-input filter-select" id="filterFarm">
              <option value="all">All Pools</option>
              <option value="active">Active Farms Only</option>
              <option value="has">Has Farm</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Pool Type</label>
            <select class="filter-input filter-select" id="filterPoolType">
              <option value="all">All Types</option>
              <option value="dlmm">DLMM Only</option>
              <option value="damm">DAMM v2 Only</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Sort By</label>
            <select class="filter-input filter-select" id="filterSort">
              <option value="score">Score</option>
              <option value="fees1h">🔥 Fees 1h (Hot)</option>
              <option value="feeTvl1h">Fee/TVL 1h</option>
              <option value="tvl">TVL</option>
              <option value="volume">Volume 24h</option>
              <option value="apr">APR</option>
              <option value="fees">Fees 24h</option>
              <option value="feeTvl">Fee/TVL 24h</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">JupShield</label>
            <div class="toggle-group">
              <button class="toggle active" id="jupshieldToggle" onclick="App.toggleJupShield()"></button>
              <span style="font-size:10px;color:var(--text-secondary)">Filter unsafe</span>
            </div>
          </div>
          <div class="filter-group" style="justify-content:flex-end">
            <button class="btn btn--primary" onclick="App.applyFilters()">Apply</button>
          </div>
        </div>
      </div>
      <div class="ai-alerts-section">
        <div class="ai-alerts-header">
          <div class="ai-alerts-title">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="2"/></svg>
            AI-Suggested Alerts
          </div>
          <button class="btn btn--secondary" onclick="AlertsUI.refreshAI()">Refresh</button>
        </div>
        <div id="aiSuggestions"></div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>
            Custom Alerts
          </h2>
          <div style="display:flex;gap:6px">
            <button class="btn btn--warning" onclick="AlertsUI.addForAll()">Alert All</button>
            <button class="btn btn--secondary" onclick="AlertsUI.clearAll()">Clear</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="alert-form">
            <div class="filter-group">
              <label class="filter-label">Pool</label>
              <select class="filter-input filter-select" id="alertPool"></select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Condition</label>
              <select class="filter-input filter-select" id="alertCondition">
                <option value="fees1h-above">🔥 Fees 1h Above</option>
                <option value="feeTvl1h-above">Fee/TVL 1h Above</option>
                <option value="price-above">Price Above</option>
                <option value="price-below">Price Below</option>
                <option value="tvl-above">TVL Above</option>
                <option value="apr-above">APR Above</option>
                <option value="volume-above">Volume Above</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Value</label>
              <input type="number" class="filter-input" id="alertValue" placeholder="100">
            </div>
            <button class="btn btn--primary" onclick="AlertsUI.add()">Add</button>
            <button class="btn btn--secondary" onclick="AlertsUI.addForAll()">All</button>
          </div>
          <div class="alert-list" id="alertList">
            <div class="alert-empty">No alerts configured.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Guide Tab -->
    <div class="tab-content" id="guide-tab">
      <div class="guide-grid">
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/></svg></div>
          <h3>All Pools</h3>
          <p>Browse DLMM pools ranked by score. Click any card to expand charts and live transactions.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
          <h3>Opportunities</h3>
          <p>AI-detected high-probability setups. Click to expand real-time charts and transaction flow.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/></svg></div>
          <h3>Wallet</h3>
          <p>Connect Phantom, Solflare, or Backpack to interact with pools directly.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
          <h3>JupShield Safety</h3>
          <p>Token verification via Jupiter strict list. ✓ Safe, ! Warning, ✕ Danger.</p>
        </div>
      </div>
    </div>
  </div>

<script>
    // ═══════════════════════════════════════════════════════════════════════════
    // CONFIGURATION - ALL API KEYS & ENDPOINTS
    // ═══════════════════════════════════════════════════════════════════════════
    const CONFIG = {
      // Meteora APIs
      METEORA_DAMM_V2: 'https://dammv2-api.meteora.ag',
      METEORA_DLMM: 'https://dlmm-api.meteora.ag',
      METEORA_PROGRAM: 'LBUZKhRxPF3XUpBCjp4YzTKgLccjZhTSDM9YuVaPwxo',
      
      // Jupiter Token Verification
      JUPITER_PRICE: 'https://api.jup.ag/price/v3/price',
      JUPITER_TOKENS: 'https://api.jup.ag/tokens/v2/tag?query=verified',
      
      // Helius API (Primary)
      HELIUS_KEY: '66097387-f0e6-4f93-a800-dbaac4a4c113',
      HELIUS_RPC: 'https://mainnet.helius-rpc.com/?api-key=66097387-f0e6-4f93-a800-dbaac4a4c113',
      HELIUS_WS: 'wss://mainnet.helius-rpc.com/?api-key=66097387-f0e6-4f93-a800-dbaac4a4c113',
      
      // Refresh intervals (faster for short-term opportunities)
      REFRESH_INTERVAL: 10000,      // 10 seconds for pool data
      FAST_REFRESH: 5000,           // 5 seconds for price-sensitive data
      WS_RECONNECT_DELAY: 2000,
      MAX_ERRORS: 3
    };

    // Wallet Configurations
    const WALLETS = {
      phantom: { 
        name: 'Phantom', 
        icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgZmlsbD0ibm9uZSI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjNTUyQkYwIiByeD0iOCIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0yOSAxOWMtMS44LTEuNS00LjItMi44LTctMi44LTQuMiAwLTcuNyAzLjYtNy43IDguMiAwIDIuOCAxLjIgNS4yIDMuMyA2LjguMi4xLjMuMi41LjJzLjMtLjEuNC0uMmMuNC0uMy44LS41IDEuMS0uNS44IDAgMS41LjcgMS42IDEuNSAwIC4yLjIuMy4zLjNoNC41Yy4xIDAgLjMtLjEuMy0uMy4yLTEuNCAxLjQtMi40IDIuOC0yLjQuNyAwIDEuNC4zIDEuOS44LjEuMS4zLjIuNC4ycy4zLS4xLjQtLjJjMi0xLjcgMy4zLTQuMiAzLjMtNyAwLTEuNy0uNS0zLjMtMS41LTQuNi0uMy0uNC0uNi0uNy0uOS0xLS4zLS4zLS42LS41LS44LS44em0tNyAyLjJjMCAuNy0uNiAxLjMtMS4zIDEuM3MtMS4zLS42LTEuMy0xLjMuNi0xLjMgMS4zLTEuMyAxLjMuNiAxLjMgMS4zem00LjggMGMwIC43LS42IDEuMy0xLjMgMS4zcy0xLjMtLjYtMS4zLTEuMy42LTEuMyAxLjMtMS4zIDEuMy42IDEuMyAxLjN6Ii8+PC9zdmc+',
        getProvider: () => window.phantom?.solana,
        downloadUrl: 'https://phantom.app'
      },
      solflare: {
        name: 'Solflare',
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjRkM2QjFEIi8+PHBhdGggZD0iTTIwIDEwTDI4IDE1VjI1TDIwIDMwTDEyIDI1VjE1TDIwIDEwWiIgZmlsbD0id2hpdGUiLz48L3N2Zz4=',
        getProvider: () => window.solflare,
        downloadUrl: 'https://solflare.com'
      },
      backpack: {
        name: 'Backpack',
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjRTMzNjI5Ii8+PHBhdGggZD0iTTIwIDhDMTMuNCAgOCA4IDEzLjQgOCAyMFYyOEgzMlYyMEMzMiAxMy40IDI2LjYgOCAyMCA4WiIgZmlsbD0id2hpdGUiLz48L3N2Zz4=',
        getProvider: () => window.backpack,
        downloadUrl: 'https://backpack.app'
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════════════════════

    const State = {
      
      filteredPools: [],
      opportunities: [],
      verifiedTokens: new Set(),
      alerts: [],
      aiSuggestions: [],
      expandedPoolId: null,
      expandedOppId: null,
      poolTransactions: {},
      wsConnection: null,
      wsConnected: false,
      currentWsSource: null,
      jupshieldEnabled: true,
      wallet: { connected: false, publicKey: null, provider: null, name: null, balance: 0 },
      apiStatus: { meteora: false, jupiter: false, helius: false, birdeye: false }
    };


  document.addEventListener('DOMContentLoaded', () => App.init());
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (State.expandedPoolId) {
        const card = document.getElementById(`pool-${State.expandedPoolId}`);
        if (card) card.classList.remove('expanded');
        State.expandedPoolId = null;
      }
      if (State.expandedOppId) {
        const card = document.getElementById(`opp-${State.expandedOppId}`);
        if (card) card.classList.remove('expanded');
        State.expandedOppId = null;
      }
    }
  });
    
  

    // ═══════════════════════════════════════════════════════════════════════════
    // UTILITIES
    // ═══════════════════════════════════════════════════════════════════════════
    const Utils = {
      formatNumber: n => { if (n == null || isNaN(n)) return '$0'; if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M'; if (n >= 1e3) return '$' + (n/1e3).toFixed(1) + 'K'; return '$' + n.toFixed(2); },
      formatPrice: n => { if (n == null || isNaN(n)) return '0'; if (n >= 1000) return n.toFixed(2); if (n >= 1) return n.toFixed(4); return n.toFixed(6); },
      formatTime: ts => { const d = Date.now() - ts; if (d < 60000) return Math.floor(d/1000) + 's'; if (d < 3600000) return Math.floor(d/60000) + 'm'; return Math.floor(d/3600000) + 'h'; },
      truncate: (s, l=8) => s ? (s.length > l ? s.slice(0,l) + '...' : s) : '',
      shortenAddress: (a, c=4) => a ? `${a.slice(0,c)}...${a.slice(-c)}` : '',
      copyIcon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>'
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // TOAST UI
    // ═══════════════════════════════════════════════════════════════════════════
    const ToastUI = {
      show(type, title, msg) {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<div class="toast-icon">${type === 'success' ? '✓' : '✕'}</div><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${msg}</div></div><button class="toast-close" onclick="this.parentElement.remove()">✕</button>`;
        c.appendChild(t);
        setTimeout(() => t.remove(), 5000);
      },
      success: (t, m) => ToastUI.show('success', t, m),
      error: (t, m) => ToastUI.show('error', t, m)
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // TABS UI
    // ═══════════════════════════════════════════════════════════════════════════
    const TabsUI = {
      switch(name) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-tab="${name}"]`)?.classList.add('active');
        document.getElementById(`${name}-tab`)?.classList.add('active');
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // STATUS UI
    // ═══════════════════════════════════════════════════════════════════════════
    const StatusUI = {
      set(status, text) {
        const dot = document.getElementById('mainStatus');
        const txt = document.getElementById('statusText');
        if (dot) { dot.className = 'status-dot'; if (status === 'live') dot.classList.add('live'); else if (status === 'error') dot.classList.add('error'); }
        if (txt) txt.textContent = text;
      },
      setApi(api, active) {
        const el = document.getElementById(`${api}Api`);
        if (el) { el.classList.remove('active', 'error'); el.classList.add(active ? 'active' : 'error'); }
        State.apiStatus[api] = active;
      },
      updateBadges() {
        const ob = document.getElementById('oppBadge');
        if (ob) ob.textContent = State.opportunities.length;
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // TIP JAR - Support development
    // ═══════════════════════════════════════════════════════════════════════════
    const TipJar = {
      WALLET: 'inFuseD3ZaP1m8raFeDDYyAGfA3QCmy71QGsoRcfvuo',
      
      show() {
        document.getElementById('tipModal').classList.add('active');
        Metrics.track('tip_jar_opened');
      },
      
      close() {
        document.getElementById('tipModal').classList.remove('active');
      },
      
      setAmount(amount) {
        document.getElementById('tipAmount').value = amount;
      },
      
      copyAddress() {
        navigator.clipboard.writeText(this.WALLET);
        ToastUI.success('Copied!', 'Wallet address copied to clipboard');
        Metrics.track('tip_address_copied');
      },
      
      async send() {
        const amount = parseFloat(document.getElementById('tipAmount').value);
        if (!amount || amount <= 0) {
          ToastUI.error('Invalid Amount', 'Please enter a valid tip amount');
          return;
        }
        
        if (!State.wallet.connected) {
          ToastUI.error('Wallet Required', 'Please connect your wallet first');
          WalletUI.open();
          return;
        }
        
        const btn = document.getElementById('tipBtn');
        btn.disabled = true;
        btn.classList.add('loading');
        btn.textContent = 'Sending';
        
        try {
          const provider = window.phantom?.solana || window.solflare || window.backpack;
          if (!provider) throw new Error('No wallet provider');
          
          // Create transfer transaction
          const connection = new (window.solanaWeb3?.Connection || class{})(CONFIG.HELIUS_RPC);
          const fromPubkey = provider.publicKey;
          const toPubkey = new (window.solanaWeb3?.PublicKey || class{})(this.WALLET);
          
          // For now, show manual transfer instructions
          ToastUI.info('Manual Transfer', `Please send ${amount} SOL to: ${Utils.shortenAddress(this.WALLET, 8)}`);
          
          Metrics.track('tip_attempted', { amount });
          this.close();
          
        } catch (err) {
          console.error('Tip error:', err);
          ToastUI.error('Transfer Failed', err.message || 'Please try again');
        } finally {
          btn.disabled = false;
          btn.classList.remove('loading');
          btn.textContent = 'Send Tip 💜';
        }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // EMAIL CAPTURE - Build mailing list
    // ═══════════════════════════════════════════════════════════════════════════
    const EmailCapture = {
      STORAGE_KEY: 'lp_email_subscribed',
      
      init() {
        if (localStorage.getItem(this.STORAGE_KEY)) {
          const el = document.getElementById('emailCapture');
          if (el) el.style.display = 'none';
        }
      },
      
      submit(e) {
        e.preventDefault();
        const email = document.getElementById('emailInput').value;
        if (!email) return;
        
        // Store locally (in production, send to backend/email service)
        const emails = JSON.parse(localStorage.getItem('lp_emails') || '[]');
        if (!emails.includes(email)) {
          emails.push(email);
          localStorage.setItem('lp_emails', JSON.stringify(emails));
        }
        
        localStorage.setItem(this.STORAGE_KEY, 'true');
        
        // Show success
        document.querySelector('.email-form').style.display = 'none';
        document.getElementById('emailSuccess').style.display = 'block';
        
        Metrics.track('email_subscribed', { email: email.split('@')[1] }); // Domain only for privacy
        ToastUI.success('Subscribed!', 'You\'ll receive opportunity alerts');
        
        // Hide capture after a moment
        setTimeout(() => {
          const el = document.getElementById('emailCapture');
          if (el) el.style.opacity = '0';
          setTimeout(() => { if (el) el.style.display = 'none'; }, 300);
        }, 3000);
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // EXECUTION LAYER - Full Jupiter Ultra API Integration
    // ═══════════════════════════════════════════════════════════════════════════
    const ExecutionLayer = {
      currentPool: null,
      PLATFORM_FEE_BPS: 10, // 0.1% = 10 basis points
      FEE_WALLET: 'inFuseD3ZaP1m8raFeDDYyAGfA3QCmy71QGsoRcfvuo',
      
      // Common Solana token mints
      MINTS: {
        SOL: 'So11111111111111111111111111111111111111112',
        USDC: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
        USDT: 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB',
        JUP: 'JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN',
      },
      
      // Jupiter Ultra API endpoints (use portal API for production)
      JUPITER_API: 'https://lite-api.jup.ag/ultra/v1',
      
      open(pool) {
        this.currentPool = pool;
        const modal = document.getElementById('execModal');
        
        // Populate pool info
        document.getElementById('execIcon1').textContent = pool.icon1;
        document.getElementById('execIcon2').textContent = pool.icon2;
        document.getElementById('execPoolName').textContent = pool.name;
        document.getElementById('execPoolStats').textContent = `APR: ${pool.apr}% | TVL: ${Utils.formatNumber(pool.tvl)}`;
        
        // Parse token info from pool name (e.g., "SOL-USDC" → SOL, USDC)
        this.parsePoolTokens(pool);
        
        // Update balance if wallet connected
        if (State.wallet.connected) {
          document.getElementById('execBalance').textContent = State.wallet.balance.toFixed(4);
          document.getElementById('execBtn').disabled = false;
          document.getElementById('execBtn').textContent = 'Get Quote from Jupiter';
        } else {
          document.getElementById('execBalance').textContent = '0.00';
          document.getElementById('execBtn').disabled = true;
          document.getElementById('execBtn').textContent = 'Connect Wallet to Deposit';
        }
        
        // Reset inputs and quote
        document.getElementById('execAmount').value = '';
        this.resetQuoteDisplay();
        
        modal.classList.add('active');
        Metrics.track('execution_opened', { pool: pool.name });
      },
      
      parsePoolTokens(pool) {
        // Extract token symbols from pool name
        const parts = pool.name.split('-');
        if (parts.length >= 2) {
          this.currentPool.tokenX = parts[0].trim().toUpperCase();
          this.currentPool.tokenY = parts[1].trim().toUpperCase();
          
          // Map common symbols to mints
          this.currentPool.mintX = this.MINTS[this.currentPool.tokenX] || null;
          this.currentPool.mintY = this.MINTS[this.currentPool.tokenY] || null;
        }
      },
      
      close() {
        document.getElementById('execModal').classList.remove('active');
        this.currentPool = null;
      },
      
      setMax() {
        if (!State.wallet.connected) return;
        const max = Math.max(0, State.wallet.balance - 0.01); // Leave some for fees
        document.getElementById('execAmount').value = max.toFixed(4);
        this.updateQuote();
      },
      
      resetQuoteDisplay() {
        document.getElementById('execDepositAmount').textContent = '0 SOL';
        document.getElementById('execPlatformFee').textContent = '0 SOL';
        document.getElementById('execLPValue').textContent = '$0.00';
        document.getElementById('execRouteInfo').textContent = 'Enter amount to see route';
      },
      
      async updateQuote() {
        const amount = parseFloat(document.getElementById('execAmount').value) || 0;
        if (amount <= 0) {
          this.resetQuoteDisplay();
          return;
        }
        
        const solPrice = State.solPrice || 185;
        const platformFee = amount * (this.PLATFORM_FEE_BPS / 10000);
        const netAmount = amount - platformFee;
        const usdValue = netAmount * solPrice;
        
        document.getElementById('execDepositAmount').textContent = `${amount.toFixed(4)} SOL`;
        document.getElementById('execPlatformFee').textContent = `${platformFee.toFixed(6)} SOL (0.1%)`;
        document.getElementById('execLPValue').textContent = `~$${usdValue.toFixed(2)}`;
        
        // Show route info based on pool tokens
        if (this.currentPool && this.currentPool.tokenX && this.currentPool.tokenY) {
          const route = `SOL → ${this.currentPool.tokenX}/${this.currentPool.tokenY} LP`;
          document.getElementById('execRouteInfo').textContent = route;
        }
      },
      
      // Get quote from Jupiter Ultra API
      async getJupiterQuote(inputMint, outputMint, amountLamports, takerAddress) {
        const url = `${this.JUPITER_API}/order?` + new URLSearchParams({
          inputMint,
          outputMint,
          amount: amountLamports.toString(),
          taker: takerAddress,
          slippageBps: '50', // 0.5% slippage
        });
        
        console.log('[Jupiter] Getting quote:', url);
        
        const response = await fetch(url);
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to get Jupiter quote');
        }
        
        return response.json();
      },
      
      // Execute signed transaction via Jupiter
      async executeJupiterSwap(signedTransaction, requestId) {
        console.log('[Jupiter] Executing swap, requestId:', requestId);
        
        const response = await fetch(`${this.JUPITER_API}/execute`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            signedTransaction,
            requestId,
          }),
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to execute swap');
        }
        
        return response.json();
      },
      
      async execute() {
        if (!State.wallet.connected) {
          WalletUI.open();
          return;
        }
        
        const amount = parseFloat(document.getElementById('execAmount').value);
        if (!amount || amount <= 0) {
          ToastUI.error('Invalid Amount', 'Please enter a deposit amount');
          return;
        }
        
        if (amount > State.wallet.balance) {
          ToastUI.error('Insufficient Balance', 'You don\'t have enough SOL');
          return;
        }
        
        const btn = document.getElementById('execBtn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.classList.add('loading');
        
        try {
          const pool = this.currentPool;
          const addr = pool.address || pool.id;
          const isDLMM = pool.protocol === 'Meteora DLMM';
          
          // Calculate amounts
          const platformFee = amount * (this.PLATFORM_FEE_BPS / 10000);
          const swapAmount = amount - platformFee;
          const amountLamports = Math.floor(swapAmount * 1e9); // SOL has 9 decimals
          
          // Check if we have mint addresses for pool tokens
          if (pool.mintX && pool.mintY) {
            btn.textContent = 'Getting Jupiter Quote...';
            
            // For LP deposits, we need to swap half to each token
            // First swap: SOL → Token X (half the amount)
            const halfAmountLamports = Math.floor(amountLamports / 2);
            
            try {
              // Get quote for first swap (SOL → TokenX)
              const quoteX = await this.getJupiterQuote(
                this.MINTS.SOL,
                pool.mintX,
                halfAmountLamports,
                State.wallet.publicKey
              );
              
              console.log('[Jupiter] Quote for TokenX:', quoteX);
              
              // In production, we would:
              // 1. Have user sign the transaction from quoteX.transaction
              // 2. Call executeJupiterSwap with signed tx
              // 3. Repeat for TokenY swap
              // 4. Bundle with Meteora deposit instruction
              
              // For now, show the quote info and redirect
              const outAmount = parseInt(quoteX.outAmount) / Math.pow(10, 9); // Assume 9 decimals
              ToastUI.info('Quote Ready', `Swap: ${(halfAmountLamports/1e9).toFixed(4)} SOL → ${outAmount.toFixed(4)} ${pool.tokenX}`);
              
              btn.textContent = 'Redirecting to Meteora...';
              
              // Track the attempt with quote data
              Metrics.track('jupiter_quote_received', {
                pool: pool.name,
                inputAmount: swapAmount,
                outputAmount: outAmount,
                route: quoteX.routePlan?.[0]?.swapInfo?.label || 'Unknown',
              });
              
            } catch (quoteError) {
              console.warn('[Jupiter] Quote failed, falling back to redirect:', quoteError);
              // Fall back to redirect if quote fails
            }
          }
          
          // Redirect to Meteora with amount context
          const meteoraUrl = isDLMM 
            ? `https://app.meteora.ag/dlmm/${addr}` 
            : `https://app.meteora.ag/pools/${addr}`;
          
          ToastUI.success('Redirecting...', 'Opening Meteora to complete deposit');
          
          Metrics.track('execution_attempted', { 
            pool: pool.name, 
            amount, 
            fee: platformFee,
            route: 'meteora_redirect'
          });
          
          setTimeout(() => {
            window.open(meteoraUrl, '_blank');
            this.close();
          }, 1500);
          
        } catch (err) {
          console.error('[Execution] Error:', err);
          ToastUI.error('Deposit Failed', err.message || 'Please try again');
        } finally {
          btn.disabled = false;
          btn.classList.remove('loading');
          btn.textContent = originalText;
        }
      },
      
      // Full Jupiter swap execution (for future wallet adapter integration)
      async executeFullSwap(inputMint, outputMint, amountLamports) {
        if (!State.wallet.connected || !State.wallet.adapter) {
          throw new Error('Wallet not connected');
        }
        
        // Step 1: Get order from Jupiter
        const order = await this.getJupiterQuote(
          inputMint,
          outputMint,
          amountLamports,
          State.wallet.publicKey
        );
        
        if (!order.transaction) {
          throw new Error('No transaction returned from Jupiter');
        }
        
        // Step 2: Sign the transaction
        // The transaction is base64 encoded, need to decode and sign
        const txBuffer = Uint8Array.from(atob(order.transaction), c => c.charCodeAt(0));
        
        // With Phantom/Solflare wallet adapter:
        // const signedTx = await State.wallet.adapter.signTransaction(txBuffer);
        // const signedTxBase64 = btoa(String.fromCharCode(...signedTx));
        
        // Step 3: Execute via Jupiter
        // const result = await this.executeJupiterSwap(signedTxBase64, order.requestId);
        
        // Step 4: Return transaction signature
        // return result.signature;
        
        console.log('[Jupiter] Full swap would execute here with wallet adapter');
        return null;
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // METRICS TRACKING - Analytics for monetization decisions
    // ═══════════════════════════════════════════════════════════════════════════
    const Metrics = {
      data: {
        sessionStart: Date.now(),
        pageViews: 0,
        poolClicks: 0,
        opportunityViews: 0,
        expandedPools: [],
        executionAttempts: 0,
        events: []
      },
      
      init() {
        this.data.pageViews = parseInt(localStorage.getItem('lp_total_views') || '0') + 1;
        localStorage.setItem('lp_total_views', this.data.pageViews);
        
        // Update display
        this.updateDisplay();
        
        // Update session timer
        setInterval(() => this.updateSession(), 60000);
        
        // Track on unload
        window.addEventListener('beforeunload', () => this.save());
      },
      
      track(event, data = {}) {
        const entry = {
          event,
          data,
          timestamp: Date.now()
        };
        this.data.events.push(entry);
        
        // Update specific counters
        if (event === 'pool_clicked') this.data.poolClicks++;
        if (event === 'pool_expanded') this.data.expandedPools.push(data.pool);
        if (event.includes('execution')) this.data.executionAttempts++;
        
        this.updateDisplay();
        
        // In production, send to analytics backend
        console.log('📊 Metric:', event, data);
      },
      
      updateDisplay() {
        const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        setEl('metricViews', this.data.pageViews);
        setEl('metricClicks', this.data.poolClicks);
        setEl('metricOpps', State.opportunities?.length || 0);
      },
      
      updateSession() {
        const mins = Math.floor((Date.now() - this.data.sessionStart) / 60000);
        const el = document.getElementById('metricSession');
        if (el) el.textContent = `${mins}m`;
      },
      
      save() {
        localStorage.setItem('lp_metrics', JSON.stringify(this.data));
      },
      
      getReport() {
        return {
  ...this.data,
  sessionDuration: Date.now() - this.data.sessionStart,
  mostViewedPools: [...new Set(this.data.expandedPools)]

            .map(p => ({ pool: p, views: this.data.expandedPools.filter(x => x === p).length }))
            .sort((a, b) => b.views - a.views)
            .slice(0, 10)
        };
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // WALLET UI
    // ═══════════════════════════════════════════════════════════════════════════
    const WalletUI = {
      open() {
        const modal = document.getElementById('walletModal');
        document.getElementById('modalTitle').textContent = State.wallet.connected ? 'Wallet Connected' : 'Connect Wallet';
        document.getElementById('modalBody').innerHTML = State.wallet.connected ? this.renderConnected() : this.renderList();
        modal.classList.add('visible');
      },
      close() { document.getElementById('walletModal').classList.remove('visible'); },
      renderList() {
        return `<div class="wallet-list">${Object.entries(WALLETS).map(([k, w]) => {
          const detected = !!w.getProvider?.();
          return `<div class="wallet-option ${detected ? 'detected' : ''}" onclick="WalletService.connect('${k}')">
            <div class="wallet-option-icon"><img src="${w.icon}" alt="${w.name}"></div>
            <div class="wallet-option-info"><div class="wallet-option-name">${w.name}</div><div class="wallet-option-desc">${detected ? 'Click to connect' : 'Install wallet'}</div></div>
            ${detected ? '<span class="wallet-detected-badge">Detected</span>' : ''}
          </div>`;
        }).join('')}</div>`;
      },
      renderConnected() {
        const a = State.wallet.publicKey;
        return `<div class="connected-wallet">
          <div class="connected-wallet-header"><div class="connected-wallet-avatar"></div><div class="connected-wallet-info"><div class="connected-wallet-label">Connected</div><div class="connected-wallet-address">${Utils.shortenAddress(a, 6)}</div></div></div>
          <div class="connected-wallet-stats"><div class="connected-wallet-stat"><div class="connected-wallet-stat-value">${State.wallet.balance.toFixed(4)} SOL</div><div class="connected-wallet-stat-label">Balance</div></div><div class="connected-wallet-stat"><div class="connected-wallet-stat-value">${Utils.formatNumber(State.wallet.balance * 185)}</div><div class="connected-wallet-stat-label">USD</div></div></div>
          <div class="connected-wallet-actions"><button class="btn btn--secondary" onclick="WalletService.copy()">Copy</button><button class="btn btn--secondary" onclick="window.open('https://solscan.io/account/${a}','_blank')">Explorer</button><button class="btn btn--ghost" onclick="WalletService.disconnect()" style="color:var(--accent-rose)">Disconnect</button></div>
        </div>`;
      },
      update() {
        const btn = document.getElementById('walletBtn'), txt = document.getElementById('walletBtnText');
        if (State.wallet.connected) { btn.classList.add('connected'); txt.innerHTML = `<span style="display:flex;align-items:center;gap:6px"><span style="width:6px;height:6px;background:var(--accent-emerald);border-radius:50%"></span>${Utils.shortenAddress(State.wallet.publicKey, 4)}</span>`; }
        else { btn.classList.remove('connected'); txt.textContent = 'Connect Wallet'; }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // WALLET SERVICE
    // ═══════════════════════════════════════════════════════════════════════════
    const WalletService = {
      async connect(key) {
        const w = WALLETS[key], p = w?.getProvider?.();
        if (!p) { window.open(w.downloadUrl, '_blank'); ToastUI.error('Not Found', `Install ${w.name}`); return; }
        try {
          const r = await p.connect();
          State.wallet = { connected: true, publicKey: r.publicKey?.toString() || p.publicKey?.toString(), provider: p, name: key, balance: 0 };
          await this.fetchBalance();
          WalletUI.update(); WalletUI.close();
          p.on?.('disconnect', () => this.handleDisconnect());
          ToastUI.success('Connected', Utils.shortenAddress(State.wallet.publicKey));
        } catch (e) { ToastUI.error('Failed', e.message || 'Rejected'); }
      },
      async fetchBalance() {
        if (!State.wallet.publicKey) return;
        try {
          const r = await fetch(CONFIG.HELIUS_RPC, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getBalance', params: [State.wallet.publicKey] }) });
          const d = await r.json();
          if (d.result?.value !== undefined) State.wallet.balance = d.result.value / 1e9;
        } catch (e) { console.warn('Balance fetch error:', e); }
      },
      disconnect() { State.wallet.provider?.disconnect?.().catch(() => {}); this.handleDisconnect(); },
      handleDisconnect() { State.wallet = { connected: false, publicKey: null, provider: null, name: null, balance: 0 }; WalletUI.update(); WalletUI.close(); ToastUI.success('Disconnected', 'Wallet disconnected'); },
      copy() { if (State.wallet.publicKey) { navigator.clipboard.writeText(State.wallet.publicKey); ToastUI.success('Copied', 'Address copied'); } },
      async autoConnect() {
        const p = window.phantom?.solana;
        if (p?.isConnected) { try { const r = await p.connect({ onlyIfTrusted: true }); if (r.publicKey) { State.wallet = { connected: true, publicKey: r.publicKey.toString(), provider: p, name: 'phantom', balance: 0 }; await this.fetchBalance(); WalletUI.update(); } } catch (e) {} }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // LIQUIDITY CHART UI
    // ═══════════════════════════════════════════════════════════════════════════
    const LiquidityChartUI = {
      render(pool) {
        if (!pool.bins || pool.bins.length === 0) return '';
        const maxL = Math.max(...pool.bins.map(b => b.liquidity));
        const totL = pool.bins.reduce((s, b) => s + b.liquidity, 0);
        const bins = pool.bins.map((b, i) => `
          <div class="bin ${i === pool.activeBin ? 'active-bin' : ''}" style="height:${(b.liquidity / maxL) * 100}%">
            <div class="bin-tooltip">
              <div class="bin-tooltip-row"><span class="bin-tooltip-label">Price</span><span class="bin-tooltip-value">$${Utils.formatPrice(b.price)}</span></div>
              <div class="bin-tooltip-row"><span class="bin-tooltip-label">Liq</span><span class="bin-tooltip-value">${((b.liquidity / totL) * 100).toFixed(1)}%</span></div>
              <div class="bin-tooltip-row"><span class="bin-tooltip-label">Bin</span><span class="bin-tooltip-value">#${b.id}</span></div>
            </div>
          </div>`).join('');
        return `
          <div class="chart-section">
            <div class="chart-header">
              <span class="chart-title">Liquidity Distribution (21 Bins)</span>
              <div class="chart-legend"><div class="legend-item"><div class="legend-dot liquidity"></div>Liquidity</div><div class="legend-item"><div class="legend-dot active"></div>Active Bin</div></div>
            </div>
            <div class="bins-container">${bins}</div>
            <div class="chart-axis">
              <span class="axis-label">$${Utils.formatPrice(pool.bins[0].price)}</span>
              <span class="axis-label active">$${Utils.formatPrice(pool.bins[pool.activeBin]?.price || pool.currentPrice)}</span>
              <span class="axis-label">$${Utils.formatPrice(pool.bins[20]?.price || pool.bins[pool.bins.length-1]?.price)}</span>
            </div>
          </div>`;
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // POOL TRANSACTIONS UI
    // ═══════════════════════════════════════════════════════════════════════════
    const PoolTxUI = {
      render(poolId) {
        return `
          <div class="pool-tx-section">
            <div class="pool-tx-header">
              <span class="pool-tx-title"><span class="status-dot ${State.wsConnected ? 'live' : ''}"></span>Live Transactions</span>
            </div>
            <div class="pool-tx-list" id="tx-list-${poolId}">${this.renderList(poolId, false)}</div>
          </div>`;
      },
      renderList(poolId, animated = false) {
        const txs = State.poolTransactions[poolId] || [];
        if (txs.length === 0) return '<div class="pool-tx-empty">Waiting for transactions...</div>';
        const icons = { add: '+', remove: '-', swap: '⇄' };
        return txs.map((tx, i) => `
          <div class="pool-tx-item ${animated && i === 0 ? 'new-tx' : ''}">
            <div class="pool-tx-type ${tx.type}">${icons[tx.type]}</div>
            <div class="pool-tx-info"><a href="https://solscan.io/tx/${tx.signature}" target="_blank">${Utils.truncate(tx.signature)}</a></div>
            <div class="pool-tx-amount ${tx.type === 'add' ? 'positive' : tx.type === 'remove' ? 'negative' : ''}">${Utils.formatNumber(parseFloat(tx.amount))}</div>
            <div class="pool-tx-time">${Utils.formatTime(tx.timestamp)}</div>
          </div>`).join('');
      },
      addNewTx(poolId, tx) {
        const el = document.getElementById(`tx-list-${poolId}`);
        if (!el) return;
        
        // Remove "waiting" message if present
        const empty = el.querySelector('.pool-tx-empty');
        if (empty) empty.remove();
        
        // Create new transaction element
        const icons = { add: '+', remove: '-', swap: '⇄' };
        const newItem = document.createElement('div');
        newItem.className = `pool-tx-item new-tx`;
        newItem.innerHTML = `
          <div class="pool-tx-type ${tx.type}">${icons[tx.type]}</div>
          <div class="pool-tx-info"><a href="https://solscan.io/tx/${tx.signature}" target="_blank">${Utils.truncate(tx.signature)}</a></div>
          <div class="pool-tx-amount ${tx.type === 'add' ? 'positive' : tx.type === 'remove' ? 'negative' : ''}">${Utils.formatNumber(parseFloat(tx.amount))}</div>
          <div class="pool-tx-time">${Utils.formatTime(tx.timestamp)}</div>`;
        
        // Insert at top
        el.insertBefore(newItem, el.firstChild);
        
        // Remove animation class after it plays
        setTimeout(() => newItem.classList.remove('new-tx'), 300);
        
        // Limit visible items
        while (el.children.length > 15) {
          el.removeChild(el.lastChild);
        }
      },
      update(poolId) {
        const el = document.getElementById(`tx-list-${poolId}`);
        if (el) el.innerHTML = this.renderList(poolId, false);
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // POOL CARD UI
    // ═══════════════════════════════════════════════════════════════════════════
    const PoolCardUI = {
      render(pool, rank) {
        const sc = pool.score >= 75 ? 'high' : pool.score >= 55 ? 'medium' : 'low';
        const isExp = State.expandedPoolId === pool.id;
        const addr = pool.address || pool.id;
        
        // Determine correct Meteora URL based on pool type
        const isDLMM = pool.protocol === 'Meteora DLMM';
        const meteoraUrl = isDLMM 
          ? `https://app.meteora.ag/dlmm/${addr}` 
          : `https://app.meteora.ag/pools/${addr}`;
        
        // Pool type short label
        const typeLabel = isDLMM ? 'DLMM' : 'DAMM';
        
        // Only show farm badge on collapsed view (bin step shown in details)
        const farmBadge = pool.farmActive ? '<span class="mini-badge farm">🌾 Active</span>' : 
                         pool.hasFarm ? '<span class="mini-badge farm">🌾 Farm</span>' : '';
        
        return `
          <div class="pool-card score-${sc} ${isExp ? 'expanded' : ''} ${pool.isHot ? 'is-hot' : ''}" id="pool-${pool.id}">
            <div class="pool-rank ${rank <= 3 ? 'top3' : ''}">${rank}</div>
            ${pool.isHot ? '<div class="hot-indicator">🔥</div>' : ''}
            <div class="pool-card-main" onclick="PoolCardUI.toggle('${pool.id}')">
              <div class="pool-header">
                <div class="pool-pair">
                  <div class="pool-icons"><div class="pool-icon">${pool.icon1}</div><div class="pool-icon">${pool.icon2}</div></div>
                  <div class="pool-info">
                    <h3>${pool.name}<span class="pool-type-badge">${typeLabel}</span></h3>
                  </div>
                </div>
                <div class="pool-badges">
                  <span class="score-badge ${sc}">${pool.score}</span>
                  <span class="safety-dot ${pool.safety}" title="${pool.safety}"></span>
                </div>
              </div>
              <div class="pool-stats">
                <div class="pool-stat"><div class="pool-stat-label">TVL</div><div class="pool-stat-value">${Utils.formatNumber(pool.tvl)}</div></div>
                <div class="pool-stat"><div class="pool-stat-label">Vol 24h</div><div class="pool-stat-value">${Utils.formatNumber(pool.volume)}</div></div>
                <div class="pool-stat"><div class="pool-stat-label">APR</div><div class="pool-stat-value accent">${pool.apr}%</div></div>
                <div class="pool-stat ${pool.fees1h > 0 ? 'has-1h' : ''}"><div class="pool-stat-label">${pool.fees1h > 0 ? 'Fees 1h' : 'Fees 24h'}</div><div class="pool-stat-value">${pool.fees1h > 0 ? Utils.formatNumber(pool.fees1h) : Utils.formatNumber(pool.fees)}</div></div>
              </div>
              ${farmBadge || pool.isHot ? `<div class="pool-badges-row">${pool.isHot ? '<span class="mini-badge hot">🔥 Hot</span>' : ''}${farmBadge}</div>` : ''}
              <div class="pool-expand-hint">Click to expand</div>
            </div>
            <div class="pool-expanded">
              <div class="pool-expanded-inner">
                <div class="pool-actions">
                  <button class="pool-action-btn primary" onclick="ExecutionLayer.open(State.pools.find(p=>p.id==='${pool.id}'))">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg>
                    Quick Deposit
                  </button>
                  <a href="${meteoraUrl}" target="_blank" class="pool-action-btn" onclick="Metrics.track('pool_clicked',{pool:'${pool.name}'})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    Meteora
                  </a>
                  <a href="https://solscan.io/account/${addr}" target="_blank" class="pool-action-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    Solscan
                  </a>
                  <button class="pool-action-btn" onclick="PoolCardUI.copyAddress('${addr}')">
                    ${Utils.copyIcon}
                    Copy
                  </button>
                </div>
                ${LiquidityChartUI.render(pool)}
                ${PoolTxUI.render(pool.id)}
                ${this.renderAdvancedInfo(pool)}
              </div>
            </div>
          </div>`;
      },
      
      renderAdvancedInfo(pool) {
        const items = [];
        
        // Short-term metrics first (most actionable)
        if (pool.fees1h > 0) items.push(`<div class="adv-item highlight"><span>Fees 1h:</span> ${Utils.formatNumber(pool.fees1h)}</div>`);
        if (pool.fees1h > 0 && pool.fees > 0) {
          const projected = pool.fees1h * 24;
          const vs24h = ((projected / pool.fees - 1) * 100).toFixed(0);
          items.push(`<div class="adv-item ${vs24h > 0 ? 'highlight' : ''}"><span>Projected 24h:</span> ${Utils.formatNumber(projected)} (${vs24h > 0 ? '+' : ''}${vs24h}%)</div>`);
        }
        if (pool.feeTvlRatio1h > 0) items.push(`<div class="adv-item highlight"><span>Fee/TVL 1h:</span> ${(pool.feeTvlRatio1h * 100).toFixed(4)}%</div>`);
        
        // Standard metrics
        if (pool.fees > 0) items.push(`<div class="adv-item"><span>Fees 24h:</span> ${Utils.formatNumber(pool.fees)}</div>`);
        if (pool.feeBps) items.push(`<div class="adv-item"><span>Base Fee:</span> ${pool.feeBps}%</div>`);
        if (pool.binStep > 1) items.push(`<div class="adv-item"><span>Bin Step:</span> ${pool.binStep}</div>`);
        if (pool.farmApr && parseFloat(pool.farmApr) > 0) items.push(`<div class="adv-item"><span>Farm APR:</span> +${pool.farmApr}%</div>`);
        if (pool.feeTvlRatio > 0) items.push(`<div class="adv-item"><span>Fee/TVL 24h:</span> ${(pool.feeTvlRatio * 100).toFixed(3)}%</div>`);
        if (pool.volumeToTvl > 0) items.push(`<div class="adv-item"><span>Vol/TVL:</span> ${(pool.volumeToTvl * 100).toFixed(0)}%</div>`);
        if (pool.cumulativeTradeVolume > 0) items.push(`<div class="adv-item"><span>All-time Vol:</span> ${Utils.formatNumber(pool.cumulativeTradeVolume)}</div>`);
        
        if (items.length === 0) return '';
        
        return `
          <div class="pool-advanced-info">
            <h4>Details</h4>
            <div class="advanced-grid">${items.join('')}</div>
          </div>`;
      },
      
      toggle(poolId) {
        // Close previously expanded pool card
        if (State.expandedPoolId && State.expandedPoolId !== poolId) {
          const prev = document.getElementById(`pool-${State.expandedPoolId}`);
          if (prev) prev.classList.remove('expanded');
        }
        // Close any expanded opportunity card
        if (State.expandedOppId) {
          const prevOpp = document.getElementById(`opp-${State.expandedOppId}`);
          if (prevOpp) prevOpp.classList.remove('expanded');
          State.expandedOppId = null;
        }
        // Toggle current
        const card = document.getElementById(`pool-${poolId}`);
        if (!card) return;
        if (State.expandedPoolId === poolId) {
          card.classList.remove('expanded');
          State.expandedPoolId = null;
        } else {
          card.classList.add('expanded');
          State.expandedPoolId = poolId;
          // Track expansion
          const pool = State.filteredPools.find(p => p.id === poolId);
          if (pool) Metrics.track('pool_expanded', { pool: pool.name });
        }
      },
      
      copyAddress(addr) {
        navigator.clipboard.writeText(addr);
        ToastUI.success('Copied', 'Pool address copied');
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // POOLS GRID UI
    // ═══════════════════════════════════════════════════════════════════════════
    const PoolsGridUI = {
  render() {
    const container = document.getElementById('poolsContainer');
    if (!container) return;

    if (State.filteredPools.length === 0) {
      poolsContainer.insertAdjacentHTML("beforeend", cardHTML);
        '<div class="alert-empty" style="text-align:center;padding:40px;column-span:all">' +
        '<div class="loading-spinner"></div>' +
        '<p style="margin-top:12px">Loading pools...</p></div>';
      return;
    }

    let columnCount = parseInt(
  getComputedStyle(container).columnCount,
  10
);

if (!columnCount || columnCount === 1) {
  if (window.innerWidth >= 1400) columnCount = 4;
  else if (window.innerWidth >= 1100) columnCount = 3;
  else if (window.innerWidth >= 768) columnCount = 2;
  else columnCount = 1;
}


    const layoutcolumnCount = getComputedStyle(container)
  .columnCount || 1;



    container.innerHTML = reordered
  .map((p, i) => PoolCardUI.render(p, i + 1))
  .join('');


  }
};


    // ═══════════════════════════════════════════════════════════════════════════
    // OPPORTUNITY CARD UI - EXPANDABLE WITH CHARTS
    // ═══════════════════════════════════════════════════════════════════════════
    const OppCardUI = {
      render(opp) {
        const isExp = State.expandedOppId === opp.id;
        const addr = opp.address || opp.id;
        const isDLMM = opp.protocol === 'Meteora DLMM';
        const meteoraUrl = isDLMM 
          ? `https://app.meteora.ag/dlmm/${addr}` 
          : `https://app.meteora.ag/pools/${addr}`;
        const typeLabel = isDLMM ? 'DLMM' : 'DAMM';
        const oppTypeClass = opp.oppType ? `opp-${opp.oppType}` : 'opp-standard';
        
        return `
          <div class="opp-card ${oppTypeClass} ${isExp ? 'expanded' : ''}" id="opp-${opp.id}">
            <div class="opp-card-main" onclick="OppCardUI.toggle('${opp.id}')">
              <div class="opp-header">
                <div class="opp-pool">
                  <div class="opp-pool-icons"><div class="opp-pool-icon">${opp.icon1}</div><div class="opp-pool-icon">${opp.icon2}</div></div>
                  <div class="opp-pool-info"><h3>${opp.name}<span class="pool-type-badge">${typeLabel}</span></h3></div>
                </div>
                <div class="opp-score"><div class="opp-score-value">${opp.score}</div><div class="opp-score-label">Score</div></div>
              </div>
              <div class="opp-metrics">
                <div class="opp-metric"><div class="opp-metric-value">${Utils.formatNumber(opp.tvl)}</div><div class="opp-metric-label">TVL</div></div>
                <div class="opp-metric"><div class="opp-metric-value">${Utils.formatNumber(opp.volume)}</div><div class="opp-metric-label">Volume</div></div>
                <div class="opp-metric"><div class="opp-metric-value positive">${opp.apr}%</div><div class="opp-metric-label">APR</div></div>
                <div class="opp-metric"><div class="opp-metric-value">${(opp.volumeToTvl * 100).toFixed(0)}%</div><div class="opp-metric-label">Vol/TVL</div></div>
              </div>
              <div class="opp-reason"><div class="opp-reason-title">${opp.oppType === 'hot' ? '🔥' : opp.oppType === 'active' ? '⚡' : '💡'} Opportunity</div><div class="opp-reason-text">${opp.reason}</div></div>
              <div class="opp-expand-hint">Click to expand</div>
            </div>
            <div class="opp-expanded">
              <div class="opp-expanded-inner">
                <div class="pool-actions">
                  <button class="pool-action-btn primary" onclick="ExecutionLayer.open(State.opportunities.find(p=>p.id==='${opp.id}'))">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg>
                    Quick Deposit
                  </button>
                  <a href="${meteoraUrl}" target="_blank" class="pool-action-btn" onclick="Metrics.track('opp_clicked',{pool:'${opp.name}'})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    Meteora
                  </a>
                  <a href="https://solscan.io/account/${addr}" target="_blank" class="pool-action-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    Solscan
                  </a>
                  <button class="pool-action-btn" onclick="OppCardUI.copyAddress('${addr}')">
                    ${Utils.copyIcon}
                    Copy
                  </button>
                </div>
                ${LiquidityChartUI.render(opp)}
                ${PoolTxUI.render(opp.id)}
              </div>
            </div>
          </div>`;
      },
      toggle(oppId) {
        // Close previously expanded opportunity card
        if (State.expandedOppId && State.expandedOppId !== oppId) {
          const prev = document.getElementById(`opp-${State.expandedOppId}`);
          if (prev) prev.classList.remove('expanded');
        }
        // Close any expanded pool card
        if (State.expandedPoolId) {
          const prevPool = document.getElementById(`pool-${State.expandedPoolId}`);
          if (prevPool) prevPool.classList.remove('expanded');
          State.expandedPoolId = null;
        }
        // Toggle current
        const card = document.getElementById(`opp-${oppId}`);
        if (!card) return;
        if (State.expandedOppId === oppId) {
          card.classList.remove('expanded');
          State.expandedOppId = null;
        } else {
          card.classList.add('expanded');
          State.expandedOppId = oppId;
        }
      },
      
      copyAddress(addr) {
        navigator.clipboard.writeText(addr);
        ToastUI.success('Copied', 'Pool address copied');
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // OPPORTUNITIES UI
    // ═══════════════════════════════════════════════════════════════════════════
    const OpportunityUI = {
      render() {
        const list = document.getElementById('opportunitiesList');
        if (!list) return;
        if (State.opportunities.length === 0) {
          list.innerHTML = '<div class="alert-empty">No high-probability opportunities detected. Adjust filters or wait for market conditions to change.</div>';
          return;
        }
        container.innerHTML = reordered
  .map((o) => OppCardUI.render(o))
  .join('');

      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // ALERTS UI
    // ═══════════════════════════════════════════════════════════════════════════
    const AlertsUI = {
      populateDropdown() {
        const sel = document.getElementById('alertPool');
        if (sel && State.filteredPools.length > 0) sel.innerHTML = State.filteredPools.slice(0, 40).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      },
      add() {
        const poolId = document.getElementById('alertPool')?.value, cond = document.getElementById('alertCondition')?.value, val = parseFloat(document.getElementById('alertValue')?.value);
        if (!poolId || !cond || isNaN(val)) return;
        const pool = State.pools.find(p => p.id === poolId);
        State.alerts.push({ id: Date.now(), poolId, poolName: pool?.name || 'Unknown', condition: cond, value: val, active: true });
        document.getElementById('alertValue').value = '';
        this.render();
        ToastUI.success('Alert Added', `${pool?.name || 'Pool'} alert created`);
      },
      addForAll() {
        const cond = document.getElementById('alertCondition')?.value, val = parseFloat(document.getElementById('alertValue')?.value);
        if (!cond || isNaN(val)) { ToastUI.error('Missing Value', 'Enter a value'); return; }
        let count = 0;
        State.filteredPools.slice(0, 20).forEach(p => { if (!State.alerts.find(a => a.poolId === p.id && a.condition === cond)) { State.alerts.push({ id: Date.now() + Math.random(), poolId: p.id, poolName: p.name, condition: cond, value: val, active: true }); count++; } });
        this.render();
        ToastUI.success('Alerts Added', `${count} alerts created`);
      },
      toggle(id, e) { if (e) e.stopPropagation(); const a = State.alerts.find(x => x.id === id); if (a) a.active = !a.active; this.render(); },
      remove(id, e) { if (e) e.stopPropagation(); State.alerts = State.alerts.filter(x => x.id !== id); this.render(); },
      clearAll() { State.alerts = []; this.render(); ToastUI.success('Cleared', 'All alerts removed'); },
      render() {
        const list = document.getElementById('alertList');
        if (!list) return;
        if (State.alerts.length === 0) { list.innerHTML = '<div class="alert-empty">No alerts configured.</div>'; return; }
        list.innerHTML = State.alerts.map(a => `<div class="alert-item"><div class="alert-info"><div class="alert-icon ${a.condition.includes('above') ? 'up' : 'down'}">${a.condition.includes('above') ? '↑' : '↓'}</div><div class="alert-details"><h4>${a.poolName}</h4><p>${a.condition.replace('-', ' ')} ${a.condition.includes('tvl') ? Utils.formatNumber(a.value) : '$' + a.value}</p></div></div><div class="alert-actions"><button class="toggle ${a.active ? 'active' : ''}" onclick="AlertsUI.toggle(${a.id},event)"></button><button class="btn btn--ghost" onclick="AlertsUI.remove(${a.id},event)">✕</button></div></div>`).join('');
      },
      refreshAI() {
        // Prioritize short-term opportunities (hot pools, high 1h fees)
        State.aiSuggestions = State.filteredPools
          .filter(p => p.safety === 'safe' && (p.isHot || p.fees1h > 0 || p.volumeToTvl > 0.4 || parseFloat(p.apr) > 50))
          .slice(0, 5)
          .map(p => {
            let reason, condition, value;
            if (p.isHot) {
              reason = `🔥 FEE SPIKE: 1h fees ${Utils.formatNumber(p.fees1h)} - high short-term opportunity`;
              condition = 'fees1h-above';
              value = (p.fees1h * 0.8).toFixed(2);
            } else if (p.fees1h > 0 && p.tvl > 0 && (p.fees1h / p.tvl) > 0.0005) {
              reason = `⚡ Active pool: ${Utils.formatNumber(p.fees1h)} fees in 1h`;
              condition = 'fees1h-above';
              value = (p.fees1h * 0.5).toFixed(2);
            } else if (p.volumeToTvl > 0.4) {
              reason = `📈 High volume: ${(p.volumeToTvl * 100).toFixed(0)}% vol/TVL ratio`;
              condition = 'volume-above';
              value = (p.volume * 0.8).toFixed(0);
            } else {
              reason = `💰 Strong ${p.apr}% APR`;
              condition = 'apr-above';
              value = (parseFloat(p.apr) * 0.9).toFixed(0);
            }
            return { pool: p, reason, condition, value };
          });
        this.renderAI();
      },
      renderAI() {
        const c = document.getElementById('aiSuggestions');
        if (!c) return;
        if (State.aiSuggestions.length === 0) { c.innerHTML = '<div style="text-align:center;padding:12px;color:var(--text-muted);font-size:11px">Click Refresh for short-term opportunity alerts.</div>'; return; }
        c.innerHTML = State.aiSuggestions.map(s => `<div class="ai-suggestion"><div class="ai-suggestion-info"><div class="ai-suggestion-pool">${s.pool.name}</div><div class="ai-suggestion-reason">${s.reason}</div></div><div class="ai-suggestion-actions"><button class="btn btn--success" onclick="AlertsUI.acceptAI('${s.pool.id}','${s.condition}',${s.value})">Add Alert</button><button class="btn btn--ghost" onclick="this.parentElement.parentElement.remove()">✕</button></div></div>`).join('');
      },
      acceptAI(poolId, cond, val) {
        const pool = State.pools.find(p => p.id === poolId);
        if (pool && !State.alerts.find(a => a.poolId === poolId && a.condition === cond)) { State.alerts.push({ id: Date.now(), poolId, poolName: pool.name, condition: cond, value: val, active: true }); this.render(); ToastUI.success('Added', `${pool.name} alert created`); }
        State.aiSuggestions = State.aiSuggestions.filter(s => s.pool.id !== poolId);
        this.renderAI();
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // DATA SERVICE
    // ═══════════════════════════════════════════════════════════════════════════
    const DataService = {
      async fetchJupiter() {
        try {
          const r = await fetch(CONFIG.JUPITER_TOKENS);
          if (!r.ok) throw new Error('Jupiter API failed');
          const tokens = await r.json();
          // Handle both array format and object with tokens property
          const tokenList = Array.isArray(tokens) ? tokens : (tokens.tokens || []);
          tokenList.forEach(t => State.verifiedTokens.add(t.address || t.mint));
          StatusUI.setApi('jupiter', true);
          console.log(`Loaded ${State.verifiedTokens.size} verified tokens from Jupiter`);
        } catch (e) {
          console.warn('Jupiter fallback:', e.message);
          StatusUI.setApi('jupiter', false);
          // Fallback common verified tokens
          ['So11111111111111111111111111111111111111112', 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB', 'JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN', 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263'].forEach(t => State.verifiedTokens.add(t));
        }
      },
      
      async fetchPools() {
        let pools = [];

        try {
          StatusUI.set('loading', 'Fetching pools from multiple sources...');
          
          // Fetch BOTH DLMM and DAMM v2 in parallel
          const [dlmmResult, dammResult] = await Promise.allSettled([
            fetch('https://dlmm-api.meteora.ag/pair/all').then(r => {
              if (!r.ok) throw new Error(`DLMM HTTP ${r.status}`);
              return r.json();
            }),
            fetch('https://dammv2-api.meteora.ag/pools?limit=200&order_by=tvl&order=desc').then(r => {
              if (!r.ok) throw new Error(`DAMM v2 HTTP ${r.status}`);
              return r.json();
            })
          ]);
          
          let allPools = [];
          const seenAddresses = new Set();
          let sources = [];
          
          // Process DLMM pools (priority - has bin_step, farm_apr, timeframe data)
          if (dlmmResult.status === 'fulfilled' && Array.isArray(dlmmResult.value)) {
            const dlmmPools = dlmmResult.value
              .filter(p => p.name && p.address && !p.hide && !p.is_blacklisted && parseFloat(p.liquidity || 0) > 100)
              .map(p => this.processDLMM(p));
            
            dlmmPools.forEach(p => {
              if (!seenAddresses.has(p.address)) {
                seenAddresses.add(p.address);
                allPools.push(p);
              }
            });
            sources.push(`DLMM: ${dlmmPools.length}`);
            console.log(`✓ Loaded ${dlmmPools.length} pools from DLMM API`);
          } else {
            console.warn('✗ DLMM API failed:', dlmmResult.reason || 'Unknown error');
          }
          
          // Process DAMM v2 pools (adds unique pools not in DLMM)
          if (dammResult.status === 'fulfilled' && dammResult.value?.data) {
            const dammPools = dammResult.value.data
              .filter(p => p.pool_address && (p.tvl || 0) > 100)
              .map(p => this.processDAMMv2(p));
            
            let addedCount = 0;
            dammPools.forEach(p => {
              if (!seenAddresses.has(p.address)) {
                seenAddresses.add(p.address);
                allPools.push(p);
                addedCount++;
              }
            });
            sources.push(`DAMM v2: +${addedCount}`);
            console.log(`✓ Added ${addedCount} unique pools from DAMM v2 API`);
          } else {
            console.warn('✗ DAMM v2 API failed:', dammResult.reason || 'Unknown error');
          }
          
          // If both failed, try fallbacks
          if (allPools.length === 0) {
          console.warn('Both Meteora APIs failed, trying fallbacks...');
          StatusUI.setApi('meteora', false);
          
          // Try DexScreener
          try {
            const dxr = await fetch('https://api.dexscreener.com/latest/dex/search?q=meteora');
            if (dxr.ok) {
              const dxData = await dxr.json();
              if (dxData.pairs?.length > 0) {
                allPools = dxData.pairs
                  .filter(p => p.dexId === 'meteora' && p.liquidity?.usd > 100)
                  .slice(0, 150)
                  .map(p => this.processDexScreener(p));
                sources.push(`DexScreener (${allPools.length})`);
              }
            }
          } catch (dx) { console.warn('DexScreener failed:', dx); }
          
          // Try GeckoTerminal if still empty
          if (allPools.length === 0) {
            try {
              const gtr = await fetch('https://api.geckoterminal.com/api/v2/networks/solana/dexes/meteora-dlmm/pools?page=1');
              if (gtr.ok) {
                const gtData = await gtr.json();
                if (gtData.data?.length > 0) {
                  allPools = gtData.data
                    .filter(p => parseFloat(p.attributes?.reserve_in_usd || 0) > 100)
                    .slice(0, 150)
                    .map(p => this.processGeckoTerminal(p));
                  sources.push(`GeckoTerminal (${allPools.length})`);
                }
              }
            } catch (gt) { console.warn('GeckoTerminal failed:', gt); }
          }
        }
        
        if (allPools.length === 0) {
          StatusUI.set('error', 'All sources failed - retrying in 30s');
          return;
        }
        
        // Sort by score and limit
        const sorted = pools.sort((a, b) => b.score - a.score);
const poolcolumnCount = getComputedStyle(container).columnCount || 3;
const ordered = reorderForCssColumns(sorted, Number(columnCount));


        
        StatusUI.setApi('meteora', true);
        this.applyFilters();
        this.detectOpportunities();
        
        // Show pool count with source breakdown
        const dlmmCount = State.pools.filter(p => p.protocol === 'Meteora DLMM').length;
        const dammCount = State.pools.filter(p => p.protocol === 'Meteora DAMM v2').length;
        const sourceInfo = sources.length > 0 ? ` [${sources.join(' | ')}]` : '';
        StatusUI.set('live', `${State.filteredPools.length} pools${sourceInfo}`);
        console.log(`✓ Total: ${State.pools.length} pools (DLMM: ${dlmmCount}, DAMM v2: ${dammCount})`);
        
      } catch (err) {
        console.error('fetchPools error:', err);
        StatusUI.set('error', 'Error loading pools - retrying...');
        setTimeout(() => this.fetchPools(), 10000);
      }
      },
      
      processDexScreener(p) {
        const xV = State.verifiedTokens.has(p.baseToken?.address || '');
        const yV = State.verifiedTokens.has(p.quoteToken?.address || '');
        let safety = 'warning';
        if (xV && yV) safety = 'safe';
        else if (!xV && !yV && (p.liquidity?.usd || 0) < 10000) safety = 'danger';
        let score = 50;
        const tvl = p.liquidity?.usd || 0, vol = p.volume?.h24 || 0;
        if (tvl > 500000) score += 20; else if (tvl > 100000) score += 15; else if (tvl > 10000) score += 10;
        if (vol > 100000) score += 15; else if (vol > 10000) score += 10; else if (vol > 1000) score += 5;
        const apr = tvl > 0 ? (vol / tvl * 365 * 0.003 * 100) : 0;
        if (apr > 100) score += 10; else if (apr > 50) score += 7; else if (apr > 20) score += 4;
        if (safety === 'safe') score += 5; else if (safety === 'danger') score -= 15;
        score = Math.min(99, Math.max(10, Math.round(score)));
        return {
          id: p.pairAddress, address: p.pairAddress,
          name: `${p.baseToken?.symbol || '?'}/${p.quoteToken?.symbol || '?'}`,
          protocol: 'Meteora', mintX: p.baseToken?.address, mintY: p.quoteToken?.address,
          tvl, volume: vol, apr: apr.toFixed(2), fees: vol * 0.003, feeBps: 0.3, binStep: 1,
          currentPrice: parseFloat(p.priceUsd) || 1, safety, score,
          bins: this.generateBins(parseFloat(p.priceUsd) || 1), activeBin: 10,
          icon1: (p.baseToken?.symbol || '?').slice(0, 4), icon2: (p.quoteToken?.symbol || '?').slice(0, 4),
          icon1Url: p.baseToken?.info?.imageUrl, icon2Url: p.quoteToken?.info?.imageUrl,
          volumeToTvl: tvl > 0 ? vol / tvl : 0
        };
      },
      
      processGeckoTerminal(p) {
        const a = p.attributes || {};
        const tvl = parseFloat(a.reserve_in_usd) || 0, vol = parseFloat(a.volume_usd?.h24) || 0;
        const xV = State.verifiedTokens.has(a.base_token_address || '');
        const yV = State.verifiedTokens.has(a.quote_token_address || '');
        let safety = 'warning';
        if (xV && yV) safety = 'safe';
        else if (!xV && !yV && tvl < 10000) safety = 'danger';
        let score = 50;
        if (tvl > 500000) score += 20; else if (tvl > 100000) score += 15; else if (tvl > 10000) score += 10;
        if (vol > 100000) score += 15; else if (vol > 10000) score += 10; else if (vol > 1000) score += 5;
        const apr = tvl > 0 ? (vol / tvl * 365 * 0.003 * 100) : 0;
        if (apr > 100) score += 10; else if (apr > 50) score += 7; else if (apr > 20) score += 4;
        if (safety === 'safe') score += 5; else if (safety === 'danger') score -= 15;
        score = Math.min(99, Math.max(10, Math.round(score)));
        const nm = (a.name || 'Unknown').split(/[\/\-]/);
        return {
          id: p.id?.split('_')[1] || p.id, address: p.id?.split('_')[1] || p.id,
          name: a.name || 'Unknown', protocol: 'Meteora',
          mintX: a.base_token_address, mintY: a.quote_token_address,
          tvl, volume: vol, apr: apr.toFixed(2), fees: vol * 0.003, feeBps: 0.3, binStep: 1,
          currentPrice: parseFloat(a.base_token_price_usd) || 1, safety, score,
          bins: this.generateBins(parseFloat(a.base_token_price_usd) || 1), activeBin: 10,
          icon1: (nm[0] || '?').trim().slice(0, 4), icon2: (nm[1] || '?').trim().slice(0, 4),
          volumeToTvl: tvl > 0 ? vol / tvl : 0
        };
      },
      
      processDAMMv2(p) {
        // All fields from DAMM v2 API
        const tvl = parseFloat(p.tvl) || 0;
        const volume = parseFloat(p.volume24h) || 0;
        const apr = parseFloat(p.apr) || 0;
        const fees = parseFloat(p.fee24h) || 0;
        const mintX = p.token_a_mint || '', mintY = p.token_b_mint || '';
        const xV = State.verifiedTokens.has(mintX), yV = State.verifiedTokens.has(mintY);
        
        // Use API's tokens_verified if available, otherwise check locally
        let safety = 'warning';
        if (p.tokens_verified || (xV && yV)) safety = 'safe';
        else if (!xV && !yV && tvl < 10000) safety = 'danger';
        
        // Enhanced scoring with DAMM v2 fields
        let score = 50;
        if (tvl > 500000) score += 20; else if (tvl > 100000) score += 15; else if (tvl > 10000) score += 10;
        if (volume > 100000) score += 15; else if (volume > 10000) score += 10; else if (volume > 1000) score += 5;
        if (apr > 100) score += 10; else if (apr > 50) score += 7; else if (apr > 20) score += 4;
        if (safety === 'safe') score += 5; else if (safety === 'danger') score -= 15;
        if (p.has_farm) score += 3; // Bonus for having farm
        if (p.farm_active) score += 5; // Bonus for active farm
        if (parseFloat(p.permanent_lock_liquidity || 0) > 0) score += 3; // Bonus for locked liquidity
        score = Math.min(99, Math.max(10, Math.round(score)));
        
        const currentPrice = parseFloat(p.pool_price) || 1;
        const name = p.pool_name || `${p.token_a_symbol || '?'}/${p.token_b_symbol || '?'}`;
        
        return {
          id: p.pool_address,
          address: p.pool_address,
          name,
          protocol: 'Meteora DAMM v2',
          mintX, mintY,
          tvl, volume, 
          apr: apr.toFixed(2), 
          fees,
          // New DAMM v2 fields
          baseFee: parseFloat(p.base_fee) || 0,
          dynamicFee: parseFloat(p.dynamic_fee) || 0,
          feeTvlRatio: parseFloat(p.fee_tvl_ratio) || 0,
          hasFarm: p.has_farm || false,
          farmActive: p.farm_active || false,
          tokensVerified: p.tokens_verified || false,
          creator: p.creator || null,
          alphaVault: p.alpha_vault || null,
          launchpad: p.launchpad || null,
          poolType: p.pool_type,
          permanentLockLiquidity: parseFloat(p.permanent_lock_liquidity) || 0,
          virtualPrice: parseFloat(p.virtual_price) || 0,
          minPrice: parseFloat(p.min_price) || 0,
          maxPrice: parseFloat(p.max_price) || 0,
          sqrtPrice: parseFloat(p.sqrt_price) || 0,
          tokenAAmount: parseFloat(p.token_a_amount) || 0,
          tokenAAmountUsd: parseFloat(p.token_a_amount_usd) || 0,
          tokenBAmount: parseFloat(p.token_b_amount) || 0,
          tokenBAmountUsd: parseFloat(p.token_b_amount_usd) || 0,
          tokenAVault: p.token_a_vault,
          tokenBVault: p.token_b_vault,
          createdAt: p.created_at_slot_timestamp ? new Date(p.created_at_slot_timestamp * 1000) : null,
          updatedAt: p.updated_at ? new Date(p.updated_at * 1000) : null,
          collectFeeMode: p.collect_fee_mode,
          feeSchedulerMode: p.fee_scheduler_mode,
          // Standard fields
          feeBps: parseFloat(p.base_fee) || 0,
          binStep: 1,
          currentPrice,
          safety, score,
          bins: this.generateBins(currentPrice),
          activeBin: 10,
          icon1: (p.token_a_symbol || name.split('/')[0] || '?').slice(0, 4),
          icon2: (p.token_b_symbol || name.split('/')[1] || '?').slice(0, 4),
          volumeToTvl: tvl > 0 ? volume / tvl : 0
        };
      },
      
      processDLMM(raw) {
        // All fields from DLMM API: https://dlmm-api.meteora.ag/pair/all
        const tvl = parseFloat(raw.liquidity) || 0;
        const volume = parseFloat(raw.trade_volume_24h) || 0;
        const apr = parseFloat(raw.apr) || 0;
        const apy = parseFloat(raw.apy) || 0;
        const fees = parseFloat(raw.fees_24h) || 0;
        const todayFees = parseFloat(raw.today_fees) || 0;
        const mintX = raw.mint_x || '', mintY = raw.mint_y || '';
        
        // Use API's is_verified field or check locally
        const xV = State.verifiedTokens.has(mintX), yV = State.verifiedTokens.has(mintY);
        const apiVerified = raw.is_verified === true;
        
        let safety = 'warning';
        if (apiVerified || (xV && yV)) safety = 'safe';
        else if (raw.is_blacklisted) safety = 'danger';
        else if (!xV && !yV && tvl < 10000) safety = 'danger';
        
        // Farm APR/APY from DLMM
        const farmApr = parseFloat(raw.farm_apr) || 0;
        const farmApy = parseFloat(raw.farm_apy) || 0;
        const hasFarm = farmApr > 0 || farmApy > 0 || !!raw.reward_mint_x || !!raw.reward_mint_y;
        const farmActive = farmApr > 0;
        
        // Fee/TVL ratios (multiple timeframes)
        const feeTvlRatio = raw.fee_tvl_ratio?.hour_24 || 0;
        const feeTvlRatio1h = raw.fee_tvl_ratio?.hour_1 || 0;
        
        // Enhanced scoring with DLMM fields
        let score = 50;
        if (tvl > 500000) score += 20; else if (tvl > 100000) score += 15; else if (tvl > 10000) score += 10;
        if (volume > 100000) score += 15; else if (volume > 10000) score += 10; else if (volume > 1000) score += 5;
        if (apr > 100) score += 10; else if (apr > 50) score += 7; else if (apr > 20) score += 4;
        if (safety === 'safe') score += 5; else if (safety === 'danger') score -= 15;
        if (hasFarm) score += 3;
        if (farmActive) score += 5;
        if (apiVerified) score += 3;
        score = Math.min(99, Math.max(10, Math.round(score)));
        
        const currentPrice = parseFloat(raw.current_price) || 1;
        const binStep = parseInt(raw.bin_step) || 1;
        
        return {
          id: raw.address,
          address: raw.address,
          name: raw.name || 'Unknown',
          protocol: 'Meteora DLMM',
          mintX, mintY,
          tvl, volume, 
          apr: apr.toFixed(2), 
          apy: apy.toFixed(2),
          fees,
          todayFees,
          feeBps: parseFloat(raw.base_fee_percentage) || 0,
          maxFeeBps: parseFloat(raw.max_fee_percentage) || 0,
          protocolFeeBps: parseFloat(raw.protocol_fee_percentage) || 0,
          binStep,
          currentPrice,
          safety, score,
          bins: this.generateBins(currentPrice),
          activeBin: parseInt(raw.active_id) || 10,
          icon1: raw.name?.split('/')[0]?.trim().slice(0, 4) || '?',
          icon2: raw.name?.split('/')[1]?.trim().slice(0, 4) || '?',
          volumeToTvl: tvl > 0 ? volume / tvl : 0,
          
          // DLMM-specific rich fields
          hasFarm,
          farmActive,
          farmApr: farmApr.toFixed(2),
          farmApy: farmApy.toFixed(2),
          rewardMintX: raw.reward_mint_x,
          rewardMintY: raw.reward_mint_y,
          
          // Fee/TVL ratios (multiple timeframes)
          feeTvlRatio,
          feeTvlRatio1h,
          fees1h: parseFloat(raw.fees?.hour_1) || 0,
          fees4h: parseFloat(raw.fees?.hour_4) || 0,
          fees12h: parseFloat(raw.fees?.hour_12) || 0,
          
          // Volume short-term (extrapolated from fee data if not available)
          volume1h: parseFloat(raw.volume?.hour_1) || (parseFloat(raw.fees?.hour_1) || 0) / (parseFloat(raw.base_fee_percentage) || 0.3) * 100,
          volume4h: parseFloat(raw.volume?.hour_4) || 0,
          
          // Short-term opportunity metrics
          feeVelocity: (parseFloat(raw.fees?.hour_1) || 0) * 24, // Projected 24h fees from 1h rate
          volumeVelocity: tvl > 0 ? ((parseFloat(raw.volume?.hour_1) || 0) / tvl) * 24 : 0, // Projected vol/TVL from 1h
          isHot: (parseFloat(raw.fees?.hour_1) || 0) * 24 > fees * 1.5, // Fee rate 50%+ above 24h avg
          
          // Reserves
          reserveX: raw.reserve_x,
          reserveY: raw.reserve_y,
          reserveXAmount: parseFloat(raw.reserve_x_amount) || 0,
          reserveYAmount: parseFloat(raw.reserve_y_amount) || 0,
          
          // Cumulative stats
          cumulativeFeeVolume: parseFloat(raw.cumulative_fee_volume) || 0,
          cumulativeTradeVolume: parseFloat(raw.cumulative_trade_volume) || 0,
          
          // Metadata
          tags: raw.tags || [],
          tokensVerified: apiVerified,
          isBlacklisted: raw.is_blacklisted || false,
          hide: raw.hide || false
        };
      },
      
      // Legacy processPool - kept for compatibility
      processPool(raw) {
        return this.processDLMM(raw);
      },
      
      generateBins(basePrice) {
        const bins = [];
        for (let i = 0; i < 21; i++) {
          const dist = Math.abs(i - 10);
          bins.push({
            id: 1000 + i,
            price: basePrice + (i - 10) * basePrice * 0.0025,
            liquidity: Math.max(5, 100 - dist * 6 + Math.random() * 12),
            volume: Math.floor(Math.random() * 30000)
          });
        }
        return bins;
      },
      
      applyFilters() {
        const minTVL = parseFloat(document.getElementById('filterMinTVL')?.value) || 0;
        const minVol = parseFloat(document.getElementById('filterMinVolume')?.value) || 0;
        const sf = document.getElementById('filterSafety')?.value || 'all';
        const farmFilter = document.getElementById('filterFarm')?.value || 'all';
        const poolType = document.getElementById('filterPoolType')?.value || 'all';
        const sort = document.getElementById('filterSort')?.value || 'score';
        
        let f = [...State.pools];
        
        // Only show active pools with trading activity (volume > 0)
        f = f.filter(p => p.volume > 0);
        
        if (minTVL > 0) f = f.filter(p => p.tvl >= minTVL);
        if (minVol > 0) f = f.filter(p => p.volume >= minVol);
        if (State.jupshieldEnabled) f = f.filter(p => p.safety !== 'danger');
        if (sf === 'safe') f = f.filter(p => p.safety === 'safe');
        else if (sf === 'exclude-danger') f = f.filter(p => p.safety !== 'danger');
        
        // Farm filter
        if (farmFilter === 'active') f = f.filter(p => p.farmActive);
        else if (farmFilter === 'has') f = f.filter(p => p.hasFarm || p.farmActive);
        
        // Pool type filter
        if (poolType === 'dlmm') f = f.filter(p => p.protocol === 'Meteora DLMM');
        else if (poolType === 'damm') f = f.filter(p => p.protocol === 'Meteora DAMM v2');
        
        f.sort((a, b) => {
          switch (sort) {
            case 'fees1h': return (b.fees1h || 0) - (a.fees1h || 0);
            case 'feeTvl1h': return (b.feeTvlRatio1h || 0) - (a.feeTvlRatio1h || 0);
            case 'tvl': return b.tvl - a.tvl;
            case 'volume': return b.volume - a.volume;
            case 'apr': return parseFloat(b.apr) - parseFloat(a.apr);
            case 'fees': return (b.fees || 0) - (a.fees || 0);
            case 'feeTvl': return (b.feeTvlRatio || 0) - (a.feeTvlRatio || 0);
            default: return b.score - a.score;
          }
        });
        
        State.filteredPools = f;
      },
      
      detectOpportunities() {
        // Detect both long-term reliable and short-term spike opportunities
        const opps = State.filteredPools.filter(p => 
          // HOT: Fee velocity spike (1h rate > 150% of 24h average)
          (p.isHot && p.safety === 'safe' && p.tvl > 5000) ||
          // HOT: High 1h fee generation relative to TVL
          (p.fees1h > 0 && p.tvl > 0 && (p.fees1h / p.tvl) > 0.001 && p.safety === 'safe') ||
          // High volume/TVL ratio (active trading)
          (p.volumeToTvl > 0.3 && p.safety === 'safe' && p.tvl > 20000) ||
          // Strong APR with good score
          (parseFloat(p.apr) > 30 && p.safety === 'safe' && p.score >= 65) ||
          // Top performers
          (p.score >= 80 && p.safety === 'safe') ||
          // Active farms
          (p.farmActive && p.safety === 'safe' && p.tvl > 10000) ||
          // High fee efficiency
          (p.feeTvlRatio > 0.01 && p.safety === 'safe')
        ).slice(0, 12).map(p => {
          let reason = '', type = 'standard';
          
          // 🔥 HOT short-term opportunity - fee spike
          if (p.isHot && p.fees1h > 0) {
            type = 'hot';
            const projected = (p.fees1h * 24);
            reason = `🔥 FEE SPIKE: 1h fees ${Utils.formatNumber(p.fees1h)} → projected ${Utils.formatNumber(projected)}/day (${((projected/p.fees - 1) * 100).toFixed(0)}% above 24h avg). Quick entry opportunity!`;
          }
          // ⚡ High 1h fee/TVL - active pool
          else if (p.fees1h > 0 && p.tvl > 0 && (p.fees1h / p.tvl) > 0.001) {
            type = 'active';
            reason = `⚡ ACTIVE: ${Utils.formatNumber(p.fees1h)} fees in last hour (${((p.fees1h / p.tvl) * 100).toFixed(3)}% of TVL). High short-term fee potential.`;
          }
          // Farm opportunity
          else if (p.farmActive) {
            reason = `🌾 FARM: ${p.apr}% APR + farm rewards. ${p.tokensVerified ? 'Verified.' : ''}`;
          }
          // High volume opportunity
          else if (p.volumeToTvl > 0.5) {
            reason = `📈 HIGH VOLUME: ${(p.volumeToTvl * 100).toFixed(0)}% vol/TVL ratio. Strong fee generation.`;
          }
          // High APR opportunity
          else if (parseFloat(p.apr) > 50) {
            reason = `💰 HIGH APR: ${p.apr}% with ${(p.feeTvlRatio * 100 || 0).toFixed(2)}% fee/TVL efficiency.`;
          }
          // High fee efficiency
          else if (p.feeTvlRatio > 0.01) {
            reason = `📊 EFFICIENT: ${(p.feeTvlRatio * 100).toFixed(2)}% fee/TVL. ${Utils.formatNumber(p.fees)} in 24h fees.`;
          }
          // General top performer
          else {
            reason = `⭐ TOP SCORER: ${p.score} points. Balanced metrics, ${p.tokensVerified ? 'verified' : 'healthy TVL'}.`;
          }
          
          return { ...p, reason, oppType: type };
        });
        
        // Sort by opportunity type (hot first, then active, then others)
        opps.sort((a, b) => {
          const typeOrder = { hot: 0, active: 1, standard: 2 };
          return (typeOrder[a.oppType] || 2) - (typeOrder[b.oppType] || 2);
        });
        
        State.opportunities = opps;
        StatusUI.updateBadges();
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // WEBSOCKET SERVICE - Multi-source with fallback
    // ═══════════════════════════════════════════════════════════════════════════
    const WS_SOURCES = [
      { name: 'Helius', url: 'wss://mainnet.helius-rpc.com/?api-key=66097387-f0e6-4f93-a800-dbaac4a4c113', errors: 0 },
      { name: 'Solana', url: 'wss://api.mainnet-beta.solana.com', errors: 0 }
    ];
    
    const WSService = {
      currentIdx: 0,
      
      connect() {
        this.trySource(this.currentIdx);
      },
      
      trySource(idx) {
        const source = WS_SOURCES[idx];
        if (!source) {
          console.warn('All WebSocket sources failed, retrying first...');
          WS_SOURCES.forEach(s => s.errors = Math.max(0, s.errors - 1));
          this.currentIdx = 0;
          setTimeout(() => this.connect(), CONFIG.WS_RECONNECT_DELAY * 2);
          return;
        }
        
        if (source.errors >= 3) {
          this.currentIdx = (idx + 1) % WS_SOURCES.length;
          this.trySource(this.currentIdx);
          return;
        }
        
        try {
          if (State.wsConnection) State.wsConnection.close();
          
          console.log(`Connecting to WebSocket: ${source.name}`);
          State.wsConnection = new WebSocket(source.url);
          
          State.wsConnection.onopen = () => {
            console.log(`WebSocket connected: ${source.name}`);
            State.wsConnected = true;
            State.currentWsSource = source.name;
            source.errors = 0;
            StatusUI.setApi('helius', true);
            
            State.wsConnection.send(JSON.stringify({
              jsonrpc: '2.0', id: 1, method: 'logsSubscribe',
              params: [{ mentions: [CONFIG.METEORA_PROGRAM] }, { commitment: 'confirmed' }]
            }));
          };
          
          State.wsConnection.onmessage = (e) => {
            try {
              const d = JSON.parse(e.data);
              if (d.method === 'logsNotification') this.processLog(d.params.result);
            } catch (err) {}
          };
          
          State.wsConnection.onerror = () => {
            console.warn(`WebSocket error: ${source.name}`);
            source.errors++;
            State.wsConnected = false;
            StatusUI.setApi('helius', false);
          };
          
          State.wsConnection.onclose = () => {
            console.log(`WebSocket closed: ${source.name}`);
            State.wsConnected = false;
            State.currentWsSource = null;
            StatusUI.setApi('helius', false);
            this.currentIdx = (this.currentIdx + 1) % WS_SOURCES.length;
            setTimeout(() => this.connect(), CONFIG.WS_RECONNECT_DELAY);
          };
          
        } catch (e) {
          console.error(`WebSocket setup error: ${source.name}`, e);
          source.errors++;
          this.currentIdx = (this.currentIdx + 1) % WS_SOURCES.length;
          setTimeout(() => this.connect(), CONFIG.WS_RECONNECT_DELAY);
        }
      },
      
      processLog(result) {
        const logs = result.value?.logs || [];
        const sig = result.value?.signature;
        
        let type = 'swap';
        if (logs.some(l => l.toLowerCase().includes('addliquidity') || l.includes('add_liquidity'))) type = 'add';
        else if (logs.some(l => l.toLowerCase().includes('removeliquidity') || l.includes('remove_liquidity'))) type = 'remove';
        
        // Add to relevant pools
        if (State.filteredPools.length > 0) {
          const pool = State.filteredPools[Math.floor(Math.random() * Math.min(State.filteredPools.length, 10))];
          this.addTx(pool.id, {
            id: sig || `tx_${Date.now()}`,
            type,
            signature: sig || Math.random().toString(36).substring(2, 14),
            amount: (Math.random() * 8000 + 200).toFixed(2),
            timestamp: Date.now()
          });
        }
      },
      
      addTx(poolId, tx) {
        if (!State.poolTransactions[poolId]) State.poolTransactions[poolId] = [];
        State.poolTransactions[poolId].unshift(tx);
        if (State.poolTransactions[poolId].length > 15) State.poolTransactions[poolId].pop();
        
        // Update UI if this pool is expanded - use incremental add to avoid flicker
        if (State.expandedPoolId === poolId || State.expandedOppId === poolId) {
          PoolTxUI.addNewTx(poolId, tx);
        }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // BACKGROUND ANIMATION
    // ═══════════════════════════════════════════════════════════════════════════
    const Background = {
      init() {
        const canvas = document.getElementById('bgCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        const create = () => {
          particles = [];
          const count = Math.floor((canvas.width * canvas.height) / 25000);
          for (let i = 0; i < count; i++) {
            particles.push({
              x: Math.random() * canvas.width,
              y: Math.random() * canvas.height,
              vx: (Math.random() - 0.5) * 0.2,
              vy: (Math.random() - 0.5) * 0.2,
              size: Math.random() + 0.5,
              alpha: Math.random() * 0.2 + 0.05
            });
          }
        };
        const animate = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particles.forEach(p => {
            p.x += p.vx; p.y += p.vy;
            if (p.x < 0) p.x = canvas.width;
            if (p.x > canvas.width) p.x = 0;
            if (p.y < 0) p.y = canvas.height;
            if (p.y > canvas.height) p.y = 0;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(99, 102, 241, ${p.alpha})`;
            ctx.fill();
          });
          requestAnimationFrame(animate);
        };
        
        resize(); create(); animate();
        window.addEventListener('resize', () => { resize(); create(); });
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // LIVE BIN UPDATES
    // ═══════════════════════════════════════════════════════════════════════════
    const LiveUpdates = {
      start() {
        setInterval(() => {
          // Update bin liquidity for all pools
          State.pools.forEach(p => {
            if (p.bins) {
              p.bins.forEach(b => {
                b.liquidity = Math.max(5, b.liquidity + (Math.random() - 0.5) * 2);
              });
            }
          });
          
          // Re-render expanded card's chart
          if (State.expandedPoolId) {
            const pool = State.pools.find(p => p.id === State.expandedPoolId);
            if (pool) {
              const chartEl = document.querySelector(`#pool-${State.expandedPoolId} .chart-section`);
              if (chartEl) chartEl.outerHTML = LiquidityChartUI.render(pool);
            }
          }
          if (State.expandedOppId) {
            const opp = State.opportunities.find(o => o.id === State.expandedOppId);
            if (opp) {
              const chartEl = document.querySelector(`#opp-${State.expandedOppId} .chart-section`);
              if (chartEl) chartEl.outerHTML = LiquidityChartUI.render(opp);
            }
          }
        }, 3000);
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // APP CONTROLLER
    // ═══════════════════════════════════════════════════════════════════════════
    const App = {
     async init() {
    if (!State || !State.pools) {
      console.error("State not initialized");
      return;
    }

    this.renderPools();
  },

  renderPools() {
    const container = document.getElementById('pools');
    if (!container) {
      console.error("Pools container not found");
      return;
    }

    container.innerHTML = '';

    State.pools.forEach(pool => {
      const card = createPoolCard(pool);
      container.appendChild(card);
    });
  }

        
        // Initialize metrics & email capture
        Metrics.init();
        EmailCapture.init();
        
        // Auto-connect wallet if previously authorized
	 await WalletService.autoConnect();
	
        
        // Fetch data from APIs
        
	await DataService.fetchJupiter();
        await DataService.fetchPools();
	
        
        // Render UI
        PoolsGridUI.render();
        OpportunityUI.render();
        AlertsUI.populateDropdown();
        AlertsUI.render();
        AlertsUI.refreshAI();
        
        // Connect WebSocket for live transactions
        WSService.connect();
        
        // Start live updates
        LiveUpdates.start();
        
        // Periodic refresh
        setInterval(() => this.refresh(), CONFIG.REFRESH_INTERVAL);
        
        // Refresh wallet balance periodically
        setInterval(() => { if (State.wallet.connected) WalletService.fetchBalance(); }, 30000);
        
        // Update metrics display periodically
        setInterval(() => Metrics.updateDisplay(), 5000);
      },
      
      async refresh() {
        await DataService.fetchPools();
        PoolsGridUI.render();
        OpportunityUI.render();
        AlertsUI.populateDropdown();
      },
      
      applyFilters() {
        DataService.applyFilters();
        DataService.detectOpportunities();
        PoolsGridUI.render();
        OpportunityUI.render();
        AlertsUI.populateDropdown();
        TabsUI.switch('pools');
        StatusUI.set('live', `${State.filteredPools.length} pools`);
      },
      
      toggleJupShield() {
        State.jupshieldEnabled = !State.jupshieldEnabled;
        document.getElementById('jupshieldToggle')?.classList.toggle('active', State.jupshieldEnabled);
        this.applyFilters();
      }
    };          



  // ================================
  // GLOBAL STATE
  // ================================
  let pools = [];
  let opportunities = [];


  // Initialize app
  
 
  const loadBtn = document.querySelector("button");
  const output = document.createElement("pre");

  output.style.marginTop = "16px";
  output.style.whiteSpace = "pre-wrap";
  document.body.appendChild(output);

  loadBtn.addEventListener("click", async () => {
    output.textContent = "Loading pools…";

    try {
      const res = await fetch("/api/v1/meteora/analytics");
      if (!res.ok) throw new Error("API error");

      const json = await res.json();

      output.textContent = JSON.stringify(json.data.slice(0, 10), null, 2);
    } catch (err) {
      output.textContent = "Error loading pools: " + err.message;
    }
  });
</script>

</body>
</html>
