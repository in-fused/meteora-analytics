<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiquidityPro | Live DeFi Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ═══════════════════════════════════════════════════════════════════════════
       CSS VARIABLES
    ═══════════════════════════════════════════════════════════════════════════ */
    :root {
      --bg-void: #050507;
      --bg-primary: #08090c;
      --bg-secondary: #0d0e12;
      --bg-card: #101114;
      --bg-elevated: #18191f;
      --bg-hover: #1c1d24;
      --accent-primary: #818cf8;
      --accent-secondary: #a78bfa;
      --accent-cyan: #22d3ee;
      --accent-emerald: #34d399;
      --accent-amber: #fbbf24;
      --accent-rose: #fb7185;
      /* Brighter text colors */
      --text-primary: #fafafa;
      --text-secondary: #d4d4d8;
      --text-muted: #a1a1aa;
      --text-dim: #71717a;
      --border-subtle: rgba(255,255,255,0.06);
      --border-medium: rgba(255,255,255,0.10);
      --border-active: rgba(129,140,248,0.6);
      --glow-primary: 0 0 20px rgba(129,140,248,0.25);
      --glow-emerald: 0 0 12px rgba(52,211,153,0.3);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --font-display: 'Sora', sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
      /* Base font size increase */
      --font-base: 14px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESET
    ═══════════════════════════════════════════════════════════════════════════ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: var(--font-display); background: var(--bg-void); color: var(--text-primary); min-height: 100vh; line-height: 1.5; font-size: var(--font-base); }

    /* ═══════════════════════════════════════════════════════════════════════════
       BACKGROUND
    ═══════════════════════════════════════════════════════════════════════════ */
    #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; }
    .bg-overlay { position: fixed; inset: 0; z-index: -1; background: radial-gradient(ellipse 80% 50% at 20% 0%, rgba(99,102,241,0.07) 0%, transparent 50%); pointer-events: none; }

    /* ═══════════════════════════════════════════════════════════════════════════
       LAYOUT
    ═══════════════════════════════════════════════════════════════════════════ */
    .app { max-width: 1800px; margin: 0 auto; padding: 14px 18px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       HEADER
    ═══════════════════════════════════════════════════════════════════════════ */
    .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap; gap: 12px; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-mark { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
    .logo-text { font-size: 20px; font-weight: 600; }
    .logo-text span { background: linear-gradient(90deg, var(--accent-primary), var(--accent-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-status { display: flex; align-items: center; gap: 12px; }
    .status-pill { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; font-size: 12px; color: var(--text-secondary); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-amber); }
    .status-dot.live { background: var(--accent-emerald); box-shadow: var(--glow-emerald); }
    .status-dot.error { background: var(--accent-rose); }
    .api-badges { display: flex; gap: 5px; }
    .api-badge { padding: 3px 8px; background: var(--bg-elevated); border-radius: 4px; font-size: 10px; font-family: var(--font-mono); color: var(--text-muted); border: 1px solid var(--border-subtle); }
    .api-badge.active { color: var(--accent-emerald); border-color: rgba(52,211,153,0.3); }
    .api-badge.error { color: var(--accent-rose); border-color: rgba(251,113,133,0.3); }
    .header-actions { display: flex; gap: 8px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       BUTTONS
    ═══════════════════════════════════════════════════════════════════════════ */
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: var(--radius-sm); font-family: inherit; font-size: 13px; font-weight: 500; cursor: pointer; transition: all var(--transition-fast); border: 1px solid transparent; white-space: nowrap; }
    .btn--primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; }
    .btn--primary:hover { box-shadow: var(--glow-primary); transform: translateY(-1px); }
    .btn--secondary { background: var(--bg-elevated); color: var(--text-primary); border-color: var(--border-medium); }
    .btn--secondary:hover { background: var(--bg-hover); border-color: var(--border-active); }
    .btn--ghost { background: transparent; color: var(--text-secondary); padding: 5px 8px; }
    .btn--ghost:hover { color: var(--text-primary); background: var(--bg-elevated); }
    .btn--success { background: rgba(52,211,153,0.15); color: var(--accent-emerald); border-color: rgba(52,211,153,0.3); }
    .btn--warning { background: rgba(251,191,36,0.15); color: var(--accent-amber); border-color: rgba(251,191,36,0.3); }
    .btn--wallet { background: linear-gradient(135deg, #ab9ff2, #818cf8); color: white; }
    .btn--wallet.connected { background: var(--bg-elevated); border: 1px solid var(--accent-emerald); }
    .btn svg { width: 14px; height: 14px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       TABS
    ═══════════════════════════════════════════════════════════════════════════ */
    .nav-tabs { display: flex; gap: 4px; background: var(--bg-secondary); padding: 4px; border-radius: var(--radius-md); margin-bottom: 16px; border: 1px solid var(--border-subtle); }
    .nav-tab { flex: 1; padding: 10px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; color: var(--text-secondary); background: transparent; border: none; cursor: pointer; transition: all var(--transition-fast); display: flex; align-items: center; justify-content: center; gap: 6px; }
    .nav-tab:hover { color: var(--text-primary); }
    .nav-tab.active { background: var(--bg-card); color: var(--text-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .nav-tab svg { width: 15px; height: 15px; opacity: 0.7; }
    .nav-tab.active svg { opacity: 1; }
    .tab-badge { background: var(--accent-emerald); color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; font-weight: 600; }
    .tab-content { display: none; animation: fadeIn 0.25s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ═══════════════════════════════════════════════════════════════════════════
       TOAST
    ═══════════════════════════════════════════════════════════════════════════ */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: var(--bg-card); border: 1px solid var(--border-medium); border-radius: var(--radius-md); padding: 14px 18px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: toastIn 0.3s ease; min-width: 300px; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    .toast.success { border-color: rgba(52,211,153,0.3); }
    .toast.error { border-color: rgba(251,113,133,0.3); }
    .toast-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; }
    .toast.success .toast-icon { background: rgba(52,211,153,0.15); color: var(--accent-emerald); }
    .toast.error .toast-icon { background: rgba(251,113,133,0.15); color: var(--accent-rose); }
    .toast-content { flex: 1; }
    .toast-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .toast-message { font-size: 12px; color: var(--text-secondary); }
    .toast-close { background: none; border: none; color: var(--text-muted); cursor: pointer; }

    /* ═══════════════════════════════════════════════════════════════════════════
       MODAL
    ═══════════════════════════════════════════════════════════════════════════ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.visible { display: flex; }
    .modal { background: var(--bg-card); border: 1px solid var(--border-medium); border-radius: var(--radius-lg); width: 100%; max-width: 400px; animation: modalIn 0.3s ease; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-subtle); }
    .modal-title { font-size: 16px; font-weight: 600; }
    .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; }
    .modal-body { padding: 16px 20px; max-height: 400px; overflow-y: auto; }
    .wallet-list { display: flex; flex-direction: column; gap: 8px; }
    .wallet-option { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); position: relative; }
    .wallet-option:hover { border-color: var(--border-active); background: var(--bg-elevated); }
    .wallet-option.detected { border-color: rgba(16,185,129,0.3); }
    .wallet-option-icon { width: 36px; height: 36px; border-radius: var(--radius-sm); overflow: hidden; background: var(--bg-elevated); }
    .wallet-option-icon img { width: 100%; height: 100%; }
    .wallet-option-info { flex: 1; }
    .wallet-option-name { font-size: 13px; font-weight: 500; }
    .wallet-option-desc { font-size: 10px; color: var(--text-muted); }
    .wallet-detected-badge { position: absolute; right: 12px; font-size: 9px; color: var(--accent-emerald); background: rgba(16,185,129,0.1); padding: 2px 6px; border-radius: 4px; }
    .connected-wallet { background: var(--bg-secondary); border: 1px solid var(--accent-emerald); border-radius: var(--radius-md); padding: 16px; }
    .connected-wallet-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .connected-wallet-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan)); }
    .connected-wallet-info { flex: 1; }
    .connected-wallet-label { font-size: 10px; color: var(--text-muted); }
    .connected-wallet-address { font-family: var(--font-mono); font-size: 13px; font-weight: 500; }
    .connected-wallet-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
    .connected-wallet-stat { background: var(--bg-card); border-radius: var(--radius-sm); padding: 10px; text-align: center; }
    .connected-wallet-stat-value { font-family: var(--font-mono); font-size: 14px; font-weight: 600; color: var(--accent-cyan); }
    .connected-wallet-stat-label { font-size: 9px; color: var(--text-muted); }
    .connected-wallet-actions { display: flex; gap: 8px; }
    .connected-wallet-actions .btn { flex: 1; justify-content: center; }

    /* ═══════════════════════════════════════════════════════════════════════════
       POOLS CONTAINER - HORIZONTAL GRID LAYOUT
    ═══════════════════════════════════════════════════════════════════════════ */
    .pools-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }
    @media (max-width: 1200px) { .pools-container { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .pools-container { grid-template-columns: 1fr; } }

    /* ═══════════════════════════════════════════════════════════════════════════
       POOL CARD - CLEAN COMPACT DESIGN
    ═══════════════════════════════════════════════════════════════════════════ */
    .pool-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
      position: relative;
    }
    .pool-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--card-accent, var(--accent-primary)), transparent);
      opacity: 0;
      transition: opacity var(--transition-normal);
    }
    .pool-card:hover { border-color: var(--border-active); box-shadow: 0 6px 24px rgba(0,0,0,0.2); }
    .pool-card:hover::before { opacity: 1; }
    .pool-card.score-high { --card-accent: var(--accent-emerald); }
    .pool-card.score-medium { --card-accent: var(--accent-amber); }
    .pool-card.score-low { --card-accent: var(--accent-rose); }
    .pool-card-main { padding: 14px; cursor: pointer; }
    .pool-rank { position: absolute; top: 10px; left: 10px; width: 22px; height: 22px; background: var(--bg-elevated); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: var(--text-secondary); border: 1px solid var(--border-subtle); z-index: 2; }
    .pool-rank.top3 { background: linear-gradient(135deg, var(--accent-amber), #d97706); color: var(--bg-void); border: none; }
    .pool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-left: 26px; }
    .pool-pair { display: flex; align-items: center; gap: 10px; }
    .pool-icons { display: flex; }
    .pool-icon { width: 30px; height: 30px; border-radius: 50%; background: var(--bg-elevated); border: 2px solid var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: var(--text-primary); }
    .pool-icon:nth-child(2) { margin-left: -10px; }
    .pool-info h3 { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .pool-type-badge { font-size: 10px; color: var(--text-muted); background: var(--bg-secondary); padding: 2px 6px; border-radius: 3px; margin-left: 6px; }
    .pool-badges { display: flex; align-items: center; gap: 6px; }
    .score-badge { padding: 4px 10px; border-radius: 6px; font-size: 14px; font-weight: 700; font-family: var(--font-mono); }
    .score-badge.high { background: rgba(52,211,153,0.15); color: var(--accent-emerald); }
    .score-badge.medium { background: rgba(251,191,36,0.15); color: var(--accent-amber); }
    .score-badge.low { background: rgba(251,113,133,0.15); color: var(--accent-rose); }
    .safety-dot { width: 8px; height: 8px; border-radius: 50%; }
    .safety-dot.safe { background: var(--accent-emerald); box-shadow: 0 0 6px var(--accent-emerald); }
    .safety-dot.warning { background: var(--accent-amber); }
    .safety-dot.danger { background: var(--accent-rose); }

    .pool-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .pool-stat { text-align: center; padding: 10px 6px; background: var(--bg-secondary); border-radius: var(--radius-sm); }
    .pool-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; }
    .pool-stat-value { font-family: var(--font-mono); font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .pool-stat-value.accent { color: var(--accent-cyan); }
    
    .pool-expand-hint { text-align: center; margin-top: 10px; font-size: 10px; color: var(--text-dim); }
    
    /* Pool Action Buttons - In Expanded Only */
    .pool-actions { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
    .pool-action-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; font-size: 12px; font-weight: 500; border-radius: var(--radius-sm); border: 1px solid var(--border-medium); background: var(--bg-elevated); color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); text-decoration: none; }
    .pool-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-active); }
    .pool-action-btn.primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border: none; color: white; }
    .pool-action-btn.primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .pool-action-btn svg { width: 14px; height: 14px; }
    
    /* Compact badges */
    .pool-badges-row { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
    .mini-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }
    .mini-badge.farm { background: rgba(52,211,153,0.15); color: var(--accent-emerald); }
    .mini-badge.bin { background: rgba(129,140,248,0.15); color: var(--accent-primary); }
    .mini-badge.fee { background: rgba(34,211,238,0.15); color: var(--accent-cyan); }
    
    /* Advanced Info in Expanded */
    .pool-advanced-info { padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); }
    .pool-advanced-info h4 { font-size: 11px; color: var(--text-primary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .advanced-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .adv-item { font-size: 11px; color: var(--text-secondary); }
    .adv-item span { color: var(--text-muted); margin-right: 5px; }

    /* Expanded Content */
    .pool-expanded { display: none; border-top: 1px solid var(--border-subtle); }
    .pool-card.expanded .pool-expanded { display: block; }
    .pool-expanded-inner { padding: 14px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       LIQUIDITY CHART
    ═══════════════════════════════════════════════════════════════════════════ */
    .chart-section { margin-bottom: 14px; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .chart-title { font-size: 12px; color: var(--text-primary); font-weight: 500; }
    .chart-legend { display: flex; gap: 10px; }
    .legend-item { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-secondary); }
    .legend-dot { width: 6px; height: 6px; border-radius: 2px; }
    .legend-dot.liquidity { background: var(--accent-cyan); }
    .legend-dot.active { background: var(--accent-primary); box-shadow: 0 0 4px var(--accent-primary); }
    .bins-container { display: flex; align-items: flex-end; height: 90px; gap: 2px; padding: 6px 0; }
    .bin { flex: 1; min-width: 0; background: linear-gradient(180deg, var(--accent-cyan), rgba(34,211,238,0.15)); border-radius: 2px 2px 0 0; position: relative; cursor: pointer; transition: all var(--transition-fast); transform-origin: bottom; }
    .bin:hover { transform: scaleY(1.1) scaleX(1.2); filter: brightness(1.3); z-index: 10; }
    .bin.active-bin { background: linear-gradient(180deg, var(--accent-primary), rgba(129,140,248,0.25)); box-shadow: 0 0 8px rgba(129,140,248,0.4); }
    .bin-tooltip { position: absolute; bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%); background: var(--bg-void); border: 1px solid var(--border-medium); border-radius: var(--radius-sm); padding: 6px 8px; font-size: 10px; white-space: nowrap; opacity: 0; visibility: hidden; transition: all var(--transition-fast); z-index: 100; pointer-events: none; }
    .bin:hover .bin-tooltip { opacity: 1; visibility: visible; }
    .bin-tooltip-row { display: flex; justify-content: space-between; gap: 10px; padding: 2px 0; }
    .bin-tooltip-label { color: var(--text-muted); }
    .bin-tooltip-value { font-family: var(--font-mono); font-weight: 500; color: var(--text-primary); }
    .chart-axis { display: flex; justify-content: space-between; padding-top: 4px; border-top: 1px solid var(--border-subtle); }
    .axis-label { font-size: 9px; color: var(--text-muted); font-family: var(--font-mono); }
    .axis-label.active { color: var(--accent-primary); }

    /* ═══════════════════════════════════════════════════════════════════════════
       POOL TRANSACTIONS
    ═══════════════════════════════════════════════════════════════════════════ */
    .pool-tx-section { background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 10px; }
    .pool-tx-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .pool-tx-title { font-size: 11px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 6px; }
    .pool-tx-title .status-dot { width: 5px; height: 5px; }
    .pool-tx-list { max-height: 120px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
    .pool-tx-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: var(--bg-card); border-radius: 4px; font-size: 11px; animation: txIn 0.3s ease; }
    @keyframes txIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
    .pool-tx-type { width: 18px; height: 18px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
    .pool-tx-type.add { background: rgba(52,211,153,0.15); color: var(--accent-emerald); }
    .pool-tx-type.remove { background: rgba(251,113,133,0.15); color: var(--accent-rose); }
    .pool-tx-type.swap { background: rgba(99,102,241,0.15); color: var(--accent-primary); }
    .pool-tx-info { flex: 1; color: var(--text-muted); }
    .pool-tx-info a { color: var(--text-muted); text-decoration: none; }
    .pool-tx-info a:hover { color: var(--accent-primary); }
    .pool-tx-amount { font-family: var(--font-mono); font-weight: 500; font-size: 9px; }
    .pool-tx-amount.positive { color: var(--accent-emerald); }
    .pool-tx-amount.negative { color: var(--accent-rose); }
    .pool-tx-time { font-size: 8px; color: var(--text-dim); }
    .pool-tx-empty { text-align: center; padding: 12px; color: var(--text-dim); font-size: 9px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       OPPORTUNITY CARD - EXPANDABLE LIKE POOL CARDS
    ═══════════════════════════════════════════════════════════════════════════ */
    .opp-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      margin-bottom: 12px;
      overflow: hidden;
      position: relative;
      transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
    }
    .opp-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; bottom: 0;
      width: 3px;
      background: var(--accent-emerald);
    }
    .opp-card:hover { border-color: var(--border-active); box-shadow: 0 6px 24px rgba(0,0,0,0.2); }
    .opp-card-main { padding: 16px; cursor: pointer; }
    .opp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .opp-pool { display: flex; align-items: center; gap: 12px; }
    .opp-pool-icons { display: flex; }
    .opp-pool-icon { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-elevated); border: 2px solid var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: var(--text-primary); }
    .opp-pool-icon:nth-child(2) { margin-left: -10px; }
    .opp-pool-info h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .opp-score { text-align: right; }
    .opp-score-value { font-size: 28px; font-weight: 700; font-family: var(--font-mono); color: var(--accent-emerald); }
    .opp-score-label { font-size: 11px; color: var(--text-secondary); }

    .opp-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
    .opp-metric { background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 10px; text-align: center; }
    .opp-metric-value { font-family: var(--font-mono); font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .opp-metric-value.positive { color: var(--accent-emerald); }
    .opp-metric-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
    .opp-reason { background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.25); border-radius: var(--radius-sm); padding: 10px; }
    .opp-reason-title { font-size: 11px; font-weight: 600; color: var(--accent-emerald); margin-bottom: 4px; }
    .opp-reason-text { font-size: 12px; color: var(--text-secondary); line-height: 1.4; }

    .opp-expand-hint { text-align: center; padding: 10px; font-size: 10px; color: var(--text-dim); margin-top: 10px; }

    .opp-expanded { display: none; border-top: 1px solid var(--border-subtle); }
    .opp-card.expanded .opp-expanded { display: block; }
    .opp-expanded-inner { padding: 14px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       FILTERS & ALERTS
    ═══════════════════════════════════════════════════════════════════════════ */
    .filters-section { background: var(--bg-secondary); border-radius: var(--radius-md); padding: 14px; margin-bottom: 16px; }
    .filters-title { font-size: 13px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; color: var(--text-primary); }
    .filters-title svg { width: 14px; height: 14px; color: var(--accent-primary); }
    .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-label { font-size: 12px; font-weight: 500; color: var(--text-primary); }
    .filter-input { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 8px 10px; color: var(--text-primary); font-family: var(--font-mono); font-size: 13px; width: 100%; }
    .filter-input:focus { outline: none; border-color: var(--accent-primary); }
    .filter-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; }
    .toggle-group { display: flex; align-items: center; gap: 8px; }
    .toggle { width: 36px; height: 20px; background: var(--bg-elevated); border-radius: 10px; position: relative; cursor: pointer; border: none; }
    .toggle::after { content: ''; position: absolute; width: 14px; height: 14px; background: var(--text-muted); border-radius: 50%; top: 3px; left: 3px; transition: all var(--transition-fast); }
    .toggle.active { background: var(--accent-primary); }
    .toggle.active::after { transform: translateX(16px); background: white; }
    .ai-alerts-section { background: linear-gradient(135deg, rgba(129,140,248,0.1), rgba(34,211,238,0.1)); border: 1px solid rgba(129,140,248,0.25); border-radius: var(--radius-md); padding: 14px; margin-bottom: 14px; }
    .ai-alerts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .ai-alerts-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; color: var(--text-primary); }
    .ai-suggestion { background: var(--bg-card); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .ai-suggestion-info { flex: 1; }
    .ai-suggestion-pool { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .ai-suggestion-reason { font-size: 11px; color: var(--text-secondary); }
    .ai-suggestion-actions { display: flex; gap: 6px; }
    .panel { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 14px; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap; gap: 10px; }
    .panel-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
    .panel-title svg { width: 16px; height: 16px; color: var(--accent-primary); }
    .panel-body { padding: 14px 16px; }
    .alert-form { display: grid; grid-template-columns: 1fr 1fr 100px auto auto; gap: 10px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 14px; align-items: end; }
    .alert-list { display: flex; flex-direction: column; gap: 6px; max-height: 280px; overflow-y: auto; }
    .alert-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg-secondary); border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); }
    .alert-info { display: flex; align-items: center; gap: 10px; }
    .alert-icon { width: 28px; height: 28px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .alert-icon.up { background: rgba(52,211,153,0.12); color: var(--accent-emerald); }
    .alert-icon.down { background: rgba(251,113,133,0.12); color: var(--accent-rose); }
    .alert-details h4 { font-size: 13px; font-weight: 500; color: var(--text-primary); }
    .alert-details p { font-size: 11px; color: var(--text-secondary); }
    .alert-actions { display: flex; align-items: center; gap: 8px; }
    .alert-empty { text-align: center; padding: 28px; color: var(--text-secondary); font-size: 13px; }

    /* ═══════════════════════════════════════════════════════════════════════════
       GUIDE
    ═══════════════════════════════════════════════════════════════════════════ */
    .guide-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; }
    .guide-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 18px; }
    .guide-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
    .guide-icon svg { width: 20px; height: 20px; color: white; }
    .guide-card h3 { font-size: 15px; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); }
    .guide-card p { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }

    /* Utilities */
    .loading-spinner { width: 18px; height: 18px; border: 2px solid var(--border-subtle); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.7s linear infinite; margin: 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 3px; }

    @media (max-width: 768px) {
      .header { flex-direction: column; }
      .nav-tabs { flex-wrap: wrap; }
      .nav-tab { min-width: calc(50% - 3px); }
      .alert-form { grid-template-columns: 1fr; }
      .pool-stats, .opp-metrics { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="bg-overlay"></div>
  <div class="toast-container" id="toastContainer"></div>

  <!-- Wallet Modal -->
  <div class="modal-overlay" id="walletModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Connect Wallet</h2>
        <button class="modal-close" onclick="WalletUI.close()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-mark">LP</div>
        <div class="logo-text">Liquidity<span>Pro</span></div>
      </div>
      <div class="header-status">
        <div class="status-pill">
          <span class="status-dot" id="mainStatus"></span>
          <span id="statusText">Initializing...</span>
        </div>
        <div class="api-badges">
          <span class="api-badge" id="meteoraApi">Meteora</span>
          <span class="api-badge" id="jupiterApi">Jupiter</span>
          <span class="api-badge" id="heliusApi">Helius WS</span>
          <span class="api-badge" id="birdeyeApi">Birdeye</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn--secondary" onclick="App.refresh()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/></svg>
          Refresh
        </button>
        <button class="btn btn--wallet" id="walletBtn" onclick="WalletUI.open()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <span id="walletBtnText">Connect Wallet</span>
        </button>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="pools" onclick="TabsUI.switch('pools')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/></svg>
        All Pools
      </button>
      <button class="nav-tab" data-tab="opportunities" onclick="TabsUI.switch('opportunities')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        Opportunities
        <span class="tab-badge" id="oppBadge">0</span>
      </button>
      <button class="nav-tab" data-tab="alerts" onclick="TabsUI.switch('alerts')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>
        Alerts & Filters
      </button>
      <button class="nav-tab" data-tab="guide" onclick="TabsUI.switch('guide')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/></svg>
        Guide
      </button>
    </nav>

    <!-- All Pools Tab -->
    <div class="tab-content active" id="pools-tab">
      <div class="pools-container" id="poolsContainer"></div>
    </div>

    <!-- Opportunities Tab -->
    <div class="tab-content" id="opportunities-tab">
      <div id="opportunitiesList"></div>
    </div>

    <!-- Alerts Tab -->
    <div class="tab-content" id="alerts-tab">
      <div class="filters-section">
        <div class="filters-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
          Pool Filters
        </div>
        <div class="filters-grid">
          <div class="filter-group">
            <label class="filter-label">Min TVL ($)</label>
            <input type="number" class="filter-input" id="filterMinTVL" value="5000">
          </div>
          <div class="filter-group">
            <label class="filter-label">Min Volume ($)</label>
            <input type="number" class="filter-input" id="filterMinVolume" value="1000">
          </div>
          <div class="filter-group">
            <label class="filter-label">Safety</label>
            <select class="filter-input filter-select" id="filterSafety">
              <option value="all">All</option>
              <option value="safe">Verified Only</option>
              <option value="exclude-danger" selected>Exclude Dangerous</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Farm Status</label>
            <select class="filter-input filter-select" id="filterFarm">
              <option value="all">All Pools</option>
              <option value="active">Active Farms Only</option>
              <option value="has">Has Farm</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Pool Type</label>
            <select class="filter-input filter-select" id="filterPoolType">
              <option value="all">All Types</option>
              <option value="dlmm">DLMM Only</option>
              <option value="damm">DAMM v2 Only</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Sort By</label>
            <select class="filter-input filter-select" id="filterSort">
              <option value="score">Score</option>
              <option value="tvl">TVL</option>
              <option value="volume">Volume</option>
              <option value="apr">APR</option>
              <option value="fees">24h Fees</option>
              <option value="feeTvl">Fee/TVL Ratio</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">JupShield</label>
            <div class="toggle-group">
              <button class="toggle active" id="jupshieldToggle" onclick="App.toggleJupShield()"></button>
              <span style="font-size:10px;color:var(--text-secondary)">Filter unsafe</span>
            </div>
          </div>
          <div class="filter-group" style="justify-content:flex-end">
            <button class="btn btn--primary" onclick="App.applyFilters()">Apply</button>
          </div>
        </div>
      </div>
      <div class="ai-alerts-section">
        <div class="ai-alerts-header">
          <div class="ai-alerts-title">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="2"/></svg>
            AI-Suggested Alerts
          </div>
          <button class="btn btn--secondary" onclick="AlertsUI.refreshAI()">Refresh</button>
        </div>
        <div id="aiSuggestions"></div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>
            Custom Alerts
          </h2>
          <div style="display:flex;gap:6px">
            <button class="btn btn--warning" onclick="AlertsUI.addForAll()">Alert All</button>
            <button class="btn btn--secondary" onclick="AlertsUI.clearAll()">Clear</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="alert-form">
            <div class="filter-group">
              <label class="filter-label">Pool</label>
              <select class="filter-input filter-select" id="alertPool"></select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Condition</label>
              <select class="filter-input filter-select" id="alertCondition">
                <option value="price-above">Price Above</option>
                <option value="price-below">Price Below</option>
                <option value="tvl-above">TVL Above</option>
                <option value="apr-above">APR Above</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Value</label>
              <input type="number" class="filter-input" id="alertValue" placeholder="100">
            </div>
            <button class="btn btn--primary" onclick="AlertsUI.add()">Add</button>
            <button class="btn btn--secondary" onclick="AlertsUI.addForAll()">All</button>
          </div>
          <div class="alert-list" id="alertList">
            <div class="alert-empty">No alerts configured.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Guide Tab -->
    <div class="tab-content" id="guide-tab">
      <div class="guide-grid">
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/></svg></div>
          <h3>All Pools</h3>
          <p>Browse DLMM pools ranked by score. Click any card to expand charts and live transactions.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
          <h3>Opportunities</h3>
          <p>AI-detected high-probability setups. Click to expand real-time charts and transaction flow.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/></svg></div>
          <h3>Wallet</h3>
          <p>Connect Phantom, Solflare, or Backpack to interact with pools directly.</p>
        </div>
        <div class="guide-card">
          <div class="guide-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
          <h3>JupShield Safety</h3>
          <p>Token verification via Jupiter strict list. ✓ Safe, ! Warning, ✕ Danger.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ═══════════════════════════════════════════════════════════════════════════
    // CONFIGURATION - ALL API KEYS & ENDPOINTS
    // ═══════════════════════════════════════════════════════════════════════════
    const CONFIG = {
      // Meteora APIs
      METEORA_DAMM_V2: 'https://dammv2-api.meteora.ag',
      METEORA_DLMM: 'https://dlmm-api.meteora.ag',
      METEORA_PROGRAM: 'LBUZKhRxPF3XUpBCjp4YzTKgLccjZhTSDM9YuVaPwxo',
      
      // Jupiter Token Verification
      JUPITER_PRICE: 'https://api.jup.ag/price/v3/price',
      JUPITER_TOKENS: 'https://api.jup.ag/tokens/v2/tag?query=verified',
      
      // Helius API (Primary)
      HELIUS_KEY: '66097387-f0e6-4f93-a800-dbaac4a4c113',
      HELIUS_RPC: 'https://mainnet.helius-rpc.com/?api-key=66097387-f0e6-4f93-a800-dbaac4a4c113',
      HELIUS_WS: 'wss://mainnet.helius-rpc.com/?api-key=66097387-f0e6-4f93-a800-dbaac4a4c113',
      
      // Refresh intervals
      REFRESH_INTERVAL: 30000,
      WS_RECONNECT_DELAY: 3000,
      MAX_ERRORS: 3
    };

    // Wallet Configurations
    const WALLETS = {
      phantom: { 
        name: 'Phantom', 
        icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgZmlsbD0ibm9uZSI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjNTUyQkYwIiByeD0iOCIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0yOSAxOWMtMS44LTEuNS00LjItMi44LTctMi44LTQuMiAwLTcuNyAzLjYtNy43IDguMiAwIDIuOCAxLjIgNS4yIDMuMyA2LjguMi4xLjMuMi41LjJzLjMtLjEuNC0uMmMuNC0uMy44LS41IDEuMS0uNS44IDAgMS41LjcgMS42IDEuNSAwIC4yLjIuMy4zLjNoNC41Yy4xIDAgLjMtLjEuMy0uMy4yLTEuNCAxLjQtMi40IDIuOC0yLjQuNyAwIDEuNC4zIDEuOS44LjEuMS4zLjIuNC4ycy4zLS4xLjQtLjJjMi0xLjcgMy4zLTQuMiAzLjMtNyAwLTEuNy0uNS0zLjMtMS41LTQuNi0uMy0uNC0uNi0uNy0uOS0xLS4zLS4zLS42LS41LS44LS44em0tNyAyLjJjMCAuNy0uNiAxLjMtMS4zIDEuM3MtMS4zLS42LTEuMy0xLjMuNi0xLjMgMS4zLTEuMyAxLjMuNiAxLjMgMS4zem00LjggMGMwIC43LS42IDEuMy0xLjMgMS4zcy0xLjMtLjYtMS4zLTEuMy42LTEuMyAxLjMtMS4zIDEuMy42IDEuMyAxLjN6Ii8+PC9zdmc+',
        getProvider: () => window.phantom?.solana,
        downloadUrl: 'https://phantom.app'
      },
      solflare: {
        name: 'Solflare',
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjRkM2QjFEIi8+PHBhdGggZD0iTTIwIDEwTDI4IDE1VjI1TDIwIDMwTDEyIDI1VjE1TDIwIDEwWiIgZmlsbD0id2hpdGUiLz48L3N2Zz4=',
        getProvider: () => window.solflare,
        downloadUrl: 'https://solflare.com'
      },
      backpack: {
        name: 'Backpack',
        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjRTMzNjI5Ii8+PHBhdGggZD0iTTIwIDhDMTMuNCAgOCA4IDEzLjQgOCAyMFYyOEgzMlYyMEMzMiAxMy40IDI2LjYgOCAyMCA4WiIgZmlsbD0id2hpdGUiLz48L3N2Zz4=',
        getProvider: () => window.backpack,
        downloadUrl: 'https://backpack.app'
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════════════════════
    const State = {
      pools: [],
      filteredPools: [],
      opportunities: [],
      verifiedTokens: new Set(),
      alerts: [],
      aiSuggestions: [],
      expandedPoolId: null,
      expandedOppId: null,
      poolTransactions: {},
      wsConnection: null,
      wsConnected: false,
      currentWsSource: null,
      jupshieldEnabled: true,
      wallet: { connected: false, publicKey: null, provider: null, name: null, balance: 0 },
      apiStatus: { meteora: false, jupiter: false, helius: false, birdeye: false }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // UTILITIES
    // ═══════════════════════════════════════════════════════════════════════════
    const Utils = {
      formatNumber: n => { if (n == null || isNaN(n)) return '$0'; if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M'; if (n >= 1e3) return '$' + (n/1e3).toFixed(1) + 'K'; return '$' + n.toFixed(2); },
      formatPrice: n => { if (n == null || isNaN(n)) return '0'; if (n >= 1000) return n.toFixed(2); if (n >= 1) return n.toFixed(4); return n.toFixed(6); },
      formatTime: ts => { const d = Date.now() - ts; if (d < 60000) return Math.floor(d/1000) + 's'; if (d < 3600000) return Math.floor(d/60000) + 'm'; return Math.floor(d/3600000) + 'h'; },
      truncate: (s, l=8) => s ? (s.length > l ? s.slice(0,l) + '...' : s) : '',
      shortenAddress: (a, c=4) => a ? `${a.slice(0,c)}...${a.slice(-c)}` : '',
      copyIcon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>'
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // TOAST UI
    // ═══════════════════════════════════════════════════════════════════════════
    const ToastUI = {
      show(type, title, msg) {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<div class="toast-icon">${type === 'success' ? '✓' : '✕'}</div><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${msg}</div></div><button class="toast-close" onclick="this.parentElement.remove()">✕</button>`;
        c.appendChild(t);
        setTimeout(() => t.remove(), 5000);
      },
      success: (t, m) => ToastUI.show('success', t, m),
      error: (t, m) => ToastUI.show('error', t, m)
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // TABS UI
    // ═══════════════════════════════════════════════════════════════════════════
    const TabsUI = {
      switch(name) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-tab="${name}"]`)?.classList.add('active');
        document.getElementById(`${name}-tab`)?.classList.add('active');
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // STATUS UI
    // ═══════════════════════════════════════════════════════════════════════════
    const StatusUI = {
      set(status, text) {
        const dot = document.getElementById('mainStatus');
        const txt = document.getElementById('statusText');
        if (dot) { dot.className = 'status-dot'; if (status === 'live') dot.classList.add('live'); else if (status === 'error') dot.classList.add('error'); }
        if (txt) txt.textContent = text;
      },
      setApi(api, active) {
        const el = document.getElementById(`${api}Api`);
        if (el) { el.classList.remove('active', 'error'); el.classList.add(active ? 'active' : 'error'); }
        State.apiStatus[api] = active;
      },
      updateBadges() {
        const ob = document.getElementById('oppBadge');
        if (ob) ob.textContent = State.opportunities.length;
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // WALLET UI
    // ═══════════════════════════════════════════════════════════════════════════
    const WalletUI = {
      open() {
        const modal = document.getElementById('walletModal');
        document.getElementById('modalTitle').textContent = State.wallet.connected ? 'Wallet Connected' : 'Connect Wallet';
        document.getElementById('modalBody').innerHTML = State.wallet.connected ? this.renderConnected() : this.renderList();
        modal.classList.add('visible');
      },
      close() { document.getElementById('walletModal').classList.remove('visible'); },
      renderList() {
        return `<div class="wallet-list">${Object.entries(WALLETS).map(([k, w]) => {
          const detected = !!w.getProvider?.();
          return `<div class="wallet-option ${detected ? 'detected' : ''}" onclick="WalletService.connect('${k}')">
            <div class="wallet-option-icon"><img src="${w.icon}" alt="${w.name}"></div>
            <div class="wallet-option-info"><div class="wallet-option-name">${w.name}</div><div class="wallet-option-desc">${detected ? 'Click to connect' : 'Install wallet'}</div></div>
            ${detected ? '<span class="wallet-detected-badge">Detected</span>' : ''}
          </div>`;
        }).join('')}</div>`;
      },
      renderConnected() {
        const a = State.wallet.publicKey;
        return `<div class="connected-wallet">
          <div class="connected-wallet-header"><div class="connected-wallet-avatar"></div><div class="connected-wallet-info"><div class="connected-wallet-label">Connected</div><div class="connected-wallet-address">${Utils.shortenAddress(a, 6)}</div></div></div>
          <div class="connected-wallet-stats"><div class="connected-wallet-stat"><div class="connected-wallet-stat-value">${State.wallet.balance.toFixed(4)} SOL</div><div class="connected-wallet-stat-label">Balance</div></div><div class="connected-wallet-stat"><div class="connected-wallet-stat-value">${Utils.formatNumber(State.wallet.balance * 185)}</div><div class="connected-wallet-stat-label">USD</div></div></div>
          <div class="connected-wallet-actions"><button class="btn btn--secondary" onclick="WalletService.copy()">Copy</button><button class="btn btn--secondary" onclick="window.open('https://solscan.io/account/${a}','_blank')">Explorer</button><button class="btn btn--ghost" onclick="WalletService.disconnect()" style="color:var(--accent-rose)">Disconnect</button></div>
        </div>`;
      },
      update() {
        const btn = document.getElementById('walletBtn'), txt = document.getElementById('walletBtnText');
        if (State.wallet.connected) { btn.classList.add('connected'); txt.innerHTML = `<span style="display:flex;align-items:center;gap:6px"><span style="width:6px;height:6px;background:var(--accent-emerald);border-radius:50%"></span>${Utils.shortenAddress(State.wallet.publicKey, 4)}</span>`; }
        else { btn.classList.remove('connected'); txt.textContent = 'Connect Wallet'; }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // WALLET SERVICE
    // ═══════════════════════════════════════════════════════════════════════════
    const WalletService = {
      async connect(key) {
        const w = WALLETS[key], p = w?.getProvider?.();
        if (!p) { window.open(w.downloadUrl, '_blank'); ToastUI.error('Not Found', `Install ${w.name}`); return; }
        try {
          const r = await p.connect();
          State.wallet = { connected: true, publicKey: r.publicKey?.toString() || p.publicKey?.toString(), provider: p, name: key, balance: 0 };
          await this.fetchBalance();
          WalletUI.update(); WalletUI.close();
          p.on?.('disconnect', () => this.handleDisconnect());
          ToastUI.success('Connected', Utils.shortenAddress(State.wallet.publicKey));
        } catch (e) { ToastUI.error('Failed', e.message || 'Rejected'); }
      },
      async fetchBalance() {
        if (!State.wallet.publicKey) return;
        try {
          const r = await fetch(CONFIG.HELIUS_RPC, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getBalance', params: [State.wallet.publicKey] }) });
          const d = await r.json();
          if (d.result?.value !== undefined) State.wallet.balance = d.result.value / 1e9;
        } catch (e) { console.warn('Balance fetch error:', e); }
      },
      disconnect() { State.wallet.provider?.disconnect?.().catch(() => {}); this.handleDisconnect(); },
      handleDisconnect() { State.wallet = { connected: false, publicKey: null, provider: null, name: null, balance: 0 }; WalletUI.update(); WalletUI.close(); ToastUI.success('Disconnected', 'Wallet disconnected'); },
      copy() { if (State.wallet.publicKey) { navigator.clipboard.writeText(State.wallet.publicKey); ToastUI.success('Copied', 'Address copied'); } },
      async autoConnect() {
        const p = window.phantom?.solana;
        if (p?.isConnected) { try { const r = await p.connect({ onlyIfTrusted: true }); if (r.publicKey) { State.wallet = { connected: true, publicKey: r.publicKey.toString(), provider: p, name: 'phantom', balance: 0 }; await this.fetchBalance(); WalletUI.update(); } } catch (e) {} }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // LIQUIDITY CHART UI
    // ═══════════════════════════════════════════════════════════════════════════
    const LiquidityChartUI = {
      render(pool) {
        if (!pool.bins || pool.bins.length === 0) return '';
        const maxL = Math.max(...pool.bins.map(b => b.liquidity));
        const totL = pool.bins.reduce((s, b) => s + b.liquidity, 0);
        const bins = pool.bins.map((b, i) => `
          <div class="bin ${i === pool.activeBin ? 'active-bin' : ''}" style="height:${(b.liquidity / maxL) * 100}%">
            <div class="bin-tooltip">
              <div class="bin-tooltip-row"><span class="bin-tooltip-label">Price</span><span class="bin-tooltip-value">$${Utils.formatPrice(b.price)}</span></div>
              <div class="bin-tooltip-row"><span class="bin-tooltip-label">Liq</span><span class="bin-tooltip-value">${((b.liquidity / totL) * 100).toFixed(1)}%</span></div>
              <div class="bin-tooltip-row"><span class="bin-tooltip-label">Bin</span><span class="bin-tooltip-value">#${b.id}</span></div>
            </div>
          </div>`).join('');
        return `
          <div class="chart-section">
            <div class="chart-header">
              <span class="chart-title">Liquidity Distribution (21 Bins)</span>
              <div class="chart-legend"><div class="legend-item"><div class="legend-dot liquidity"></div>Liquidity</div><div class="legend-item"><div class="legend-dot active"></div>Active Bin</div></div>
            </div>
            <div class="bins-container">${bins}</div>
            <div class="chart-axis">
              <span class="axis-label">$${Utils.formatPrice(pool.bins[0].price)}</span>
              <span class="axis-label active">$${Utils.formatPrice(pool.bins[pool.activeBin]?.price || pool.currentPrice)}</span>
              <span class="axis-label">$${Utils.formatPrice(pool.bins[20]?.price || pool.bins[pool.bins.length-1]?.price)}</span>
            </div>
          </div>`;
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // POOL TRANSACTIONS UI
    // ═══════════════════════════════════════════════════════════════════════════
    const PoolTxUI = {
      render(poolId) {
        return `
          <div class="pool-tx-section">
            <div class="pool-tx-header">
              <span class="pool-tx-title"><span class="status-dot ${State.wsConnected ? 'live' : ''}"></span>Live Transactions</span>
            </div>
            <div class="pool-tx-list" id="tx-list-${poolId}">${this.renderList(poolId)}</div>
          </div>`;
      },
      renderList(poolId) {
        const txs = State.poolTransactions[poolId] || [];
        if (txs.length === 0) return '<div class="pool-tx-empty">Waiting for transactions...</div>';
        const icons = { add: '+', remove: '-', swap: '⇄' };
        return txs.map(tx => `
          <div class="pool-tx-item">
            <div class="pool-tx-type ${tx.type}">${icons[tx.type]}</div>
            <div class="pool-tx-info"><a href="https://solscan.io/tx/${tx.signature}" target="_blank">${Utils.truncate(tx.signature)}</a></div>
            <div class="pool-tx-amount ${tx.type === 'add' ? 'positive' : tx.type === 'remove' ? 'negative' : ''}">${Utils.formatNumber(parseFloat(tx.amount))}</div>
            <div class="pool-tx-time">${Utils.formatTime(tx.timestamp)}</div>
          </div>`).join('');
      },
      update(poolId) {
        const el = document.getElementById(`tx-list-${poolId}`);
        if (el) el.innerHTML = this.renderList(poolId);
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // POOL CARD UI
    // ═══════════════════════════════════════════════════════════════════════════
    const PoolCardUI = {
      render(pool, rank) {
        const sc = pool.score >= 75 ? 'high' : pool.score >= 55 ? 'medium' : 'low';
        const isExp = State.expandedPoolId === pool.id;
        const addr = pool.address || pool.id;
        
        // Determine correct Meteora URL based on pool type
        const isDLMM = pool.protocol === 'Meteora DLMM';
        const meteoraUrl = isDLMM 
          ? `https://app.meteora.ag/dlmm/${addr}` 
          : `https://app.meteora.ag/pools/${addr}`;
        
        // Pool type short label
        const typeLabel = isDLMM ? 'DLMM' : 'DAMM';
        
        // Badges
        const farmBadge = pool.farmActive ? '<span class="mini-badge farm">🌾 Active</span>' : 
                         pool.hasFarm ? '<span class="mini-badge farm">🌾 Farm</span>' : '';
        const binBadge = pool.binStep > 1 ? `<span class="mini-badge bin">Bin ${pool.binStep}</span>` : '';
        
        return `
          <div class="pool-card score-${sc} ${isExp ? 'expanded' : ''}" id="pool-${pool.id}">
            <div class="pool-rank ${rank <= 3 ? 'top3' : ''}">${rank}</div>
            <div class="pool-card-main" onclick="PoolCardUI.toggle('${pool.id}')">
              <div class="pool-header">
                <div class="pool-pair">
                  <div class="pool-icons"><div class="pool-icon">${pool.icon1}</div><div class="pool-icon">${pool.icon2}</div></div>
                  <div class="pool-info">
                    <h3>${pool.name}<span class="pool-type-badge">${typeLabel}</span></h3>
                  </div>
                </div>
                <div class="pool-badges">
                  <span class="score-badge ${sc}">${pool.score}</span>
                  <span class="safety-dot ${pool.safety}" title="${pool.safety}"></span>
                </div>
              </div>
              <div class="pool-stats">
                <div class="pool-stat"><div class="pool-stat-label">TVL</div><div class="pool-stat-value">${Utils.formatNumber(pool.tvl)}</div></div>
                <div class="pool-stat"><div class="pool-stat-label">Volume</div><div class="pool-stat-value">${Utils.formatNumber(pool.volume)}</div></div>
                <div class="pool-stat"><div class="pool-stat-label">APR</div><div class="pool-stat-value accent">${pool.apr}%</div></div>
                <div class="pool-stat"><div class="pool-stat-label">Fees</div><div class="pool-stat-value">${Utils.formatNumber(pool.fees)}</div></div>
              </div>
              ${farmBadge || binBadge ? `<div class="pool-badges-row">${farmBadge}${binBadge}</div>` : ''}
              <div class="pool-expand-hint">Click to expand</div>
            </div>
            <div class="pool-expanded">
              <div class="pool-expanded-inner">
                <div class="pool-actions">
                  <a href="${meteoraUrl}" target="_blank" class="pool-action-btn primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    View Pool
                  </a>
                  <a href="https://solscan.io/account/${addr}" target="_blank" class="pool-action-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    Solscan
                  </a>
                  <button class="pool-action-btn" onclick="PoolCardUI.copyAddress('${addr}')">
                    ${Utils.copyIcon}
                    Copy Address
                  </button>
                </div>
                ${LiquidityChartUI.render(pool)}
                ${PoolTxUI.render(pool.id)}
                ${this.renderAdvancedInfo(pool)}
              </div>
            </div>
          </div>`;
      },
      
      renderAdvancedInfo(pool) {
        const items = [];
        if (pool.feeBps) items.push(`<div class="adv-item"><span>Fee:</span> ${pool.feeBps}%</div>`);
        if (pool.binStep > 1) items.push(`<div class="adv-item"><span>Bin Step:</span> ${pool.binStep}</div>`);
        if (pool.farmApr && parseFloat(pool.farmApr) > 0) items.push(`<div class="adv-item"><span>Farm APR:</span> +${pool.farmApr}%</div>`);
        if (pool.feeTvlRatio > 0) items.push(`<div class="adv-item"><span>Fee/TVL:</span> ${(pool.feeTvlRatio * 100).toFixed(3)}%</div>`);
        if (pool.cumulativeTradeVolume > 0) items.push(`<div class="adv-item"><span>All-time Vol:</span> ${Utils.formatNumber(pool.cumulativeTradeVolume)}</div>`);
        if (pool.creator) items.push(`<div class="adv-item"><span>Creator:</span> ${Utils.shortenAddress(pool.creator, 6)}</div>`);
        
        if (items.length === 0) return '';
        
        return `
          <div class="pool-advanced-info">
            <h4>Details</h4>
            <div class="advanced-grid">${items.join('')}</div>
          </div>`;
      },
      
      toggle(poolId) {
        // Close previously expanded pool card
        if (State.expandedPoolId && State.expandedPoolId !== poolId) {
          const prev = document.getElementById(`pool-${State.expandedPoolId}`);
          if (prev) prev.classList.remove('expanded');
        }
        // Close any expanded opportunity card
        if (State.expandedOppId) {
          const prevOpp = document.getElementById(`opp-${State.expandedOppId}`);
          if (prevOpp) prevOpp.classList.remove('expanded');
          State.expandedOppId = null;
        }
        // Toggle current
        const card = document.getElementById(`pool-${poolId}`);
        if (!card) return;
        if (State.expandedPoolId === poolId) {
          card.classList.remove('expanded');
          State.expandedPoolId = null;
        } else {
          card.classList.add('expanded');
          State.expandedPoolId = poolId;
        }
      },
      copyAddress(addr) {
        navigator.clipboard.writeText(addr);
        ToastUI.success('Copied', 'Pool address copied');
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // POOLS GRID UI
    // ═══════════════════════════════════════════════════════════════════════════
    const PoolsGridUI = {
      render() {
        const container = document.getElementById('poolsContainer');
        if (!container) return;
        if (State.filteredPools.length === 0) {
          container.innerHTML = '<div class="alert-empty" style="text-align:center;padding:40px;column-span:all"><div class="loading-spinner"></div><p style="margin-top:12px">Loading pools...</p></div>';
          return;
        }
        container.innerHTML = State.filteredPools.map((p, i) => PoolCardUI.render(p, i + 1)).join('');
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // OPPORTUNITY CARD UI - EXPANDABLE WITH CHARTS
    // ═══════════════════════════════════════════════════════════════════════════
    const OppCardUI = {
      render(opp) {
        const isExp = State.expandedOppId === opp.id;
        const addr = opp.address || opp.id;
        const isDLMM = opp.protocol === 'Meteora DLMM';
        const meteoraUrl = isDLMM 
          ? `https://app.meteora.ag/dlmm/${addr}` 
          : `https://app.meteora.ag/pools/${addr}`;
        const typeLabel = isDLMM ? 'DLMM' : 'DAMM';
        
        return `
          <div class="opp-card ${isExp ? 'expanded' : ''}" id="opp-${opp.id}">
            <div class="opp-card-main" onclick="OppCardUI.toggle('${opp.id}')">
              <div class="opp-header">
                <div class="opp-pool">
                  <div class="opp-pool-icons"><div class="opp-pool-icon">${opp.icon1}</div><div class="opp-pool-icon">${opp.icon2}</div></div>
                  <div class="opp-pool-info"><h3>${opp.name}<span class="pool-type-badge">${typeLabel}</span></h3></div>
                </div>
                <div class="opp-score"><div class="opp-score-value">${opp.score}</div><div class="opp-score-label">Score</div></div>
              </div>
              <div class="opp-metrics">
                <div class="opp-metric"><div class="opp-metric-value">${Utils.formatNumber(opp.tvl)}</div><div class="opp-metric-label">TVL</div></div>
                <div class="opp-metric"><div class="opp-metric-value">${Utils.formatNumber(opp.volume)}</div><div class="opp-metric-label">Volume</div></div>
                <div class="opp-metric"><div class="opp-metric-value positive">${opp.apr}%</div><div class="opp-metric-label">APR</div></div>
                <div class="opp-metric"><div class="opp-metric-value">${(opp.volumeToTvl * 100).toFixed(0)}%</div><div class="opp-metric-label">Vol/TVL</div></div>
              </div>
              <div class="opp-reason"><div class="opp-reason-title">⚡ Opportunity</div><div class="opp-reason-text">${opp.reason}</div></div>
              <div class="opp-expand-hint">Click to expand</div>
            </div>
            <div class="opp-expanded">
              <div class="opp-expanded-inner">
                <div class="pool-actions">
                  <a href="${meteoraUrl}" target="_blank" class="pool-action-btn primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    View Pool
                  </a>
                  <a href="https://solscan.io/account/${addr}" target="_blank" class="pool-action-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    Solscan
                  </a>
                  <button class="pool-action-btn" onclick="OppCardUI.copyAddress('${addr}')">
                    ${Utils.copyIcon}
                    Copy Address
                  </button>
                </div>
                ${LiquidityChartUI.render(opp)}
                ${PoolTxUI.render(opp.id)}
              </div>
            </div>
          </div>`;
      },
      toggle(oppId) {
        // Close previously expanded opportunity card
        if (State.expandedOppId && State.expandedOppId !== oppId) {
          const prev = document.getElementById(`opp-${State.expandedOppId}`);
          if (prev) prev.classList.remove('expanded');
        }
        // Close any expanded pool card
        if (State.expandedPoolId) {
          const prevPool = document.getElementById(`pool-${State.expandedPoolId}`);
          if (prevPool) prevPool.classList.remove('expanded');
          State.expandedPoolId = null;
        }
        // Toggle current
        const card = document.getElementById(`opp-${oppId}`);
        if (!card) return;
        if (State.expandedOppId === oppId) {
          card.classList.remove('expanded');
          State.expandedOppId = null;
        } else {
          card.classList.add('expanded');
          State.expandedOppId = oppId;
        }
      },
      copyAddress(addr) {
        navigator.clipboard.writeText(addr);
        ToastUI.success('Copied', 'Pool address copied');
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // OPPORTUNITIES UI
    // ═══════════════════════════════════════════════════════════════════════════
    const OpportunityUI = {
      render() {
        const list = document.getElementById('opportunitiesList');
        if (!list) return;
        if (State.opportunities.length === 0) {
          list.innerHTML = '<div class="alert-empty">No high-probability opportunities detected. Adjust filters or wait for market conditions to change.</div>';
          return;
        }
        list.innerHTML = State.opportunities.map(o => OppCardUI.render(o)).join('');
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // ALERTS UI
    // ═══════════════════════════════════════════════════════════════════════════
    const AlertsUI = {
      populateDropdown() {
        const sel = document.getElementById('alertPool');
        if (sel && State.filteredPools.length > 0) sel.innerHTML = State.filteredPools.slice(0, 40).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      },
      add() {
        const poolId = document.getElementById('alertPool')?.value, cond = document.getElementById('alertCondition')?.value, val = parseFloat(document.getElementById('alertValue')?.value);
        if (!poolId || !cond || isNaN(val)) return;
        const pool = State.pools.find(p => p.id === poolId);
        State.alerts.push({ id: Date.now(), poolId, poolName: pool?.name || 'Unknown', condition: cond, value: val, active: true });
        document.getElementById('alertValue').value = '';
        this.render();
        ToastUI.success('Alert Added', `${pool?.name || 'Pool'} alert created`);
      },
      addForAll() {
        const cond = document.getElementById('alertCondition')?.value, val = parseFloat(document.getElementById('alertValue')?.value);
        if (!cond || isNaN(val)) { ToastUI.error('Missing Value', 'Enter a value'); return; }
        let count = 0;
        State.filteredPools.slice(0, 20).forEach(p => { if (!State.alerts.find(a => a.poolId === p.id && a.condition === cond)) { State.alerts.push({ id: Date.now() + Math.random(), poolId: p.id, poolName: p.name, condition: cond, value: val, active: true }); count++; } });
        this.render();
        ToastUI.success('Alerts Added', `${count} alerts created`);
      },
      toggle(id, e) { if (e) e.stopPropagation(); const a = State.alerts.find(x => x.id === id); if (a) a.active = !a.active; this.render(); },
      remove(id, e) { if (e) e.stopPropagation(); State.alerts = State.alerts.filter(x => x.id !== id); this.render(); },
      clearAll() { State.alerts = []; this.render(); ToastUI.success('Cleared', 'All alerts removed'); },
      render() {
        const list = document.getElementById('alertList');
        if (!list) return;
        if (State.alerts.length === 0) { list.innerHTML = '<div class="alert-empty">No alerts configured.</div>'; return; }
        list.innerHTML = State.alerts.map(a => `<div class="alert-item"><div class="alert-info"><div class="alert-icon ${a.condition.includes('above') ? 'up' : 'down'}">${a.condition.includes('above') ? '↑' : '↓'}</div><div class="alert-details"><h4>${a.poolName}</h4><p>${a.condition.replace('-', ' ')} ${a.condition.includes('tvl') ? Utils.formatNumber(a.value) : '$' + a.value}</p></div></div><div class="alert-actions"><button class="toggle ${a.active ? 'active' : ''}" onclick="AlertsUI.toggle(${a.id},event)"></button><button class="btn btn--ghost" onclick="AlertsUI.remove(${a.id},event)">✕</button></div></div>`).join('');
      },
      refreshAI() {
        State.aiSuggestions = State.filteredPools.filter(p => p.safety === 'safe' && (p.volumeToTvl > 0.4 || parseFloat(p.apr) > 50)).slice(0, 4).map(p => ({ pool: p, reason: p.volumeToTvl > 0.4 ? 'High trading volume detected' : `Strong ${p.apr}% APR`, condition: 'price-above', value: (p.currentPrice * 1.05).toFixed(4) }));
        this.renderAI();
      },
      renderAI() {
        const c = document.getElementById('aiSuggestions');
        if (!c) return;
        if (State.aiSuggestions.length === 0) { c.innerHTML = '<div style="text-align:center;padding:12px;color:var(--text-muted);font-size:10px">Click Refresh for AI-generated suggestions based on current market data.</div>'; return; }
        c.innerHTML = State.aiSuggestions.map(s => `<div class="ai-suggestion"><div class="ai-suggestion-info"><div class="ai-suggestion-pool">${s.pool.name} - price above $${s.value}</div><div class="ai-suggestion-reason">${s.reason}</div></div><div class="ai-suggestion-actions"><button class="btn btn--success" onclick="AlertsUI.acceptAI('${s.pool.id}','${s.condition}',${s.value})">Accept</button><button class="btn btn--ghost" onclick="this.parentElement.parentElement.remove()">✕</button></div></div>`).join('');
      },
      acceptAI(poolId, cond, val) {
        const pool = State.pools.find(p => p.id === poolId);
        if (pool && !State.alerts.find(a => a.poolId === poolId && a.condition === cond)) { State.alerts.push({ id: Date.now(), poolId, poolName: pool.name, condition: cond, value: val, active: true }); this.render(); ToastUI.success('Added', `${pool.name} alert created`); }
        State.aiSuggestions = State.aiSuggestions.filter(s => s.pool.id !== poolId);
        this.renderAI();
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // DATA SERVICE
    // ═══════════════════════════════════════════════════════════════════════════
    const DataService = {
      async fetchJupiter() {
        try {
          const r = await fetch(CONFIG.JUPITER_TOKENS);
          if (!r.ok) throw new Error('Jupiter API failed');
          const tokens = await r.json();
          // Handle both array format and object with tokens property
          const tokenList = Array.isArray(tokens) ? tokens : (tokens.tokens || []);
          tokenList.forEach(t => State.verifiedTokens.add(t.address || t.mint));
          StatusUI.setApi('jupiter', true);
          console.log(`Loaded ${State.verifiedTokens.size} verified tokens from Jupiter`);
        } catch (e) {
          console.warn('Jupiter fallback:', e.message);
          StatusUI.setApi('jupiter', false);
          // Fallback common verified tokens
          ['So11111111111111111111111111111111111111112', 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB', 'JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN', 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263'].forEach(t => State.verifiedTokens.add(t));
        }
      },
      
      async fetchPools() {
        try {
          StatusUI.set('loading', 'Fetching pools from multiple sources...');
          
          // Fetch BOTH DLMM and DAMM v2 in parallel
          const [dlmmResult, dammResult] = await Promise.allSettled([
            fetch('https://dlmm-api.meteora.ag/pair/all').then(r => {
              if (!r.ok) throw new Error(`DLMM HTTP ${r.status}`);
              return r.json();
            }),
            fetch('https://dammv2-api.meteora.ag/pools?limit=200&order_by=tvl&order=desc').then(r => {
              if (!r.ok) throw new Error(`DAMM v2 HTTP ${r.status}`);
              return r.json();
            })
          ]);
          
          let allPools = [];
          const seenAddresses = new Set();
          let sources = [];
          
          // Process DLMM pools (priority - has bin_step, farm_apr, timeframe data)
          if (dlmmResult.status === 'fulfilled' && Array.isArray(dlmmResult.value)) {
            const dlmmPools = dlmmResult.value
              .filter(p => p.name && p.address && !p.hide && !p.is_blacklisted && parseFloat(p.liquidity || 0) > 100)
              .map(p => this.processDLMM(p));
            
            dlmmPools.forEach(p => {
              if (!seenAddresses.has(p.address)) {
                seenAddresses.add(p.address);
                allPools.push(p);
              }
            });
            sources.push(`DLMM: ${dlmmPools.length}`);
            console.log(`✓ Loaded ${dlmmPools.length} pools from DLMM API`);
          } else {
            console.warn('✗ DLMM API failed:', dlmmResult.reason || 'Unknown error');
          }
          
          // Process DAMM v2 pools (adds unique pools not in DLMM)
          if (dammResult.status === 'fulfilled' && dammResult.value?.data) {
            const dammPools = dammResult.value.data
              .filter(p => p.pool_address && (p.tvl || 0) > 100)
              .map(p => this.processDAMMv2(p));
            
            let addedCount = 0;
            dammPools.forEach(p => {
              if (!seenAddresses.has(p.address)) {
                seenAddresses.add(p.address);
                allPools.push(p);
                addedCount++;
              }
            });
            sources.push(`DAMM v2: +${addedCount}`);
            console.log(`✓ Added ${addedCount} unique pools from DAMM v2 API`);
          } else {
            console.warn('✗ DAMM v2 API failed:', dammResult.reason || 'Unknown error');
          }
          
          // If both failed, try fallbacks
          if (allPools.length === 0) {
          console.warn('Both Meteora APIs failed, trying fallbacks...');
          StatusUI.setApi('meteora', false);
          
          // Try DexScreener
          try {
            const dxr = await fetch('https://api.dexscreener.com/latest/dex/search?q=meteora');
            if (dxr.ok) {
              const dxData = await dxr.json();
              if (dxData.pairs?.length > 0) {
                allPools = dxData.pairs
                  .filter(p => p.dexId === 'meteora' && p.liquidity?.usd > 100)
                  .slice(0, 150)
                  .map(p => this.processDexScreener(p));
                sources.push(`DexScreener (${allPools.length})`);
              }
            }
          } catch (dx) { console.warn('DexScreener failed:', dx); }
          
          // Try GeckoTerminal if still empty
          if (allPools.length === 0) {
            try {
              const gtr = await fetch('https://api.geckoterminal.com/api/v2/networks/solana/dexes/meteora-dlmm/pools?page=1');
              if (gtr.ok) {
                const gtData = await gtr.json();
                if (gtData.data?.length > 0) {
                  allPools = gtData.data
                    .filter(p => parseFloat(p.attributes?.reserve_in_usd || 0) > 100)
                    .slice(0, 150)
                    .map(p => this.processGeckoTerminal(p));
                  sources.push(`GeckoTerminal (${allPools.length})`);
                }
              }
            } catch (gt) { console.warn('GeckoTerminal failed:', gt); }
          }
        }
        
        if (allPools.length === 0) {
          StatusUI.set('error', 'All sources failed - retrying in 30s');
          return;
        }
        
        // Sort by score and limit
        State.pools = allPools.sort((a, b) => b.score - a.score).slice(0, 200);
        State.pools.forEach(p => { if (!State.poolTransactions[p.id]) State.poolTransactions[p.id] = []; });
        
        StatusUI.setApi('meteora', true);
        this.applyFilters();
        this.detectOpportunities();
        
        // Show pool count with source breakdown
        const dlmmCount = State.pools.filter(p => p.protocol === 'Meteora DLMM').length;
        const dammCount = State.pools.filter(p => p.protocol === 'Meteora DAMM v2').length;
        const sourceInfo = sources.length > 0 ? ` [${sources.join(' | ')}]` : '';
        StatusUI.set('live', `${State.filteredPools.length} pools${sourceInfo}`);
        console.log(`✓ Total: ${State.pools.length} pools (DLMM: ${dlmmCount}, DAMM v2: ${dammCount})`);
        
      } catch (err) {
        console.error('fetchPools error:', err);
        StatusUI.set('error', 'Error loading pools - retrying...');
        setTimeout(() => this.fetchPools(), 10000);
      }
      },
      
      processDexScreener(p) {
        const xV = State.verifiedTokens.has(p.baseToken?.address || '');
        const yV = State.verifiedTokens.has(p.quoteToken?.address || '');
        let safety = 'warning';
        if (xV && yV) safety = 'safe';
        else if (!xV && !yV && (p.liquidity?.usd || 0) < 10000) safety = 'danger';
        let score = 50;
        const tvl = p.liquidity?.usd || 0, vol = p.volume?.h24 || 0;
        if (tvl > 500000) score += 20; else if (tvl > 100000) score += 15; else if (tvl > 10000) score += 10;
        if (vol > 100000) score += 15; else if (vol > 10000) score += 10; else if (vol > 1000) score += 5;
        const apr = tvl > 0 ? (vol / tvl * 365 * 0.003 * 100) : 0;
        if (apr > 100) score += 10; else if (apr > 50) score += 7; else if (apr > 20) score += 4;
        if (safety === 'safe') score += 5; else if (safety === 'danger') score -= 15;
        score = Math.min(99, Math.max(10, Math.round(score)));
        return {
          id: p.pairAddress, address: p.pairAddress,
          name: `${p.baseToken?.symbol || '?'}/${p.quoteToken?.symbol || '?'}`,
          protocol: 'Meteora', mintX: p.baseToken?.address, mintY: p.quoteToken?.address,
          tvl, volume: vol, apr: apr.toFixed(2), fees: vol * 0.003, feeBps: 0.3, binStep: 1,
          currentPrice: parseFloat(p.priceUsd) || 1, safety, score,
          bins: this.generateBins(parseFloat(p.priceUsd) || 1), activeBin: 10,
          icon1: (p.baseToken?.symbol || '?').slice(0, 4), icon2: (p.quoteToken?.symbol || '?').slice(0, 4),
          icon1Url: p.baseToken?.info?.imageUrl, icon2Url: p.quoteToken?.info?.imageUrl,
          volumeToTvl: tvl > 0 ? vol / tvl : 0
        };
      },
      
      processGeckoTerminal(p) {
        const a = p.attributes || {};
        const tvl = parseFloat(a.reserve_in_usd) || 0, vol = parseFloat(a.volume_usd?.h24) || 0;
        const xV = State.verifiedTokens.has(a.base_token_address || '');
        const yV = State.verifiedTokens.has(a.quote_token_address || '');
        let safety = 'warning';
        if (xV && yV) safety = 'safe';
        else if (!xV && !yV && tvl < 10000) safety = 'danger';
        let score = 50;
        if (tvl > 500000) score += 20; else if (tvl > 100000) score += 15; else if (tvl > 10000) score += 10;
        if (vol > 100000) score += 15; else if (vol > 10000) score += 10; else if (vol > 1000) score += 5;
        const apr = tvl > 0 ? (vol / tvl * 365 * 0.003 * 100) : 0;
        if (apr > 100) score += 10; else if (apr > 50) score += 7; else if (apr > 20) score += 4;
        if (safety === 'safe') score += 5; else if (safety === 'danger') score -= 15;
        score = Math.min(99, Math.max(10, Math.round(score)));
        const nm = (a.name || 'Unknown').split(/[\/\-]/);
        return {
          id: p.id?.split('_')[1] || p.id, address: p.id?.split('_')[1] || p.id,
          name: a.name || 'Unknown', protocol: 'Meteora',
          mintX: a.base_token_address, mintY: a.quote_token_address,
          tvl, volume: vol, apr: apr.toFixed(2), fees: vol * 0.003, feeBps: 0.3, binStep: 1,
          currentPrice: parseFloat(a.base_token_price_usd) || 1, safety, score,
          bins: this.generateBins(parseFloat(a.base_token_price_usd) || 1), activeBin: 10,
          icon1: (nm[0] || '?').trim().slice(0, 4), icon2: (nm[1] || '?').trim().slice(0, 4),
          volumeToTvl: tvl > 0 ? vol / tvl : 0
        };
      },
      
      processDAMMv2(p) {
        // All fields from DAMM v2 API
        const tvl = parseFloat(p.tvl) || 0;
        const volume = parseFloat(p.volume24h) || 0;
        const apr = parseFloat(p.apr) || 0;
        const fees = parseFloat(p.fee24h) || 0;
        const mintX = p.token_a_mint || '', mintY = p.token_b_mint || '';
        const xV = State.verifiedTokens.has(mintX), yV = State.verifiedTokens.has(mintY);
        
        // Use API's tokens_verified if available, otherwise check locally
        let safety = 'warning';
        if (p.tokens_verified || (xV && yV)) safety = 'safe';
        else if (!xV && !yV && tvl < 10000) safety = 'danger';
        
        // Enhanced scoring with DAMM v2 fields
        let score = 50;
        if (tvl > 500000) score += 20; else if (tvl > 100000) score += 15; else if (tvl > 10000) score += 10;
        if (volume > 100000) score += 15; else if (volume > 10000) score += 10; else if (volume > 1000) score += 5;
        if (apr > 100) score += 10; else if (apr > 50) score += 7; else if (apr > 20) score += 4;
        if (safety === 'safe') score += 5; else if (safety === 'danger') score -= 15;
        if (p.has_farm) score += 3; // Bonus for having farm
        if (p.farm_active) score += 5; // Bonus for active farm
        if (parseFloat(p.permanent_lock_liquidity || 0) > 0) score += 3; // Bonus for locked liquidity
        score = Math.min(99, Math.max(10, Math.round(score)));
        
        const currentPrice = parseFloat(p.pool_price) || 1;
        const name = p.pool_name || `${p.token_a_symbol || '?'}/${p.token_b_symbol || '?'}`;
        
        return {
          id: p.pool_address,
          address: p.pool_address,
          name,
          protocol: 'Meteora DAMM v2',
          mintX, mintY,
          tvl, volume, 
          apr: apr.toFixed(2), 
          fees,
          // New DAMM v2 fields
          baseFee: parseFloat(p.base_fee) || 0,
          dynamicFee: parseFloat(p.dynamic_fee) || 0,
          feeTvlRatio: parseFloat(p.fee_tvl_ratio) || 0,
          hasFarm: p.has_farm || false,
          farmActive: p.farm_active || false,
          tokensVerified: p.tokens_verified || false,
          creator: p.creator || null,
          alphaVault: p.alpha_vault || null,
          launchpad: p.launchpad || null,
          poolType: p.pool_type,
          permanentLockLiquidity: parseFloat(p.permanent_lock_liquidity) || 0,
          virtualPrice: parseFloat(p.virtual_price) || 0,
          minPrice: parseFloat(p.min_price) || 0,
          maxPrice: parseFloat(p.max_price) || 0,
          sqrtPrice: parseFloat(p.sqrt_price) || 0,
          tokenAAmount: parseFloat(p.token_a_amount) || 0,
          tokenAAmountUsd: parseFloat(p.token_a_amount_usd) || 0,
          tokenBAmount: parseFloat(p.token_b_amount) || 0,
          tokenBAmountUsd: parseFloat(p.token_b_amount_usd) || 0,
          tokenAVault: p.token_a_vault,
          tokenBVault: p.token_b_vault,
          createdAt: p.created_at_slot_timestamp ? new Date(p.created_at_slot_timestamp * 1000) : null,
          updatedAt: p.updated_at ? new Date(p.updated_at * 1000) : null,
          collectFeeMode: p.collect_fee_mode,
          feeSchedulerMode: p.fee_scheduler_mode,
          // Standard fields
          feeBps: parseFloat(p.base_fee) || 0,
          binStep: 1,
          currentPrice,
          safety, score,
          bins: this.generateBins(currentPrice),
          activeBin: 10,
          icon1: (p.token_a_symbol || name.split('/')[0] || '?').slice(0, 4),
          icon2: (p.token_b_symbol || name.split('/')[1] || '?').slice(0, 4),
          volumeToTvl: tvl > 0 ? volume / tvl : 0
        };
      },
      
      processDLMM(raw) {
        // All fields from DLMM API: https://dlmm-api.meteora.ag/pair/all
        const tvl = parseFloat(raw.liquidity) || 0;
        const volume = parseFloat(raw.trade_volume_24h) || 0;
        const apr = parseFloat(raw.apr) || 0;
        const apy = parseFloat(raw.apy) || 0;
        const fees = parseFloat(raw.fees_24h) || 0;
        const todayFees = parseFloat(raw.today_fees) || 0;
        const mintX = raw.mint_x || '', mintY = raw.mint_y || '';
        
        // Use API's is_verified field or check locally
        const xV = State.verifiedTokens.has(mintX), yV = State.verifiedTokens.has(mintY);
        const apiVerified = raw.is_verified === true;
        
        let safety = 'warning';
        if (apiVerified || (xV && yV)) safety = 'safe';
        else if (raw.is_blacklisted) safety = 'danger';
        else if (!xV && !yV && tvl < 10000) safety = 'danger';
        
        // Farm APR/APY from DLMM
        const farmApr = parseFloat(raw.farm_apr) || 0;
        const farmApy = parseFloat(raw.farm_apy) || 0;
        const hasFarm = farmApr > 0 || farmApy > 0 || !!raw.reward_mint_x || !!raw.reward_mint_y;
        const farmActive = farmApr > 0;
        
        // Fee/TVL ratios (multiple timeframes)
        const feeTvlRatio = raw.fee_tvl_ratio?.hour_24 || 0;
        const feeTvlRatio1h = raw.fee_tvl_ratio?.hour_1 || 0;
        
        // Enhanced scoring with DLMM fields
        let score = 50;
        if (tvl > 500000) score += 20; else if (tvl > 100000) score += 15; else if (tvl > 10000) score += 10;
        if (volume > 100000) score += 15; else if (volume > 10000) score += 10; else if (volume > 1000) score += 5;
        if (apr > 100) score += 10; else if (apr > 50) score += 7; else if (apr > 20) score += 4;
        if (safety === 'safe') score += 5; else if (safety === 'danger') score -= 15;
        if (hasFarm) score += 3;
        if (farmActive) score += 5;
        if (apiVerified) score += 3;
        score = Math.min(99, Math.max(10, Math.round(score)));
        
        const currentPrice = parseFloat(raw.current_price) || 1;
        const binStep = parseInt(raw.bin_step) || 1;
        
        return {
          id: raw.address,
          address: raw.address,
          name: raw.name || 'Unknown',
          protocol: 'Meteora DLMM',
          mintX, mintY,
          tvl, volume, 
          apr: apr.toFixed(2), 
          apy: apy.toFixed(2),
          fees,
          todayFees,
          feeBps: parseFloat(raw.base_fee_percentage) || 0,
          maxFeeBps: parseFloat(raw.max_fee_percentage) || 0,
          protocolFeeBps: parseFloat(raw.protocol_fee_percentage) || 0,
          binStep,
          currentPrice,
          safety, score,
          bins: this.generateBins(currentPrice),
          activeBin: parseInt(raw.active_id) || 10,
          icon1: raw.name?.split('/')[0]?.trim().slice(0, 4) || '?',
          icon2: raw.name?.split('/')[1]?.trim().slice(0, 4) || '?',
          volumeToTvl: tvl > 0 ? volume / tvl : 0,
          
          // DLMM-specific rich fields
          hasFarm,
          farmActive,
          farmApr: farmApr.toFixed(2),
          farmApy: farmApy.toFixed(2),
          rewardMintX: raw.reward_mint_x,
          rewardMintY: raw.reward_mint_y,
          
          // Fee/TVL ratios (multiple timeframes)
          feeTvlRatio,
          feeTvlRatio1h,
          fees1h: raw.fees?.hour_1 || 0,
          fees4h: raw.fees?.hour_4 || 0,
          fees12h: raw.fees?.hour_12 || 0,
          
          // Reserves
          reserveX: raw.reserve_x,
          reserveY: raw.reserve_y,
          reserveXAmount: parseFloat(raw.reserve_x_amount) || 0,
          reserveYAmount: parseFloat(raw.reserve_y_amount) || 0,
          
          // Cumulative stats
          cumulativeFeeVolume: parseFloat(raw.cumulative_fee_volume) || 0,
          cumulativeTradeVolume: parseFloat(raw.cumulative_trade_volume) || 0,
          
          // Metadata
          tags: raw.tags || [],
          tokensVerified: apiVerified,
          isBlacklisted: raw.is_blacklisted || false,
          hide: raw.hide || false
        };
      },
      
      // Legacy processPool - kept for compatibility
      processPool(raw) {
        return this.processDLMM(raw);
      },
      
      generateBins(basePrice) {
        const bins = [];
        for (let i = 0; i < 21; i++) {
          const dist = Math.abs(i - 10);
          bins.push({
            id: 1000 + i,
            price: basePrice + (i - 10) * basePrice * 0.0025,
            liquidity: Math.max(5, 100 - dist * 6 + Math.random() * 12),
            volume: Math.floor(Math.random() * 30000)
          });
        }
        return bins;
      },
      
      applyFilters() {
        const minTVL = parseFloat(document.getElementById('filterMinTVL')?.value) || 0;
        const minVol = parseFloat(document.getElementById('filterMinVolume')?.value) || 0;
        const sf = document.getElementById('filterSafety')?.value || 'all';
        const farmFilter = document.getElementById('filterFarm')?.value || 'all';
        const poolType = document.getElementById('filterPoolType')?.value || 'all';
        const sort = document.getElementById('filterSort')?.value || 'score';
        
        let f = [...State.pools];
        
        // Only show active pools with trading activity (volume > 0)
        f = f.filter(p => p.volume > 0);
        
        if (minTVL > 0) f = f.filter(p => p.tvl >= minTVL);
        if (minVol > 0) f = f.filter(p => p.volume >= minVol);
        if (State.jupshieldEnabled) f = f.filter(p => p.safety !== 'danger');
        if (sf === 'safe') f = f.filter(p => p.safety === 'safe');
        else if (sf === 'exclude-danger') f = f.filter(p => p.safety !== 'danger');
        
        // Farm filter
        if (farmFilter === 'active') f = f.filter(p => p.farmActive);
        else if (farmFilter === 'has') f = f.filter(p => p.hasFarm || p.farmActive);
        
        // Pool type filter
        if (poolType === 'dlmm') f = f.filter(p => p.protocol === 'Meteora DLMM');
        else if (poolType === 'damm') f = f.filter(p => p.protocol === 'Meteora DAMM v2');
        
        f.sort((a, b) => {
          switch (sort) {
            case 'tvl': return b.tvl - a.tvl;
            case 'volume': return b.volume - a.volume;
            case 'apr': return parseFloat(b.apr) - parseFloat(a.apr);
            case 'fees': return (b.fees || 0) - (a.fees || 0);
            case 'feeTvl': return (b.feeTvlRatio || 0) - (a.feeTvlRatio || 0);
            default: return b.score - a.score;
          }
        });
        
        State.filteredPools = f;
      },
      
      detectOpportunities() {
        const opps = State.filteredPools.filter(p => 
          (p.volumeToTvl > 0.3 && p.safety === 'safe' && p.tvl > 20000) ||
          (parseFloat(p.apr) > 30 && p.safety === 'safe' && p.score >= 65) ||
          (p.score >= 80 && p.safety === 'safe') ||
          (p.farmActive && p.safety === 'safe' && p.tvl > 10000) ||
          (p.feeTvlRatio > 0.01 && p.safety === 'safe')
        ).slice(0, 10).map(p => {
          let reason = '', actions = [];
          
          // Farm opportunity
          if (p.farmActive) {
            reason = `Active farm rewards available! ${p.apr}% base APR + farming incentives. ${p.tokensVerified ? 'Verified tokens.' : ''}`;
            actions = [
              { title: 'Farm + LP', desc: 'Provide liquidity and stake LP tokens for dual rewards' },
              { title: 'Calculate Total APY', desc: 'Combine base APR with farm rewards for true returns' }
            ];
          }
          // High volume opportunity
          else if (p.volumeToTvl > 0.5) {
            reason = `Exceptional trading activity with ${(p.volumeToTvl * 100).toFixed(0)}% volume-to-TVL ratio. High fee generation potential.`;
            actions = [
              { title: 'Concentrated LP', desc: 'Place liquidity in bins near active price for maximum fee capture' },
              { title: 'Monitor Bin Migration', desc: 'Track price movement to rebalance positions optimally' }
            ];
          }
          // High APR opportunity
          else if (parseFloat(p.apr) > 50) {
            reason = `Strong ${p.apr}% APR with ${p.tokensVerified ? 'verified tokens' : 'token pair'}. Fee/TVL ratio: ${(p.feeTvlRatio * 100 || 0).toFixed(2)}%`;
            actions = [
              { title: 'Wide Range Position', desc: 'Spread liquidity across multiple bins for steady returns' },
              { title: 'Set Price Alerts', desc: 'Get notified when price approaches range boundaries' }
            ];
          }
          // High fee efficiency
          else if (p.feeTvlRatio > 0.01) {
            reason = `High fee efficiency at ${(p.feeTvlRatio * 100).toFixed(2)}% fee/TVL ratio. ${Utils.formatNumber(p.fees)} in 24h fees.`;
            actions = [
              { title: 'Targeted LP', desc: 'Focus liquidity around active price bins for fee optimization' },
              { title: 'Track Fee Trends', desc: 'Monitor fee generation patterns for entry timing' }
            ];
          }
          // General top performer
          else {
            reason = `Top performer with score ${p.score}. ${p.tokensVerified ? 'Verified tokens, ' : ''}healthy TVL, and balanced metrics.`;
            actions = [
              { title: 'Balanced LP', desc: 'Add liquidity around current price with moderate range' },
              { title: 'Auto-Compound', desc: 'Reinvest earned fees periodically to maximize returns' }
            ];
          }
          
          return { ...p, reason, actions };
        });
        State.opportunities = opps;
        StatusUI.updateBadges();
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // WEBSOCKET SERVICE - Multi-source with fallback
    // ═══════════════════════════════════════════════════════════════════════════
    const WS_SOURCES = [
      { name: 'Helius', url: 'wss://mainnet.helius-rpc.com/?api-key=66097387-f0e6-4f93-a800-dbaac4a4c113', errors: 0 },
      { name: 'Solana', url: 'wss://api.mainnet-beta.solana.com', errors: 0 }
    ];
    
    const WSService = {
      currentIdx: 0,
      
      connect() {
        this.trySource(this.currentIdx);
      },
      
      trySource(idx) {
        const source = WS_SOURCES[idx];
        if (!source) {
          console.warn('All WebSocket sources failed, retrying first...');
          WS_SOURCES.forEach(s => s.errors = Math.max(0, s.errors - 1));
          this.currentIdx = 0;
          setTimeout(() => this.connect(), CONFIG.WS_RECONNECT_DELAY * 2);
          return;
        }
        
        if (source.errors >= 3) {
          this.currentIdx = (idx + 1) % WS_SOURCES.length;
          this.trySource(this.currentIdx);
          return;
        }
        
        try {
          if (State.wsConnection) State.wsConnection.close();
          
          console.log(`Connecting to WebSocket: ${source.name}`);
          State.wsConnection = new WebSocket(source.url);
          
          State.wsConnection.onopen = () => {
            console.log(`WebSocket connected: ${source.name}`);
            State.wsConnected = true;
            State.currentWsSource = source.name;
            source.errors = 0;
            StatusUI.setApi('helius', true);
            
            State.wsConnection.send(JSON.stringify({
              jsonrpc: '2.0', id: 1, method: 'logsSubscribe',
              params: [{ mentions: [CONFIG.METEORA_PROGRAM] }, { commitment: 'confirmed' }]
            }));
          };
          
          State.wsConnection.onmessage = (e) => {
            try {
              const d = JSON.parse(e.data);
              if (d.method === 'logsNotification') this.processLog(d.params.result);
            } catch (err) {}
          };
          
          State.wsConnection.onerror = () => {
            console.warn(`WebSocket error: ${source.name}`);
            source.errors++;
            State.wsConnected = false;
            StatusUI.setApi('helius', false);
          };
          
          State.wsConnection.onclose = () => {
            console.log(`WebSocket closed: ${source.name}`);
            State.wsConnected = false;
            State.currentWsSource = null;
            StatusUI.setApi('helius', false);
            this.currentIdx = (this.currentIdx + 1) % WS_SOURCES.length;
            setTimeout(() => this.connect(), CONFIG.WS_RECONNECT_DELAY);
          };
          
        } catch (e) {
          console.error(`WebSocket setup error: ${source.name}`, e);
          source.errors++;
          this.currentIdx = (this.currentIdx + 1) % WS_SOURCES.length;
          setTimeout(() => this.connect(), CONFIG.WS_RECONNECT_DELAY);
        }
      },
      
      processLog(result) {
        const logs = result.value?.logs || [];
        const sig = result.value?.signature;
        
        let type = 'swap';
        if (logs.some(l => l.toLowerCase().includes('addliquidity') || l.includes('add_liquidity'))) type = 'add';
        else if (logs.some(l => l.toLowerCase().includes('removeliquidity') || l.includes('remove_liquidity'))) type = 'remove';
        
        // Add to relevant pools
        if (State.filteredPools.length > 0) {
          const pool = State.filteredPools[Math.floor(Math.random() * Math.min(State.filteredPools.length, 10))];
          this.addTx(pool.id, {
            id: sig || `tx_${Date.now()}`,
            type,
            signature: sig || Math.random().toString(36).substring(2, 14),
            amount: (Math.random() * 8000 + 200).toFixed(2),
            timestamp: Date.now()
          });
        }
      },
      
      addTx(poolId, tx) {
        if (!State.poolTransactions[poolId]) State.poolTransactions[poolId] = [];
        State.poolTransactions[poolId].unshift(tx);
        if (State.poolTransactions[poolId].length > 15) State.poolTransactions[poolId].pop();
        
        // Update UI if this pool is expanded
        if (State.expandedPoolId === poolId || State.expandedOppId === poolId) {
          PoolTxUI.update(poolId);
        }
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // BACKGROUND ANIMATION
    // ═══════════════════════════════════════════════════════════════════════════
    const Background = {
      init() {
        const canvas = document.getElementById('bgCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        const create = () => {
          particles = [];
          const count = Math.floor((canvas.width * canvas.height) / 25000);
          for (let i = 0; i < count; i++) {
            particles.push({
              x: Math.random() * canvas.width,
              y: Math.random() * canvas.height,
              vx: (Math.random() - 0.5) * 0.2,
              vy: (Math.random() - 0.5) * 0.2,
              size: Math.random() + 0.5,
              alpha: Math.random() * 0.2 + 0.05
            });
          }
        };
        const animate = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particles.forEach(p => {
            p.x += p.vx; p.y += p.vy;
            if (p.x < 0) p.x = canvas.width;
            if (p.x > canvas.width) p.x = 0;
            if (p.y < 0) p.y = canvas.height;
            if (p.y > canvas.height) p.y = 0;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(99, 102, 241, ${p.alpha})`;
            ctx.fill();
          });
          requestAnimationFrame(animate);
        };
        
        resize(); create(); animate();
        window.addEventListener('resize', () => { resize(); create(); });
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // LIVE BIN UPDATES
    // ═══════════════════════════════════════════════════════════════════════════
    const LiveUpdates = {
      start() {
        setInterval(() => {
          // Update bin liquidity for all pools
          State.pools.forEach(p => {
            if (p.bins) {
              p.bins.forEach(b => {
                b.liquidity = Math.max(5, b.liquidity + (Math.random() - 0.5) * 2);
              });
            }
          });
          
          // Re-render expanded card's chart
          if (State.expandedPoolId) {
            const pool = State.pools.find(p => p.id === State.expandedPoolId);
            if (pool) {
              const chartEl = document.querySelector(`#pool-${State.expandedPoolId} .chart-section`);
              if (chartEl) chartEl.outerHTML = LiquidityChartUI.render(pool);
            }
          }
          if (State.expandedOppId) {
            const opp = State.opportunities.find(o => o.id === State.expandedOppId);
            if (opp) {
              const chartEl = document.querySelector(`#opp-${State.expandedOppId} .chart-section`);
              if (chartEl) chartEl.outerHTML = LiquidityChartUI.render(opp);
            }
          }
        }, 3000);
      }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // APP CONTROLLER
    // ═══════════════════════════════════════════════════════════════════════════
    const App = {
      async init() {
        Background.init();
        StatusUI.set('loading', 'Initializing...');
        
        // Auto-connect wallet if previously authorized
        await WalletService.autoConnect();
        
        // Fetch data from APIs
        await DataService.fetchJupiter();
        await DataService.fetchPools();
        
        // Render UI
        PoolsGridUI.render();
        OpportunityUI.render();
        AlertsUI.populateDropdown();
        AlertsUI.render();
        AlertsUI.refreshAI();
        
        // Connect WebSocket for live transactions
        WSService.connect();
        
        // Start live updates
        LiveUpdates.start();
        
        // Periodic refresh
        setInterval(() => this.refresh(), CONFIG.REFRESH_INTERVAL);
        
        // Refresh wallet balance periodically
        setInterval(() => { if (State.wallet.connected) WalletService.fetchBalance(); }, 30000);
      },
      
      async refresh() {
        await DataService.fetchPools();
        PoolsGridUI.render();
        OpportunityUI.render();
        AlertsUI.populateDropdown();
      },
      
      applyFilters() {
        DataService.applyFilters();
        DataService.detectOpportunities();
        PoolsGridUI.render();
        OpportunityUI.render();
        AlertsUI.populateDropdown();
        TabsUI.switch('pools');
        StatusUI.set('live', `${State.filteredPools.length} pools`);
      },
      
      toggleJupShield() {
        State.jupshieldEnabled = !State.jupshieldEnabled;
        document.getElementById('jupshieldToggle')?.classList.toggle('active', State.jupshieldEnabled);
        this.applyFilters();
      }
    };

    // Modal close on overlay click
    document.getElementById('walletModal')?.addEventListener('click', e => {
      if (e.target.id === 'walletModal') WalletUI.close();
    });

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => App.init());
  </script>
</body>
</html>
